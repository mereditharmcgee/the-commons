# Plan 20-03: Suggest-Text Sanitization & Ko-fi CSP Compliance

---
wave: 2
depends_on: [20-01]
files_modified:
  - js/suggest-text.js
  - suggest-text.html
  - about.html
autonomous: true
requirements: [FORM-03, RESP-02]
---

## Goal

Apply Utils.sanitizeHtml() to user-submitted content fields in suggest-text.js before sending to the database, and restructure the Ko-fi widget script on about.html for CSP readiness.

## Context

### FORM-03: suggest-text.html sanitization
- suggest-text.js (lines 18-28) gathers form data including `content`, `reason`, `title`, and `author` from user input
- The `content` field is the main free-text field that could contain HTML — it gets stored in the database and later rendered
- `reason` is also free-text but shorter
- `title` and `author` are plain text fields — escapeHtml is sufficient
- Per 20-CONTEXT.md: "sanitization happens silently — strip dangerous HTML without notifying the user"
- Utils.sanitizeHtml() (utils.js line 470) wraps DOMPurify.sanitize() with allowed tags: b, strong, i, em, p, br, a, ul, ol, li
- DOMPurify is loaded via CDN on pages that need it — need to verify suggest-text.html loads it
- If DOMPurify isn't loaded, Utils.sanitizeHtml() falls back to escapeHtml() — safe but more aggressive

### RESP-02: Ko-fi widget CSP compliance
- about.html lines 210-211: Two inline scripts load and initialize the Ko-fi widget
  ```html
  <script type='text/javascript' src='https://storage.ko-fi.com/cdn/widget/Widget_2.js'></script>
  <script type='text/javascript'>kofiwidget2.init('Support The Commons', '#72a4f2', 'I2I11SOBO5');kofiwidget2.draw();</script>
  ```
- The second script is an inline script that violates CSP (needs a hash or to be moved to external file)
- Per 20-CONTEXT.md: "Prepare the Ko-fi script to be CSP-ready but do NOT add a full CSP header/meta tag yet"
- Decision: Move the inline Ko-fi init call to the existing DOMContentLoaded script block at the bottom of about.html, which already has a CSP hash

### DOMPurify availability on suggest-text.html
- Need to check if DOMPurify CDN script is included. If not, the fallback (escapeHtml) still works but we should add it for proper HTML sanitization.

## Tasks

<task id="20-03-01">
<title>Add DOMPurify CDN to suggest-text.html if not present</title>
<steps>
1. Check suggest-text.html for DOMPurify script tag
2. suggest-text.html does NOT currently load DOMPurify. Add before the Supabase script tag at bottom of body:
   ```html
   <script src="https://cdn.jsdelivr.net/npm/dompurify@3.3.1/dist/purify.min.js"
       integrity="sha384-80VlBZnyAwkkqtSfg5NhPyZff6nU4K/qniLBL8Jnm4KDv6jZhLiYtJbhglg/i9ww"
       crossorigin="anonymous"></script>
   ```
   (Same tag used by chat.html, discussion.html, text.html, postcards.html)
</steps>
</task>

<task id="20-03-02">
<title>Apply Utils.sanitizeHtml() to suggest-text.js content fields before submission</title>
<steps>
1. In js/suggest-text.js, after the form data gathering (line 28, after the `data` object is created) and after the manual validation checks, add sanitization of user-submitted content fields:
```js
// Sanitize user-submitted content fields (FORM-03)
data.content = Utils.sanitizeHtml(data.content);
if (data.reason) {
    data.reason = Utils.sanitizeHtml(data.reason);
}
```
2. Place this AFTER the validation checks (so we don't sanitize empty strings that will be rejected) but BEFORE the fetch call
3. Title and author are plain text — they go through escapeHtml treatment at display time, no sanitization needed here
</steps>
</task>

<task id="20-03-03">
<title>Move Ko-fi inline init script into the existing DOMContentLoaded block on about.html</title>
<steps>
1. In about.html, remove the inline init script (line 211):
   ```html
   <script type='text/javascript'>kofiwidget2.init('Support The Commons', '#72a4f2', 'I2I11SOBO5');kofiwidget2.draw();</script>
   ```
2. Move the Ko-fi init call into the existing DOMContentLoaded callback at the bottom of about.html (line 236-238):
   ```js
   document.addEventListener('DOMContentLoaded', () => {
       Auth.init();
       // Ko-fi widget init (moved from inline script for CSP compliance)
       if (typeof kofiwidget2 !== 'undefined') {
           kofiwidget2.init('Support The Commons', '#72a4f2', 'I2I11SOBO5');
           kofiwidget2.draw();
       }
   });
   ```
3. The Ko-fi Widget_2.js external script tag stays (line 210) — external scripts with src are CSP-compatible
4. The DOMContentLoaded script block already has a CSP hash, so it will need a new hash after modification — note this in the verification steps but the CSP hash can be regenerated (this is standard practice per the project's CSP comment pattern)
</steps>
</task>

## Verification

- [ ] suggest-text.js: content and reason fields pass through Utils.sanitizeHtml() before submission
- [ ] suggest-text.js: title and author fields are NOT sanitized (plain text, handled at display time)
- [ ] suggest-text.html: submitting a text with HTML in content field strips dangerous tags silently
- [ ] about.html: no standalone inline `<script>` for Ko-fi init — it's inside the DOMContentLoaded block
- [ ] about.html: Ko-fi widget still renders correctly (the external Widget_2.js loads, then DOMContentLoaded inits it)
- [ ] about.html: typeof check prevents errors if Ko-fi CDN fails to load

## must_haves
- suggest-text.html content and reason fields are sanitized via Utils.sanitizeHtml() before database insertion
- Ko-fi init script is moved out of standalone inline script into the CSP-hashed DOMContentLoaded block
- Ko-fi widget still initializes correctly after restructuring
