---
phase: 13-news-space-threading-ui
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - sql/schema/09-news-pinned-admin-rls.sql
  - news.html
  - js/news.js
  - js/home.js
  - index.html
  - about.html
  - agent-guide.html
  - api.html
  - chat.html
  - claim.html
  - constitution.html
  - contact.html
  - dashboard.html
  - discussion.html
  - discussions.html
  - login.html
  - moment.html
  - moments.html
  - participate.html
  - postcards.html
  - profile.html
  - propose.html
  - reading-room.html
  - reset-password.html
  - roadmap.html
  - search.html
  - submit.html
  - suggest-text.html
  - text.html
  - voices.html
autonomous: true
requirements:
  - NEWS-02
  - NEWS-03
  - NEWS-04

must_haves:
  truths:
    - "A visitor navigating to news.html sees all active moments displayed as editorial news cards with title, description, event date, and discussion count"
    - "Pinned moments appear at the top of the news page before non-pinned items"
    - "News page supports pagination with next/previous controls (10 items per page)"
    - "Every HTML page on the site has a 'News' link in the nav pointing to news.html (no 'Moments' link remains in nav)"
    - "The homepage shows 2-3 recent news items in a dedicated 'In the News' section with a link to news.html"
  artifacts:
    - path: "news.html"
      provides: "News listing page with CSP, nav, editorial layout"
      contains: "news-list"
    - path: "js/news.js"
      provides: "Paginated news card rendering with pinned-first ordering"
      contains: "renderNewsCard"
    - path: "js/home.js"
      provides: "Homepage news section loading"
      contains: "loadRecentNews"
    - path: "sql/schema/09-news-pinned-admin-rls.sql"
      provides: "is_pinned column and admin UPDATE RLS policy on moments"
      contains: "is_pinned"
  key_links:
    - from: "js/news.js"
      to: "CONFIG.api.moments"
      via: "Utils.get() with is_pinned.desc,event_date.desc ordering"
      pattern: "Utils\\.get.*moments"
    - from: "js/home.js"
      to: "CONFIG.api.moments"
      via: "Utils.get() fetching 3 most recent for homepage section"
      pattern: "loadRecentNews"
    - from: "all 26 HTML nav sections"
      to: "news.html"
      via: "nav link replacing moments.html"
      pattern: 'href="news.html"'
---

<objective>
Create the news.html page with editorial card design, add a homepage news section, apply the is_pinned database migration, and replace all "Moments" nav links with "News" across every HTML file on the site.

Purpose: Rebrand moments as news for visitor engagement and discoverability, with a paginated editorial page and homepage presence.
Output: news.html, js/news.js, updated js/home.js, updated index.html, updated nav in 26 HTML files, SQL migration file.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-news-space-threading-ui/13-RESEARCH.md

<interfaces>
<!-- Key existing patterns the executor needs -->

From js/utils.js:
```javascript
Utils.get(endpoint, params)      // Raw fetch with anon key, params as URLSearchParams
Utils.getMoments()               // Fetches is_active=eq.true, order=event_date.desc
Utils.getDiscussionsByMoment(id) // Discussions linked to a moment
Utils.showLoading(el)            // Shows loading spinner in element
Utils.showError(el, msg)         // Shows error message in element
Utils.showEmpty(el, title, msg)  // Shows empty state in element
Utils.escapeHtml(str)            // XSS-safe string escaping
Utils.formatContent(str)         // Content formatting with sanitization
Utils.formatRelativeTime(date)   // Relative timestamp display
```

From js/config.js:
```javascript
CONFIG.api.moments = '/rest/v1/moments'
CONFIG.supabase.url  // Base Supabase URL
CONFIG.supabase.key  // Anon key
```

From js/home.js:
```javascript
// IIFE pattern: (async function() { ... })();
// Loads hero stats, discussions, activity feed on DOMContentLoaded
// Uses await Auth.init() pattern (no, actually uses Auth.init() without await per public page pattern)
```

From moments.html CSP:
```
sha256-AmGvtDAkv/U6sY31qctvMI13eS/PK4mLWMxS0mpjCyU=  // Hash for Auth.init() inline script
```

Current nav pattern in all HTML files:
```html
<a href="moments.html">Moments</a>
```
moment.html has additional occurrences:
- Line 26: nav link with class="active"
- Line 53: breadcrumb "All Moments"
- Line 77: CTA "View All Moments"
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration + news.html + js/news.js</name>
  <files>sql/schema/09-news-pinned-admin-rls.sql, news.html, js/news.js</files>
  <action>
**Step 1: Create SQL migration file** (`sql/schema/09-news-pinned-admin-rls.sql`)

Write the migration SQL containing:
```sql
-- Add is_pinned column to moments table
ALTER TABLE moments ADD COLUMN IF NOT EXISTS is_pinned BOOLEAN NOT NULL DEFAULT false;
CREATE INDEX IF NOT EXISTS idx_moments_is_pinned ON moments(is_pinned) WHERE is_pinned = true;

-- Admin UPDATE policy for moments (follows pattern from sql/admin/admin-rls-setup.sql)
DROP POLICY IF EXISTS "Admins can update moments" ON moments;
CREATE POLICY "Admins can update moments" ON moments
    FOR UPDATE
    USING (EXISTS (SELECT 1 FROM admins WHERE user_id = auth.uid()));
```

Apply this migration to the live Supabase project `dfephsfberzadihcrhal` using the Supabase Management API (POST to `/v1/projects/dfephsfberzadihcrhal/database/query` with the SQL). Read the OAuth token from `C:\Users\mmcge\.claude\.credentials.json` (field: `supabase_oauth_access_token` or similar — check the file structure).

If MCP tools are available, use `apply_migration` instead:
- project_id: `dfephsfberzadihcrhal`
- name: `add_is_pinned_and_moments_admin_rls`
- query: the SQL above

**Step 2: Create news.html**

Clone the HTML structure from `moments.html` as a starting point. Key changes:
- Title: `News — The Commons`
- Meta description: editorial news from The Commons community
- Canonical URL: `https://jointhecommons.space/news.html`
- CSP: copy from moments.html (same inline script hash `sha256-AmGvtDAkv/U6sY31qctvMI13eS/PK4mLWMxS0mpjCyU=`)
- Nav: `<a href="news.html" class="active">News</a>` (replaces the Moments link, add class="active")
- Main content area:
  ```html
  <div class="container">
      <h1>News</h1>
      <p class="section-subtitle">What's happening in and around The Commons</p>
      <div id="news-list"></div>
      <div id="news-pagination" class="news-pagination"></div>
  </div>
  ```
- Script: `<script src="js/news.js"></script>` (not moments.js)
- Keep the same inline `Auth.init()` script as moments.html
- Use all the same external scripts (supabase, config, utils, auth)

**Step 3: Create js/news.js**

Use IIFE pattern matching existing JS files. Structure:

```javascript
(function() {
    'use strict';

    const PAGE_SIZE = 10;
    let currentPage = 0;
    let allMoments = [];

    const newsList = document.getElementById('news-list');
    const paginationEl = document.getElementById('news-pagination');

    // Load all moments client-side (dataset is small ~30 items), paginate in JS
    async function loadNews() {
        Utils.showLoading(newsList);
        try {
            const moments = await Utils.get(CONFIG.api.moments, {
                'is_active': 'eq.true',
                'order': 'is_pinned.desc,event_date.desc'
            });
            allMoments = moments || [];

            // Fetch discussion counts in parallel
            const countPromises = allMoments.map(m =>
                Utils.getDiscussionsByMoment(m.id).then(d => ({ id: m.id, count: d ? d.length : 0 })).catch(() => ({ id: m.id, count: 0 }))
            );
            const counts = await Promise.all(countPromises);
            const countMap = {};
            counts.forEach(c => { countMap[c.id] = c.count; });
            allMoments.forEach(m => { m._discussionCount = countMap[m.id] || 0; });

            renderPage();
        } catch (err) {
            Utils.showError(newsList, 'Failed to load news');
        }
    }

    function renderPage() {
        const start = currentPage * PAGE_SIZE;
        const pageItems = allMoments.slice(start, start + PAGE_SIZE);

        if (pageItems.length === 0 && currentPage === 0) {
            Utils.showEmpty(newsList, 'No news yet', 'Check back soon for updates.');
            paginationEl.innerHTML = '';
            return;
        }

        newsList.innerHTML = pageItems.map(m => renderNewsCard(m)).join('');
        renderPagination();
    }

    function renderNewsCard(moment) {
        // Editorial news card design — not a plain moment-card
        // Pinned items get a visual indicator
        const isPinned = moment.is_pinned;
        const dateStr = moment.event_date
            ? new Date(moment.event_date + 'T00:00:00').toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })
            : '';
        const subtitle = moment.subtitle ? Utils.escapeHtml(moment.subtitle) : '';
        const description = moment.description ? Utils.escapeHtml(moment.description) : '';
        // Truncate description for card preview (first 200 chars)
        const excerpt = description.length > 200 ? description.substring(0, 200) + '...' : description;
        const discussionCount = moment._discussionCount || 0;
        const discussionLabel = discussionCount === 1 ? '1 discussion' : `${discussionCount} discussions`;

        return `
            <article class="news-card${isPinned ? ' news-card--pinned' : ''}">
                ${isPinned ? '<span class="news-card__pin-badge">Pinned</span>' : ''}
                <div class="news-card__dateline">${dateStr}</div>
                <h2 class="news-card__headline">
                    <a href="moment.html?id=${moment.id}">${Utils.escapeHtml(moment.title)}</a>
                </h2>
                ${subtitle ? `<p class="news-card__deck">${subtitle}</p>` : ''}
                <p class="news-card__excerpt">${excerpt}</p>
                <div class="news-card__meta">
                    <span class="news-card__discussions">${discussionLabel}</span>
                    <a href="moment.html?id=${moment.id}" class="news-card__readmore">Read more &rarr;</a>
                </div>
            </article>
        `;
    }

    function renderPagination() {
        const totalPages = Math.ceil(allMoments.length / PAGE_SIZE);
        if (totalPages <= 1) {
            paginationEl.innerHTML = '';
            return;
        }
        // Prev / page indicator / Next
        const prevDisabled = currentPage === 0 ? ' disabled' : '';
        const nextDisabled = currentPage >= totalPages - 1 ? ' disabled' : '';
        paginationEl.innerHTML = `
            <button class="news-pagination__btn" onclick="newsPagePrev()"${prevDisabled}>&laquo; Previous</button>
            <span class="news-pagination__info">Page ${currentPage + 1} of ${totalPages}</span>
            <button class="news-pagination__btn" onclick="newsPageNext()"${nextDisabled}>&raquo; Next</button>
        `;
    }

    // Global functions for pagination buttons
    window.newsPagePrev = function() {
        if (currentPage > 0) { currentPage--; renderPage(); window.scrollTo(0, 0); }
    };
    window.newsPageNext = function() {
        const totalPages = Math.ceil(allMoments.length / PAGE_SIZE);
        if (currentPage < totalPages - 1) { currentPage++; renderPage(); window.scrollTo(0, 0); }
    };

    // Initialize
    Auth.init();
    loadNews();
})();
```

**CSS for news cards:** Add to `css/style.css` the following classes. Place them near the existing `.moment-card` styles:

```css
/* News Cards (editorial design for news.html) */
.news-card {
    padding: var(--space-xl) 0;
    border-bottom: 1px solid var(--border-light);
}
.news-card:first-child { padding-top: 0; }
.news-card--pinned {
    background: var(--bg-raised);
    padding: var(--space-xl);
    border-radius: 8px;
    border-bottom: none;
    margin-bottom: var(--space-lg);
    border-left: 3px solid var(--accent-gold);
}
.news-card__pin-badge {
    display: inline-block;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--accent-gold);
    margin-bottom: var(--space-xs);
}
.news-card__dateline {
    font-size: 0.8125rem;
    color: var(--text-muted);
    font-family: var(--font-body);
    margin-bottom: var(--space-xs);
}
.news-card__headline {
    font-family: var(--font-heading);
    font-size: 1.5rem;
    line-height: 1.3;
    margin-bottom: var(--space-sm);
}
.news-card__headline a {
    color: var(--text-primary);
    text-decoration: none;
    transition: color var(--transition-fast);
}
.news-card__headline a:hover { color: var(--accent-gold); }
.news-card__deck {
    font-size: 1.0625rem;
    color: var(--text-secondary);
    line-height: 1.5;
    margin-bottom: var(--space-sm);
    font-style: italic;
}
.news-card__excerpt {
    color: var(--text-secondary);
    line-height: 1.6;
    margin-bottom: var(--space-md);
}
.news-card__meta {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    font-size: 0.875rem;
}
.news-card__discussions { color: var(--text-muted); }
.news-card__readmore {
    color: var(--accent-gold);
    text-decoration: none;
    font-weight: 500;
}
.news-card__readmore:hover { text-decoration: underline; }

/* News pagination */
.news-pagination {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-md);
    padding: var(--space-xl) 0;
}
.news-pagination__btn {
    padding: var(--space-xs) var(--space-md);
    border: 1px solid var(--border-medium);
    background: transparent;
    color: var(--text-primary);
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.875rem;
}
.news-pagination__btn:hover:not([disabled]) {
    background: var(--bg-raised);
    border-color: var(--accent-gold);
}
.news-pagination__btn[disabled] {
    opacity: 0.4;
    cursor: not-allowed;
}
.news-pagination__info {
    font-size: 0.875rem;
    color: var(--text-muted);
}
```

Also add a compact news card style for the homepage:
```css
/* Homepage news feed (compact cards) */
.news-feed { display: flex; flex-direction: column; gap: var(--space-md); }
.news-feed-card {
    padding: var(--space-md);
    border-left: 2px solid var(--accent-gold);
    transition: background var(--transition-fast);
}
.news-feed-card:hover { background: var(--bg-raised); }
.news-feed-card__date {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-bottom: 2px;
}
.news-feed-card__title {
    font-family: var(--font-heading);
    font-size: 1.0625rem;
    margin-bottom: 4px;
}
.news-feed-card__title a {
    color: var(--text-primary);
    text-decoration: none;
}
.news-feed-card__title a:hover { color: var(--accent-gold); }
.news-feed-card__snippet {
    font-size: 0.875rem;
    color: var(--text-secondary);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
```

  </action>
  <verify>
    <automated>
echo "--- Verify DB migration file exists ---" && test -f sql/schema/09-news-pinned-admin-rls.sql && echo "PASS: migration file" || echo "FAIL: migration file missing"
echo "--- Verify news.html exists ---" && test -f news.html && echo "PASS: news.html" || echo "FAIL: news.html missing"
echo "--- Verify js/news.js exists ---" && test -f js/news.js && echo "PASS: js/news.js" || echo "FAIL: js/news.js missing"
echo "--- Verify news.html references news.js ---" && grep -q 'news.js' news.html && echo "PASS: news.html refs news.js" || echo "FAIL: news.html missing news.js ref"
echo "--- Verify CSS has news-card class ---" && grep -q 'news-card' css/style.css && echo "PASS: news-card CSS" || echo "FAIL: news-card CSS missing"
echo "--- Verify news.js has renderNewsCard ---" && grep -q 'renderNewsCard' js/news.js && echo "PASS: renderNewsCard" || echo "FAIL: renderNewsCard missing"
    </automated>
  </verify>
  <done>
    - news.html loads and displays active moments as editorial news cards
    - Cards show title, description/excerpt, event date, and discussion count (NEWS-03)
    - Pinned items appear at top with visual treatment
    - Pagination renders when items exceed 10 (NEWS-02)
    - is_pinned column exists on moments table in live DB
    - Admin UPDATE RLS policy exists for moments table
  </done>
</task>

<task type="auto">
  <name>Task 2: Homepage news section + nav update across all HTML files</name>
  <files>js/home.js, index.html, about.html, agent-guide.html, api.html, chat.html, claim.html, constitution.html, contact.html, dashboard.html, discussion.html, discussions.html, login.html, moment.html, moments.html, participate.html, postcards.html, profile.html, propose.html, reading-room.html, reset-password.html, roadmap.html, search.html, submit.html, suggest-text.html, text.html, voices.html</files>
  <action>
**Step 1: Add homepage news section to index.html**

In `index.html`, add a new section between the "What's New" section (ends ~line 100) and the "Latest Activity" section (starts ~line 130). Insert:

```html
<section class="section">
    <h2 class="section-title">In the News</h2>
    <div id="news-feed" class="news-feed">
        <p class="loading">Loading news...</p>
    </div>
    <div class="mt-lg text-center">
        <a href="news.html" class="btn btn--secondary">All News &rarr;</a>
    </div>
</section>
```

**Step 2: Add loadRecentNews() to js/home.js**

Add a new function `loadRecentNews()` inside the IIFE. This fetches the 3 most recent active moments (pinned first) and renders compact news feed cards:

```javascript
async function loadRecentNews() {
    const newsFeed = document.getElementById('news-feed');
    if (!newsFeed) return;

    try {
        const moments = await Utils.get(CONFIG.api.moments, {
            'is_active': 'eq.true',
            'order': 'is_pinned.desc,event_date.desc',
            'limit': '3'
        });

        if (!moments || moments.length === 0) {
            newsFeed.innerHTML = '<p class="text-muted">No news yet.</p>';
            return;
        }

        newsFeed.innerHTML = moments.map(m => {
            const dateStr = m.event_date
                ? new Date(m.event_date + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                : '';
            const snippet = m.description
                ? Utils.escapeHtml(m.description.substring(0, 120)) + (m.description.length > 120 ? '...' : '')
                : '';
            return `
                <div class="news-feed-card">
                    <div class="news-feed-card__date">${dateStr}</div>
                    <div class="news-feed-card__title"><a href="moment.html?id=${m.id}">${Utils.escapeHtml(m.title)}</a></div>
                    ${snippet ? `<div class="news-feed-card__snippet">${snippet}</div>` : ''}
                </div>
            `;
        }).join('');
    } catch (err) {
        const newsFeed2 = document.getElementById('news-feed');
        if (newsFeed2) newsFeed2.innerHTML = '';
    }
}
```

Call `loadRecentNews()` alongside the other load calls in the IIFE (after `loadDiscussions()` and `loadActivityFeed()`). It should fire non-blocking (no await needed, just call it).

**Step 3: Nav update across all 26 HTML files**

In every HTML file that has `<a href="moments.html">Moments</a>` in the nav, replace it with `<a href="news.html">News</a>`.

The 26 files to update (nav link only):
about.html, agent-guide.html, api.html, chat.html, claim.html, constitution.html, contact.html, dashboard.html, discussion.html, discussions.html, index.html, login.html, participate.html, postcards.html, profile.html, propose.html, reading-room.html, reset-password.html, roadmap.html, search.html, submit.html, suggest-text.html, text.html, voices.html

Special files needing additional changes:
- **moments.html**: Replace nav `<a href="moments.html" class="active">Moments</a>` with `<a href="news.html">News</a>` (remove active class since we're on moments.html, not news.html). Also add a redirect banner at the top of the content: `<div class="notice">This page has moved. <a href="news.html">Visit News &rarr;</a></div>` (optional but recommended).
- **moment.html** (3 occurrences):
  - Line 26 nav: `<a href="moments.html" class="active">Moments</a>` → `<a href="news.html" class="active">News</a>` (keep active class — moment detail is part of News section)
  - Line 53 breadcrumb: `<a href="moments.html">← All Moments</a>` → `<a href="news.html">&larr; All News</a>`
  - Line 77 CTA: `<a href="moments.html" class="btn btn--secondary">View All Moments</a>` → `<a href="news.html" class="btn btn--secondary">View All News</a>`

**Verification approach:** After all edits, run:
1. `grep -rl 'href="moments.html"' *.html` — should return ONLY moments.html (if it still links to itself) or be empty
2. `grep -c 'href="news.html"' *.html | grep -v ':0$' | wc -l` — should be 27+ (26 nav links + news.html itself + moment.html extras)

Note: Do NOT modify admin.html — it has no site nav. Do NOT change any CSP hashes for nav-only edits (no inline script changes).
  </action>
  <verify>
    <automated>
cd "C:/Users/mmcge/the-commons" && echo "--- Checking nav remnants ---" && NAV_OLD=$(grep -rl 'href="moments.html"' *.html 2>/dev/null | grep -v moments.html | wc -l) && echo "Files still linking to moments.html in nav (should be 0): $NAV_OLD" && echo "--- Checking new nav links ---" && NAV_NEW=$(grep -c 'href="news.html"' *.html 2>/dev/null | grep -v ':0$' | wc -l) && echo "Files with news.html link (should be 27+): $NAV_NEW" && echo "--- Homepage news section ---" && grep -q 'news-feed' index.html && echo "PASS: news-feed in index.html" || echo "FAIL" && echo "--- home.js loadRecentNews ---" && grep -q 'loadRecentNews' js/home.js && echo "PASS: loadRecentNews in home.js" || echo "FAIL"
    </automated>
  </verify>
  <done>
    - All 26 HTML files have nav updated from "Moments" to "News" pointing at news.html (NEWS-04)
    - moment.html breadcrumb and CTA updated to reference news.html
    - moments.html no longer appears in any nav (deep links still work)
    - Homepage shows 2-3 recent news items in "In the News" section
    - loadRecentNews() fires on homepage load, renders compact news cards
    - No CSP hashes broken (only HTML text and external JS changes)
  </done>
</task>

</tasks>

<verification>
1. Open news.html in browser — page loads with editorial news cards showing title, date, description excerpt, discussion count
2. Pinned items (if any) appear at top with gold left border and "Pinned" badge
3. Navigate from any page — "News" link appears in nav, no "Moments" link exists
4. Homepage "In the News" section shows 2-3 recent items with compact card design
5. moment.html?id=X detail pages still work with correct breadcrumb pointing to news.html
6. moments.html still accessible but no longer in nav (backward compatibility)
7. `grep -rl 'href="moments.html"' *.html` returns only moments.html itself (for its own potential self-reference) or nothing
</verification>

<success_criteria>
- news.html renders all active moments as editorial news cards with pagination (NEWS-02)
- Each card shows title, description, event_date, discussion count (NEWS-03)
- Every HTML page nav links to news.html (NEWS-04)
- Homepage has a "In the News" section with 2-3 recent items
- is_pinned column live on moments table; pinned items sort first
- Admin UPDATE RLS policy on moments table is live
</success_criteria>

<output>
After completion, create `.planning/phases/13-news-space-threading-ui/13-01-SUMMARY.md`
</output>
