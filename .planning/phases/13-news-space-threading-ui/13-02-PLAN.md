---
phase: 13-news-space-threading-ui
plan: "02"
type: execute
wave: 1
depends_on: []
files_modified:
  - admin.html
  - js/admin.js
  - js/discussion.js
  - css/style.css
autonomous: true
requirements:
  - NEWS-01
  - THRD-01
  - THRD-02
  - THRD-03
  - THRD-04
  - THRD-05

must_haves:
  truths:
    - "An admin can pin/unpin a moment from the admin dashboard News tab and the pinned state persists"
    - "An admin can hide/show a moment from the admin dashboard News tab and the visibility change persists"
    - "The admin dashboard News tab shows all moments with title, date, status badges (Active/Hidden, Pinned/Unpinned), and action buttons"
    - "Reply posts in discussion threads show 'replying to [Name]' with first ~100 chars of the parent post content"
    - "Thread depth indicators (left borders), indentation cap at depth 4, reply buttons, and collapsible sub-threads all remain working (pre-existing THRD-01/02/03/05)"
  artifacts:
    - path: "admin.html"
      provides: "News/Moments tab button and panel in admin dashboard"
      contains: "panel-moments"
    - path: "js/admin.js"
      provides: "loadMoments(), renderMoments() functions with pin/unpin and hide/show"
      contains: "loadMoments"
    - path: "js/discussion.js"
      provides: "Parent post preview in renderPost() for reply posts"
      contains: "post__parent-preview"
    - path: "css/style.css"
      provides: "CSS classes for parent preview display"
      contains: "post__parent-preview"
  key_links:
    - from: "js/admin.js"
      to: "moments table via updateRecord()"
      via: "updateRecord('moments', id, { is_pinned: ... }) and updateRecord('moments', id, { is_active: ... })"
      pattern: "updateRecord.*moments"
    - from: "js/discussion.js"
      to: "currentPosts array"
      via: "currentPosts.find(p => p.id === post.parent_id) for parent preview lookup"
      pattern: "currentPosts\\.find"
---

<objective>
Add a News management tab to the admin dashboard for pin/unpin and hide/show controls, and implement THRD-04 reply parent preview in discussion threads.

Purpose: Give admins control over news curation (pinning featured items, hiding outdated ones), and give discussion readers context about what each reply is responding to.
Output: Updated admin.html + admin.js with News tab, updated discussion.js with parent preview, updated style.css with preview classes.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-news-space-threading-ui/13-RESEARCH.md
@.planning/phases/13-news-space-threading-ui/13-01-SUMMARY.md

<interfaces>
<!-- Key existing patterns the executor needs -->

From js/admin.js — tab/panel pattern:
```javascript
// State: let posts = []; let marginalia = []; ...
// Add: let moments = [];

// loadAllData() calls all load functions:
async function loadAllData() {
    loadPosts();
    loadMarginalia();
    // ... add loadMoments() here
}

// Load pattern example (loadPosts):
async function loadPosts() {
    const { data, error } = await getClient().from('posts').select('*').order('created_at', { ascending: false });
    if (!error) { posts = data || []; renderPosts(); updateTabCount('posts', posts.length); }
}

// Update pattern:
async function updateRecord(table, id, updates) {
    const { data, error } = await getClient().from(table).update(updates).eq('id', id).select();
    if (error) throw error;
    return data;
}

// updateTabCount('tabname', count) — updates the tab count badge
```

From admin.html — tab button pattern:
```html
<button class="admin-tab" data-tab="prompts">
    Prompts <span class="admin-tab__count" id="tab-count-prompts">0</span>
</button>
```

From admin.html — panel pattern:
```html
<div id="panel-prompts" class="admin-panel">
    <button class="admin-refresh" onclick="loadPrompts()">Refresh</button>
    <div id="prompts-list"></div>
</div>
```

From js/discussion.js — renderPost() structure (lines 220-285):
```javascript
function renderPost(post, depth = 0, replyMap = {}) {
    const isReply = depth > 0;
    // ... model info, name display, depth class ...
    return `
        <article class="post ${depthClass}" data-post-id="${post.id}">
            <div class="post__header">...</div>
            <!-- INSERT PARENT PREVIEW HERE (between header and content) -->
            <div class="post__content">...</div>
            ...
            ${renderReactionBar(post.id)}
            <div class="post__footer">...</div>
        </article>
    `;
}
```

From js/discussion.js — currentPosts:
```javascript
let currentPosts = []; // All posts for the discussion, loaded in loadDiscussion()
// Parent lookup: currentPosts.find(p => p.id === post.parent_id)
// Posts have: .id, .parent_id, .ai_name, .model, .content, .facilitator_id
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin dashboard News tab with pin/unpin and hide/show</name>
  <files>admin.html, js/admin.js</files>
  <action>
**Step 1: Add tab button to admin.html**

In `admin.html`, find the `<div class="admin-tabs">` section (around line 843). Add a new tab button AFTER the "Prompts" button (last current tab, around line 866):

```html
<button class="admin-tab" data-tab="moments">
    News <span class="admin-tab__count" id="tab-count-moments">0</span>
</button>
```

**Step 2: Add panel to admin.html**

After the last panel div (`panel-prompts`, which ends around line 980), add:

```html
<div id="panel-moments" class="admin-panel">
    <button class="admin-refresh" onclick="loadMoments()">Refresh</button>
    <div id="moments-list"></div>
</div>
```

**Step 3: Add moments state and functions to admin.js**

In the STATE section at the top of the IIFE (around line 20-28), add:
```javascript
let moments = [];
```

In `loadAllData()` (around line 153), add `loadMoments();` alongside the other load calls.

Add the following functions to admin.js:

```javascript
async function loadMoments() {
    try {
        const { data, error } = await getClient()
            .from('moments')
            .select('*')
            .order('event_date', { ascending: false });

        if (error) throw error;
        moments = data || [];
        renderMoments();
        updateTabCount('moments', moments.length);
    } catch (error) {
        console.error('Error loading moments:', error);
        document.getElementById('moments-list').innerHTML =
            '<p class="admin-error">Failed to load moments</p>';
    }
}

function renderMoments() {
    const container = document.getElementById('moments-list');
    if (!moments.length) {
        container.innerHTML = '<p class="admin-empty">No moments found</p>';
        return;
    }

    container.innerHTML = moments.map(m => {
        const dateStr = m.event_date
            ? new Date(m.event_date + 'T00:00:00').toLocaleDateString()
            : 'No date';
        const activeClass = m.is_active ? 'status-badge--active' : 'status-badge--hidden';
        const activeLabel = m.is_active ? 'Active' : 'Hidden';
        const pinnedClass = m.is_pinned ? 'status-badge--pinned' : '';
        const pinnedLabel = m.is_pinned ? 'Pinned' : '';

        return `
            <div class="admin-item">
                <div class="admin-item__header">
                    <div>
                        <strong>${Utils.escapeHtml(m.title)}</strong>
                        ${m.subtitle ? `<span class="admin-item__subtitle"> — ${Utils.escapeHtml(m.subtitle)}</span>` : ''}
                    </div>
                    <div class="admin-item__badges">
                        <span class="status-badge ${activeClass}">${activeLabel}</span>
                        ${pinnedLabel ? `<span class="status-badge ${pinnedClass}">Pinned</span>` : ''}
                    </div>
                </div>
                <div class="admin-item__meta">
                    <span>${dateStr}</span>
                    <a href="moment.html?id=${m.id}" target="_blank">View &rarr;</a>
                </div>
                <div class="admin-item__actions">
                    <button onclick="toggleMomentPin('${m.id}', ${!m.is_pinned})" class="admin-btn admin-btn--small">
                        ${m.is_pinned ? 'Unpin' : 'Pin'}
                    </button>
                    <button onclick="toggleMomentActive('${m.id}', ${!m.is_active})" class="admin-btn admin-btn--small ${m.is_active ? 'admin-btn--danger' : 'admin-btn--success'}">
                        ${m.is_active ? 'Hide' : 'Show'}
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

async function toggleMomentPin(id, pinned) {
    try {
        await updateRecord('moments', id, { is_pinned: pinned });
        await loadMoments(); // Refresh list
    } catch (error) {
        alert('Failed to update pin status: ' + error.message);
    }
}

async function toggleMomentActive(id, active) {
    try {
        await updateRecord('moments', id, { is_active: active });
        await loadMoments(); // Refresh list
    } catch (error) {
        alert('Failed to update visibility: ' + error.message);
    }
}
```

**Step 4: Expose functions globally**

The admin.js uses an IIFE. The `onclick` handlers in the rendered HTML call global functions. Find where other admin functions are exposed globally (look for `window.` assignments or check if they're already global). If the IIFE pattern prevents global access, add at the end of the IIFE:

```javascript
window.loadMoments = loadMoments;
window.toggleMomentPin = toggleMomentPin;
window.toggleMomentActive = toggleMomentActive;
```

Check how existing functions like `loadPosts`, `loadContacts` etc. are exposed — follow the same pattern.

**CSS for admin moments (add to style.css if not already present):**

The admin panel uses existing `.admin-item`, `.admin-btn`, `.status-badge` classes. If `.status-badge--pinned` doesn't exist, add:

```css
.status-badge--pinned {
    background: var(--accent-gold);
    color: var(--bg-deep);
}
```

Also add if missing:
```css
.admin-item__subtitle { color: var(--text-muted); font-size: 0.875rem; }
.admin-item__meta { display: flex; gap: var(--space-md); font-size: 0.8125rem; color: var(--text-muted); margin-top: var(--space-xs); }
.admin-item__meta a { color: var(--accent-gold); text-decoration: none; }
.admin-item__actions { display: flex; gap: var(--space-sm); margin-top: var(--space-sm); }
.admin-btn--success { border-color: #4ade80; color: #4ade80; }
.admin-btn--success:hover { background: rgba(74, 222, 128, 0.1); }
```

Check what admin CSS classes already exist before adding duplicates.
  </action>
  <verify>
    <automated>
cd "C:/Users/mmcge/the-commons" && echo "--- admin.html has moments tab ---" && grep -q 'data-tab="moments"' admin.html && echo "PASS" || echo "FAIL" && echo "--- admin.html has moments panel ---" && grep -q 'panel-moments' admin.html && echo "PASS" || echo "FAIL" && echo "--- admin.js has loadMoments ---" && grep -q 'loadMoments' js/admin.js && echo "PASS" || echo "FAIL" && echo "--- admin.js has renderMoments ---" && grep -q 'renderMoments' js/admin.js && echo "PASS" || echo "FAIL" && echo "--- admin.js has toggleMomentPin ---" && grep -q 'toggleMomentPin' js/admin.js && echo "PASS" || echo "FAIL"
    </automated>
  </verify>
  <done>
    - Admin dashboard has a "News" tab showing all moments with title, date, status badges
    - Pin/Unpin button toggles is_pinned on the moments record (NEWS-01)
    - Hide/Show button toggles is_active on the moments record
    - Tab count badge shows total moments count
    - Functions are globally accessible for onclick handlers
  </done>
</task>

<task type="auto">
  <name>Task 2: THRD-04 reply parent preview in discussion threads</name>
  <files>js/discussion.js, css/style.css</files>
  <action>
**Step 1: Add parent preview CSS to css/style.css**

Add these classes near the existing threading styles (`.post--reply`, `.post--depth-*`, `.thread-collapse`):

```css
/* Reply parent preview (THRD-04) */
.post__parent-preview {
    margin-bottom: var(--space-sm);
    padding: var(--space-xs) var(--space-md);
    background: var(--bg-deep);
    border-left: 2px solid var(--border-medium);
    border-radius: 0 4px 4px 0;
    font-size: 0.8125rem;
    cursor: pointer;
    transition: background var(--transition-fast);
}
.post__parent-preview:hover {
    background: var(--bg-raised);
}
.post__parent-label {
    color: var(--accent-gold);
    font-weight: 500;
    display: block;
    margin-bottom: 2px;
}
.post__parent-snippet {
    color: var(--text-muted);
    display: block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
}
```

**Step 2: Add parent preview logic to renderPost() in js/discussion.js**

In the `renderPost()` function (starts at line 220), add parent preview generation AFTER the `depthClass` calculation (around line 237) and BEFORE the return template:

```javascript
// Parent preview for replies (THRD-04)
let parentPreviewHtml = '';
if (isReply && post.parent_id) {
    const parentPost = currentPosts.find(p => p.id === post.parent_id);
    if (parentPost) {
        const parentName = parentPost.ai_name || parentPost.model || 'unknown';
        const parentContent = parentPost.content || '';
        const parentSnippet = parentContent.substring(0, 100) + (parentContent.length > 100 ? '...' : '');
        parentPreviewHtml = `
            <div class="post__parent-preview" onclick="scrollToPost('${post.parent_id}')" title="Click to scroll to parent post">
                <span class="post__parent-label">replying to ${Utils.escapeHtml(parentName)}</span>
                <span class="post__parent-snippet">${Utils.escapeHtml(parentSnippet)}</span>
            </div>
        `;
    }
}
```

Then insert `${parentPreviewHtml}` into the returned HTML template, between `</div>` (closing `.post__header`) and `<div class="post__content">`:

```javascript
return `
    <article class="post ${depthClass}" data-post-id="${post.id}">
        <div class="post__header">
            ...existing header content...
        </div>
        ${parentPreviewHtml}
        <div class="post__content">
            ...existing content...
        </div>
        ...rest of post...
    </article>
`;
```

**Step 3: Add scrollToPost() helper**

Add a helper function to discussion.js (inside the IIFE, near the other helper functions like `replyTo()`):

```javascript
function scrollToPost(postId) {
    const el = document.querySelector(`[data-post-id="${postId}"]`);
    if (el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        // Brief highlight
        el.style.transition = 'background 0.3s ease';
        el.style.background = 'var(--bg-raised)';
        setTimeout(() => { el.style.background = ''; }, 1500);
    }
}
```

Expose it globally (same pattern as `replyTo`, `editPost`, `deletePost`):
```javascript
window.scrollToPost = scrollToPost;
```

Check how `replyTo` is exposed — if it's already `window.replyTo = replyTo;` at the bottom of the IIFE, add `window.scrollToPost = scrollToPost;` next to it.

**Design decisions (Claude's discretion per CONTEXT.md):**
- Show parent preview on ALL replies (depth > 0), not just depth 2+. Even at depth 1, the attribution adds context.
- Click behavior: clicking the preview scrolls to the parent post with a brief highlight.
- Style: inline quote block (not collapsible) with subtle background and gold label.
  </action>
  <verify>
    <automated>
cd "C:/Users/mmcge/the-commons" && echo "--- CSS has parent preview classes ---" && grep -q 'post__parent-preview' css/style.css && echo "PASS" || echo "FAIL" && echo "--- discussion.js has parent preview logic ---" && grep -q 'post__parent-preview' js/discussion.js && echo "PASS" || echo "FAIL" && echo "--- discussion.js has parentPost lookup ---" && grep -q 'parentPost' js/discussion.js && echo "PASS" || echo "FAIL" && echo "--- discussion.js has scrollToPost ---" && grep -q 'scrollToPost' js/discussion.js && echo "PASS" || echo "FAIL"
    </automated>
  </verify>
  <done>
    - Reply posts show "replying to [Name]" with first ~100 chars of parent content (THRD-04)
    - Parent preview appears between post header and post content
    - Clicking the preview scrolls to the parent post with brief highlight
    - Parent preview is guarded: if parent post is hidden/missing, no preview renders
    - All existing threading behavior preserved: left borders (THRD-01), depth cap (THRD-02), reply buttons (THRD-03), collapsible sub-threads (THRD-05)
  </done>
</task>

</tasks>

<verification>
1. Admin dashboard: Navigate to admin.html, verify "News" tab appears. Click it. Verify all moments are listed with title, date, status badges.
2. Admin pin: Click "Pin" on a moment, verify badge changes to "Pinned" and the button changes to "Unpin". Refresh — pin state persists.
3. Admin hide: Click "Hide" on a moment, verify badge changes to "Hidden". Refresh — hidden state persists.
4. Discussion thread: Navigate to any discussion with replies. Reply posts show "replying to [Name]" with parent content snippet.
5. Click the parent preview — page scrolls to the parent post with a brief highlight.
6. Existing threading features: left borders on replies, indentation capped at 4, Reply button works, sub-threads collapse at depth 2+.
</verification>

<success_criteria>
- Admin can pin/unpin moments from the dashboard (NEWS-01 — admin curation control)
- Admin can hide/show moments from the dashboard
- Reply posts in discussion show parent preview with name and ~100 char snippet (THRD-04)
- Clicking parent preview scrolls to parent post
- Pre-existing THRD-01, THRD-02, THRD-03, THRD-05 still work (no regression)
</success_criteria>

<output>
After completion, create `.planning/phases/13-news-space-threading-ui/13-02-SUMMARY.md`
</output>
