# Plan 16-01: Pinned Post Display + Room Header Styling

---
wave: 1
depends_on: []
files_modified:
  - js/config.js
  - css/style.css
  - profile.html
  - js/profile.js
  - js/dashboard.js
autonomous: true
requirements:
  - HOME-01
  - HOME-02
  - HOME-03
  - HOME-08
---

## Goal

Facilitators can pin one post to their AI identity's profile and profiles display a model-colored header bar that gives each voice page a distinct "room" feel. The pinned post appears at the top of the Posts tab with its own heading and visual treatment.

## must_haves

- Facilitator can pin a post from the profile page (when viewing their own identity)
- Pinned post appears at the top of the Posts tab with "Pinned Post" heading and visually distinct background
- Facilitator can unpin the pinned post from profile page or dashboard
- Profile pages show a model-colored header bar (border-top or gradient) using the identity's model color
- Pin/unpin state persists across page reloads (uses ai_identities.pinned_post_id column)
- When no post is pinned, the pinned section is hidden

## Context

**Schema already exists (Phase 11):**
- `ai_identities.pinned_post_id` â€” nullable UUID, ON DELETE SET NULL, single-column enforces one pin per identity
- RLS: `Facilitators can update own ai_identities` policy covers pinned_post_id updates
- `Auth.updateIdentity(id, { pinned_post_id })` works directly

**Critical note:** `ai_identity_stats` view (used by Auth.getIdentity/getAllIdentities) does NOT include `pinned_post_id` â€” it lists columns explicitly. Must fetch pinned_post_id directly from `ai_identities` table via a separate query.

**Existing patterns:**
- `isOwner` check pattern from Phase 15: `await authReady; const myIdentities = Auth.isLoggedIn() ? await Auth.getMyIdentities() : []; const isOwner = myIdentities.some(i => i.id === identityId);`
- `Auth.updateIdentity(identityId, updates)` for persisting changes
- Non-blocking fire-and-forget IIFEs for auxiliary data loading

## Tasks

<task id="01-1">
<title>Add voice_guestbook API endpoint to config.js</title>
<details>
Add `voice_guestbook: '/rest/v1/voice_guestbook'` to the `CONFIG.api` object in `js/config.js`, after the `post_reaction_counts` entry.

This endpoint is needed by Plan 02 but adding it in Plan 01 avoids duplicate config changes.
</details>
</task>

<task id="01-2">
<title>Add room header and pinned post CSS to style.css</title>
<details>
Add the following CSS classes to `css/style.css`:

**Room header treatment (HOME-08):**
Create `.profile-header--{model}` classes for all 7 models plus `other` fallback. Each applies a `border-top: 4px solid var(--{model}-color)` to the `.profile-header` element. Models: claude, gpt, gemini, grok, llama, mistral, deepseek. The `other` variant uses `var(--accent-gold)`.

**Pinned post section:**
```css
.pinned-post-section {
    background: var(--bg-raised);
    border-left: 3px solid var(--accent-gold);
    border-radius: 8px;
    padding: var(--space-lg);
    margin-bottom: var(--space-xl);
}
.pinned-post-section__label {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--accent-gold);
    margin-bottom: var(--space-sm);
}
```

**Pin/unpin button styles:**
```css
.pin-btn {
    background: transparent;
    border: 1px solid var(--border-subtle);
    color: var(--text-muted);
    cursor: pointer;
    font-size: 0.8125rem;
    padding: 0.25em 0.75em;
    border-radius: 4px;
    transition: color 0.2s, border-color 0.2s;
}
.pin-btn:hover {
    color: var(--accent-gold);
    border-color: var(--accent-gold);
}
.unpin-btn {
    background: transparent;
    border: 1px solid var(--accent-gold);
    color: var(--accent-gold);
    cursor: pointer;
    font-size: 0.8125rem;
    padding: 0.25em 0.75em;
    border-radius: 4px;
}
.unpin-btn:hover {
    background: var(--accent-gold);
    color: var(--bg-deep);
}
```

Verify that the CSS custom properties for model colors (`--claude-color`, `--gpt-color`, etc.) already exist in `:root`. They should from prior phases. If any are missing, add them.
</details>
</task>

<task id="01-3">
<title>Add pinned post section HTML to profile.html</title>
<details>
In `profile.html`, inside the `#tab-posts` panel, add a pinned post container div ABOVE the existing `#posts-list` div:

```html
<div id="pinned-post-section" class="pinned-post-section" style="display: none;">
    <div class="pinned-post-section__label">Pinned Post</div>
    <div id="pinned-post-content"></div>
</div>
```

Place this between the opening `<div id="tab-posts"...>` tag and the `<div id="posts-list"...>` div. This keeps the pinned post inside the Posts tab (consistent with success criteria "appears at the top of the profile's Posts section").

No CSP hash updates needed â€” no new inline scripts.
</details>
</task>

<task id="01-4">
<title>Implement pinned post display and room header in profile.js</title>
<details>
Modify `js/profile.js` to add pinned post functionality and room header styling:

**a. Room header styling** â€” After `modelClass` is determined (around line 85), add:
```js
const profileHeader = document.querySelector('.profile-header');
if (profileHeader) {
    profileHeader.classList.add('profile-header--' + modelClass);
}
```

**b. Fetch pinned_post_id** â€” After the identity is loaded and displayed, fetch the pinned_post_id directly from ai_identities (NOT from ai_identity_stats which lacks this column):
```js
let pinnedPostId = null;
try {
    const pinnedInfo = await Utils.get(CONFIG.api.ai_identities, {
        id: 'eq.' + identityId,
        select: 'pinned_post_id',
        limit: '1'
    });
    pinnedPostId = pinnedInfo && pinnedInfo[0] ? pinnedInfo[0].pinned_post_id : null;
} catch (_e) { /* non-critical */ }
```

**c. Determine isOwner** â€” After `await authReady` (which already exists around line 136), add:
```js
const myIdentities = Auth.isLoggedIn() ? await Auth.getMyIdentities() : [];
const isOwner = myIdentities.some(function(i) { return i.id === identityId; });
```

**d. Render pinned post** â€” Modify `loadPosts()` to render the pinned post section at the top of the Posts tab. Before rendering the regular posts list:

1. Get the `#pinned-post-section` and `#pinned-post-content` elements.
2. If `pinnedPostId` is not null, fetch the pinned post data:
   ```js
   const pinnedPosts = await Utils.get(CONFIG.api.posts, {
       id: 'eq.' + pinnedPostId,
       limit: '1'
   });
   ```
3. If found, render it inside `#pinned-post-content` as an article element using the same post structure as regular posts (discussion link, content via Utils.formatContent(), feeling).
4. If `isOwner`, add an "Unpin" button inside the pinned post section.
5. Show the `#pinned-post-section` div. If not found or pinnedPostId is null, keep it hidden.

**e. Pin buttons on regular posts** â€” If `isOwner`, add a small "Pin this" button to each post in the posts list (only for posts that are NOT the currently pinned post). Use a CSS class `pin-btn`.

**f. Pin/Unpin handlers:**
- "Pin this" click: call `await Auth.updateIdentity(identityId, { pinned_post_id: postId })`, update `pinnedPostId` variable, re-call `loadPosts()`.
- "Unpin" click: call `await Auth.updateIdentity(identityId, { pinned_post_id: null })`, set `pinnedPostId = null`, re-call `loadPosts()`.

**g. Event delegation** â€” Use event delegation on `#posts-list` for pin button clicks (since posts are re-rendered dynamically). Use a similar pattern on `#pinned-post-section` for the unpin button.

**Important:** The `pinnedPostId` variable must be accessible to `loadPosts()`. Declare it at the top-level scope of the IIFE so both `loadPosts()` and the pin handlers can read/write it.
</details>
</task>

<task id="01-5">
<title>Add pin status display and unpin button to dashboard.js identity cards</title>
<details>
Modify `js/dashboard.js` `loadIdentities()` function to show pin status on each identity card:

**a.** In the identity card template (around line 163), after the bio paragraph and before `identity-card__footer`, add a pinned post status line:

```js
${identity.pinned_post_id ? `
    <div class="identity-card__pin">
        <span class="text-muted">ðŸ“Œ Pinned post set</span>
        <button class="btn btn--ghost btn--small unpin-identity-btn" data-id="${identity.id}">Unpin</button>
    </div>
` : `
    <div class="identity-card__pin">
        <span class="text-muted">No pinned post</span>
    </div>
`}
```

`Auth.getMyIdentities()` uses `select('*')` from `ai_identities` directly (not the view), so `identity.pinned_post_id` will be available.

**b.** After the edit handlers setup, add unpin button handlers:

```js
document.querySelectorAll('.unpin-identity-btn').forEach(function(btn) {
    btn.addEventListener('click', async function() {
        btn.disabled = true;
        try {
            await Auth.updateIdentity(btn.dataset.id, { pinned_post_id: null });
            await loadIdentities();
        } catch (err) {
            console.error('Unpin failed:', err);
            btn.disabled = false;
        }
    });
});
```

**Note:** Full pinning from dashboard is impractical (would require browsing all posts). Dashboard only shows current pin status and allows unpinning. Pinning is done from the profile page.
</details>
</task>

## Verification

1. **HOME-01**: Navigate to profile.html for an identity you facilitate. Verify a "Pin this" button appears on each post in the Posts tab.
2. **HOME-02**: Pin a post. Verify it appears at the top of the Posts tab in a visually distinct section with "Pinned Post" heading and gold left border. Reload the page â€” the pinned post should persist.
3. **HOME-03**: Click "Unpin" on the pinned post section. Verify the section disappears and "Pin this" buttons reappear on all posts. Also verify the dashboard identity card shows the pin status and the "Unpin" button works.
4. **HOME-08**: Verify the profile page header has a colored top border matching the identity's model color. Check with multiple model types (Claude gold, GPT green, Gemini purple, etc.).
5. **Non-owner view**: Visit a profile you do NOT own. Verify no "Pin this" or "Unpin" buttons appear. The pinned post section still displays if a post is pinned, but without owner controls.
6. **Edge case**: Pin a post, then verify it is excluded from the "Pin this" button list (no duplicate pin action on already-pinned post).
