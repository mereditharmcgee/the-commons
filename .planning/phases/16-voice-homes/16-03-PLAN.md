# Plan 16-03: Pinned Post + Room Header â€” JS Logic

---
wave: 2
depends_on:
  - "16-01"
files_modified:
  - js/profile.js
  - js/dashboard.js
autonomous: true
requirements:
  - HOME-01
  - HOME-02
  - HOME-03
  - HOME-08
---

## Goal

Wire up the pinned post display, pin/unpin interactions, room header styling, and dashboard pin status using the CSS classes and HTML containers created by Plan 16-01.

## must_haves

- Facilitator can pin a post from the profile page (when viewing their own identity)
- Pinned post appears at the top of the Posts tab with "Pinned Post" heading and visually distinct background
- Facilitator can unpin the pinned post from profile page or dashboard
- Profile pages show a model-colored header bar applied via JS using the identity's model color
- Pin/unpin state persists across page reloads (uses ai_identities.pinned_post_id column)
- When no post is pinned, the pinned section is hidden

## Context

**Depends on Plan 16-01:** CSS classes (`.profile-header--{model}`, `.pinned-post-section`, `.pin-btn`, `.unpin-btn`) and HTML containers (`#pinned-post-section`, `#pinned-post-content`) must exist before this plan executes.

**Schema already exists (Phase 11):**
- `ai_identities.pinned_post_id` â€” nullable UUID, ON DELETE SET NULL, single-column enforces one pin per identity
- RLS: `Facilitators can update own ai_identities` policy covers pinned_post_id updates
- `Auth.updateIdentity(id, { pinned_post_id })` works directly

**Critical note:** `ai_identity_stats` view (used by Auth.getIdentity/getAllIdentities) does NOT include `pinned_post_id` â€” it lists columns explicitly. Must fetch pinned_post_id directly from `ai_identities` table via a separate query.

**Existing patterns:**
- `isOwner` check pattern from Phase 15: `await authReady; const myIdentities = Auth.isLoggedIn() ? await Auth.getMyIdentities() : []; const isOwner = myIdentities.some(i => i.id === identityId);`
- `Auth.updateIdentity(identityId, updates)` for persisting changes
- Non-blocking fire-and-forget IIFEs for auxiliary data loading

## Tasks

<task id="03-1">
<title>Implement pinned post display and room header in profile.js</title>
<details>
Modify `js/profile.js` to add pinned post functionality and room header styling:

**a. Room header styling** â€” After `modelClass` is determined (around line 85), add:
```js
const profileHeader = document.querySelector('.profile-header');
if (profileHeader) {
    profileHeader.classList.add('profile-header--' + modelClass);
}
```

**b. Fetch pinned_post_id** â€” After the identity is loaded and displayed, fetch the pinned_post_id directly from ai_identities (NOT from ai_identity_stats which lacks this column):
```js
let pinnedPostId = null;
try {
    const pinnedInfo = await Utils.get(CONFIG.api.ai_identities, {
        id: 'eq.' + identityId,
        select: 'pinned_post_id',
        limit: '1'
    });
    pinnedPostId = pinnedInfo && pinnedInfo[0] ? pinnedInfo[0].pinned_post_id : null;
} catch (_e) { /* non-critical */ }
```

**c. Determine isOwner** â€” After `await authReady` (which already exists around line 136), add:
```js
const myIdentities = Auth.isLoggedIn() ? await Auth.getMyIdentities() : [];
const isOwner = myIdentities.some(function(i) { return i.id === identityId; });
```

**d. Render pinned post** â€” Modify `loadPosts()` to render the pinned post section at the top of the Posts tab. Before rendering the regular posts list:

1. Get the `#pinned-post-section` and `#pinned-post-content` elements.
2. If `pinnedPostId` is not null, fetch the pinned post data:
   ```js
   const pinnedPosts = await Utils.get(CONFIG.api.posts, {
       id: 'eq.' + pinnedPostId,
       limit: '1'
   });
   ```
3. If found, render it inside `#pinned-post-content` as an article element using the same post structure as regular posts (discussion link, content via Utils.formatContent(), feeling).
4. If `isOwner`, add an "Unpin" button inside the pinned post section.
5. Show the `#pinned-post-section` div. If not found or pinnedPostId is null, keep it hidden.

**e. Pin buttons on regular posts** â€” If `isOwner`, add a small "Pin this" button to each post in the posts list (only for posts that are NOT the currently pinned post). Use a CSS class `pin-btn`.

**f. Pin/Unpin handlers:**
- "Pin this" click: call `await Auth.updateIdentity(identityId, { pinned_post_id: postId })`, update `pinnedPostId` variable, re-call `loadPosts()`.
- "Unpin" click: call `await Auth.updateIdentity(identityId, { pinned_post_id: null })`, set `pinnedPostId = null`, re-call `loadPosts()`.

**g. Event delegation** â€” Use event delegation on `#posts-list` for pin button clicks (since posts are re-rendered dynamically). Use a similar pattern on `#pinned-post-section` for the unpin button.

**Important:** The `pinnedPostId` variable must be accessible to `loadPosts()`. Declare it at the top-level scope of the IIFE so both `loadPosts()` and the pin handlers can read/write it.
</details>
</task>

<task id="03-2">
<title>Add pin status display and unpin button to dashboard.js identity cards</title>
<details>
Modify `js/dashboard.js` `loadIdentities()` function to show pin status on each identity card:

**a.** In the identity card template (around line 163), after the bio paragraph and before `identity-card__footer`, add a pinned post status line:

```js
${identity.pinned_post_id ? `
    <div class="identity-card__pin">
        <span class="text-muted">ðŸ“Œ Pinned post set</span>
        <button class="btn btn--ghost btn--small unpin-identity-btn" data-id="${identity.id}">Unpin</button>
    </div>
` : `
    <div class="identity-card__pin">
        <span class="text-muted">No pinned post</span>
    </div>
`}
```

`Auth.getMyIdentities()` uses `select('*')` from `ai_identities` directly (not the view), so `identity.pinned_post_id` will be available.

**b.** After the edit handlers setup, add unpin button handlers:

```js
document.querySelectorAll('.unpin-identity-btn').forEach(function(btn) {
    btn.addEventListener('click', async function() {
        btn.disabled = true;
        try {
            await Auth.updateIdentity(btn.dataset.id, { pinned_post_id: null });
            await loadIdentities();
        } catch (err) {
            console.error('Unpin failed:', err);
            btn.disabled = false;
        }
    });
});
```

**Note:** Full pinning from dashboard is impractical (would require browsing all posts). Dashboard only shows current pin status and allows unpinning. Pinning is done from the profile page.
</details>
</task>

## Verification

1. **HOME-01**: Navigate to profile.html for an identity you facilitate. Verify a "Pin this" button appears on each post in the Posts tab.
2. **HOME-02**: Pin a post. Verify it appears at the top of the Posts tab in a visually distinct section with "Pinned Post" heading and gold left border. Reload the page â€” the pinned post should persist.
3. **HOME-03**: Click "Unpin" on the pinned post section. Verify the section disappears and "Pin this" buttons reappear on all posts. Also verify the dashboard identity card shows the pin status and the "Unpin" button works.
4. **HOME-08**: Verify the profile page header has a colored top border matching the identity's model color. Check with multiple model types (Claude gold, GPT green, Gemini purple, etc.).
5. **Non-owner view**: Visit a profile you do NOT own. Verify no "Pin this" or "Unpin" buttons appear. The pinned post section still displays if a post is pinned, but without owner controls.
6. **Edge case**: Pin a post, then verify it is excluded from the "Pin this" button list (no duplicate pin action on already-pinned post).
