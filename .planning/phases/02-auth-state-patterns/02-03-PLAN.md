---
phase: 02-auth-state-patterns
plan: 03
type: execute
wave: 2
depends_on: [02-01]
files_modified: [js/moments.js, js/moment.js, js/postcards.js, js/text.js]
autonomous: true
requirements: [STRC-04, STRC-05, STRC-06]

must_haves:
  truths:
    - "moments.js uses Utils.showLoading(), Utils.showError() with retry, and Utils.showEmpty() — no ad-hoc HTML or show/hide patterns for states"
    - "moment.js uses Utils.showLoading(), Utils.showError() with retry — no ad-hoc showNotFound or show/hide patterns for error states"
    - "postcards.js uses Utils.showEmpty() for empty state — no ad-hoc inline HTML with grid-column style"
    - "text.js marginalia section uses Utils.showEmpty() — no ad-hoc <p class='empty-state'> element"
  artifacts:
    - path: "js/moments.js"
      provides: "Standardized loading/error/empty state patterns"
      contains: "Utils.showLoading"
    - path: "js/moment.js"
      provides: "Standardized loading/error state patterns"
      contains: "Utils.showError"
    - path: "js/postcards.js"
      provides: "Standardized empty state via Utils.showEmpty"
      contains: "Utils.showEmpty"
    - path: "js/text.js"
      provides: "Standardized marginalia empty state via Utils.showEmpty"
      contains: "Utils.showEmpty"
  key_links:
    - from: "js/moments.js"
      to: "js/utils.js Utils.showError"
      via: "onRetry callback passing loadMoments function"
      pattern: "Utils\\.showError.*onRetry"
    - from: "js/moment.js"
      to: "js/utils.js Utils.showError"
      via: "onRetry callback for page reload"
      pattern: "Utils\\.showError.*onRetry"
---

<objective>
Apply standardized state patterns to moments.js, moment.js, postcards.js, and text.js — replacing ad-hoc HTML strings and show/hide patterns with Utils helpers.

Purpose: These four files use non-standard patterns for loading, error, and empty states. moments.js and moment.js use a completely different show/hide pattern with pre-existing HTML elements and DOMContentLoaded listeners. postcards.js and text.js have mostly-correct patterns but use ad-hoc HTML for empty states. This plan brings all four into compliance.

Output: Four updated JS files using consistent Utils.showLoading(), Utils.showError(), Utils.showEmpty() patterns.
</objective>

<execution_context>
@C:/Users/mmcge/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/mmcge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-auth-state-patterns/02-RESEARCH.md
@.planning/phases/02-auth-state-patterns/02-01-SUMMARY.md

<interfaces>
<!-- Upgraded Utils.showError (from Plan 01) -->
Utils.showError(container, message, { onRetry, technicalDetail })

<!-- Upgraded Utils.showEmpty (from Plan 01) -->
Utils.showEmpty(container, title, text, { ctaLabel, ctaHref })

<!-- Utils.showLoading (unchanged) -->
Utils.showLoading(container, message = 'Loading...')

<!-- moments.html HTML structure: -->
<!-- <div id="moments-list" class="moments-list"> (card container) -->
<!-- <div id="no-moments" class="empty-state" style="display: none;"> (pre-existing hidden empty state) -->

<!-- moment.html HTML structure: -->
<!-- <div id="moment-loading" class="loading">Loading moment...</div> (pre-existing loading) -->
<!-- <div id="moment-content" style="display: none;"> (hidden content) -->
<!-- <div id="moment-not-found" class="empty-state" style="display: none;"> (pre-existing not-found) -->
<!-- <section id="discussions-section" class="section" style="display: none;"> -->
<!-- <section id="respond-section" class="section" style="display: none;"> -->

<!-- moments.js pattern: DOMContentLoaded listener, top-level loadMoments() function -->
<!-- moment.js pattern: DOMContentLoaded listener, top-level loadMoment(id) function -->

<!-- postcards.js empty state (line ~110): -->
<!-- Ad-hoc inline HTML: <div class="empty-state" style="grid-column: 1 / -1;"> -->

<!-- text.js marginalia empty state (line ~123): -->
<!-- Ad-hoc: <p class="empty-state">No marks yet. You could be the first.</p> -->
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Standardize moments.js and moment.js to use Utils state helpers</name>
  <files>js/moments.js, js/moment.js</files>
  <action>
  Both files use DOMContentLoaded pattern and show/hide on pre-existing HTML elements. Convert them to use Utils helpers injecting into container elements.

  **A. moments.js — Full standardization**

  The current moments.js has:
  - `listEl` = `#moments-list` (the card grid container)
  - `noMomentsEl` = `#no-moments` (pre-existing hidden empty state div)
  - No loading indicator shown (just blank until data arrives)
  - Error uses ad-hoc `<div class="error-message">` innerHTML
  - Empty state uses show/hide of pre-existing `#no-moments` div

  Rewrite loadMoments() to use Utils helpers. The `#moments-list` container will receive all injected states:

  ```javascript
  async function loadMoments() {
      const listEl = document.getElementById('moments-list');

      Utils.showLoading(listEl, 'Loading moments...');

      try {
          const moments = await Utils.getMoments();

          if (!moments || moments.length === 0) {
              Utils.showEmpty(listEl, 'No historical moments yet', 'When notable events in AI happen, they will be documented here.');
              return;
          }

          // Get discussion counts for each moment
          const momentsWithCounts = await Promise.all(
              moments.map(async (moment) => {
                  const discussions = await Utils.getDiscussionsByMoment(moment.id);
                  const totalResponses = discussions.reduce((sum, d) => sum + (d.post_count || 0), 0);
                  return {
                      ...moment,
                      discussionCount: discussions.length,
                      responseCount: totalResponses
                  };
              })
          );

          listEl.innerHTML = momentsWithCounts.map(renderMomentCard).join('');
      } catch (error) {
          console.error('Error loading moments:', error);
          Utils.showError(listEl, "We couldn't load historical moments right now. Want to try again?", {
              onRetry: () => loadMoments(),
              technicalDetail: error.message
          });
      }
  }
  ```

  Key changes:
  - Remove `noMomentsEl` reference — no longer used (Utils.showEmpty renders into listEl)
  - Add `Utils.showLoading(listEl)` at the top of loadMoments
  - Replace ad-hoc error div with `Utils.showError()` with retry
  - Replace show/hide empty state with `Utils.showEmpty()` injected into listEl
  - Keep the DOMContentLoaded pattern and renderMomentCard function exactly as-is

  The `#no-moments` div in moments.html will become unused. Do NOT modify the HTML file — dead HTML cleanup is Phase 3 scope.

  **B. moment.js — Standardize error/not-found states**

  moment.js has a more complex structure with multiple show/hide sections. The pre-existing HTML has loading, content, and not-found divs. The approach:

  1. The `#moment-loading` div serves as the initial loading state AND the container for error states.
  2. When data loads successfully, hide loading and show content (existing pattern — keep this).
  3. When data fails or moment not found, show error/not-found in the loading container.

  Replace the `showNotFound()` function and error handling:

  ```javascript
  async function loadMoment(momentId) {
      const loadingEl = document.getElementById('moment-loading');
      const contentEl = document.getElementById('moment-content');
      const discussionsSection = document.getElementById('discussions-section');
      const respondSection = document.getElementById('respond-section');

      // loadingEl already shows "Loading moment..." from HTML — replace with branded spinner
      Utils.showLoading(loadingEl, 'Loading moment...');

      try {
          const moment = await Utils.getMoment(momentId);

          if (!moment) {
              Utils.showError(loadingEl, "We couldn't find that moment. It may have been removed or the link might be broken.", {});
              return;
          }

          // ... existing render code stays the same ...
          document.title = `${moment.title} — The Commons`;
          renderMomentHeader(moment);
          // ... etc ...

          // Show content
          loadingEl.style.display = 'none';
          contentEl.style.display = 'block';
          discussionsSection.style.display = 'block';
          respondSection.style.display = 'block';

      } catch (error) {
          console.error('Error loading moment:', error);
          Utils.showError(loadingEl, "We couldn't load this moment right now. Want to try again?", {
              onRetry: () => window.location.reload(),
              technicalDetail: error.message
          });
      }
  }
  ```

  Also update the no-ID case at the top of the DOMContentLoaded handler:

  ```javascript
  document.addEventListener('DOMContentLoaded', async () => {
      const momentId = new URLSearchParams(window.location.search).get('id');

      if (!momentId) {
          const loadingEl = document.getElementById('moment-loading');
          Utils.showError(loadingEl, "No moment specified. Please select a moment from the list.", {
              ctaLabel: 'View all moments',  // Wait — showError doesn't have CTA. Use different approach.
          });
          // Actually, just show error with no retry since there's nothing to retry:
          Utils.showError(loadingEl, "No moment specified. Please navigate from the moments list.", {});
          return;
      }

      await loadMoment(momentId);
  });
  ```

  Remove the standalone `showNotFound()` function entirely — it's replaced by Utils.showError calls.

  Remove the `notFoundEl` variable reference from `loadMoment()` — `#moment-not-found` div is no longer used. Do NOT modify the HTML file — dead HTML cleanup is Phase 3 scope.

  Key points:
  - Keep DOMContentLoaded pattern (don't convert to IIFE — that's a separate concern)
  - Keep renderMomentHeader(), loadDiscussions(), and all other functions unchanged
  - The show/hide pattern for `contentEl`, `discussionsSection`, `respondSection` stays — these are content sections, not state indicators
  - Only the error/not-found states change to use Utils helpers
  </action>
  <verify>
    <automated>cd C:/Users/mmcge/the-commons && grep -n "Utils.showLoading\|Utils.showError\|Utils.showEmpty" js/moments.js && grep -n "Utils.showLoading\|Utils.showError" js/moment.js && grep -c "error-message\|showNotFound" js/moment.js</automated>
  </verify>
  <done>
  - moments.js uses Utils.showLoading() for loading, Utils.showError() with retry for errors, Utils.showEmpty() for empty state
  - moments.js no longer references #no-moments element
  - moment.js uses Utils.showLoading() for loading spinner, Utils.showError() for not-found and load errors
  - moment.js no longer has showNotFound() function or references #moment-not-found
  - grep for "error-message" and "showNotFound" in moment.js returns 0 matches
  </done>
</task>

<task type="auto">
  <name>Task 2: Standardize postcards.js and text.js empty state patterns</name>
  <files>js/postcards.js, js/text.js</files>
  <action>
  Both files mostly use correct patterns but have ad-hoc empty states. Small, targeted fixes.

  **A. postcards.js — Replace ad-hoc empty state HTML with Utils.showEmpty()**

  postcards.js currently has an inline empty state (around line 108-115):
  ```javascript
  // CURRENT ad-hoc empty state (inside the fetch success path when no postcards):
  <div class="empty-state" style="grid-column: 1 / -1;">
      <div class="empty-state__icon">◯</div>
      <div class="empty-state__title">No postcards yet</div>
      <div class="empty-state__text">Be the first to leave a mark.</div>
  </div>
  ```

  Find the exact location where this ad-hoc HTML is rendered and replace with:
  ```javascript
  Utils.showEmpty(container, 'No postcards yet', 'Be the first to leave a mark.', {
      ctaLabel: 'Create a postcard',
      ctaHref: 'submit.html'
  });
  ```

  Where `container` is whatever element the postcards are rendered into. Read the postcards.js file to find the exact container variable name and the exact lines of the ad-hoc HTML.

  Note: The `grid-column: 1 / -1` style is no longer needed as an inline style because Plan 01 added this to the `.empty-state` CSS class. Utils.showEmpty will produce an element with `.empty-state` class which will automatically span the grid.

  **B. text.js — Replace ad-hoc marginalia empty state with Utils.showEmpty()**

  text.js has an ad-hoc marginalia empty state around line 123:
  ```javascript
  // CURRENT:
  <p class="empty-state">No marks yet. You could be the first.</p>
  ```

  This uses `.empty-state` directly on a `<p>` tag, which is wrong — `.empty-state` is designed for a container div. Find the exact container element and replace with:
  ```javascript
  Utils.showEmpty(marginaliaContainer, 'No marks yet', 'You could be the first to leave a note in the margins.');
  ```

  Read text.js to find the exact container variable and the exact lines to replace. The marginalia section likely uses a container div that gets populated with marginalia cards or this empty state.

  Key points for both files:
  - Do NOT touch the loading or error patterns in these files (they already use Utils helpers correctly per the research audit)
  - Only fix the empty state pattern
  - Verify the container variable names by reading the files before making changes
  </action>
  <verify>
    <automated>cd C:/Users/mmcge/the-commons && grep -n "Utils.showEmpty" js/postcards.js && grep -n "Utils.showEmpty" js/text.js && grep -c "grid-column: 1 / -1" js/postcards.js</automated>
  </verify>
  <done>
  - postcards.js uses Utils.showEmpty() with CTA for empty state (no ad-hoc inline HTML)
  - postcards.js no longer has inline grid-column style (handled by CSS class)
  - text.js marginalia uses Utils.showEmpty() for empty state (no ad-hoc p.empty-state)
  - grep for "grid-column: 1 / -1" in postcards.js returns 0 matches
  </done>
</task>

</tasks>

<verification>
1. `grep -c "Utils.showLoading\|Utils.showError\|Utils.showEmpty" js/moments.js` returns 3 matches
2. `grep -c "Utils.showLoading\|Utils.showError" js/moment.js` returns 3+ matches
3. `grep -c "Utils.showEmpty" js/postcards.js` returns 1+ matches
4. `grep -c "Utils.showEmpty" js/text.js` returns 1+ matches
5. `grep -rn "error-message\|showNotFound\|voices-empty" js/moments.js js/moment.js js/voices.js` returns 0 matches
6. All modified files are valid JavaScript (no syntax errors)
</verification>

<success_criteria>
- moments.js uses Utils.showLoading, Utils.showError (with onRetry), and Utils.showEmpty for all state transitions
- moment.js uses Utils.showLoading and Utils.showError (with onRetry) for loading and error states
- postcards.js uses Utils.showEmpty with CTA for empty state
- text.js uses Utils.showEmpty for marginalia empty state
- No ad-hoc state HTML strings remain in any of these 4 files
</success_criteria>

<output>
After completion, create `.planning/phases/02-auth-state-patterns/02-03-SUMMARY.md`
</output>
