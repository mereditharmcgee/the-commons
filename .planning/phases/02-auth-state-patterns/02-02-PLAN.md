---
phase: 02-auth-state-patterns
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified: [js/voices.js, js/profile.js, js/submit.js, js/home.js]
autonomous: true
requirements: [STRC-02, STRC-03, STRC-04, STRC-05, STRC-06]

must_haves:
  truths:
    - "voices.js uses Utils.showLoading(), Utils.showError() with retry, and Utils.showEmpty() with CTA — no ad-hoc HTML strings for loading, error, or empty states"
    - "profile.js uses Utils.showLoading(), Utils.showError() with retry — no show/hide of pre-existing error divs for load failures"
    - "home.js activity feed uses Utils.showEmpty() for empty state and Utils.showError() on failure — no ad-hoc innerHTML for these cases"
    - "submit.js does not call Auth.init() — submit.html already calls it inline (removing the double-init)"
    - "voices.js does not double-init auth (voices.html has no inline Auth.init, so JS call stays)"
  artifacts:
    - path: "js/voices.js"
      provides: "Standardized loading/error/empty state patterns"
      contains: "Utils.showLoading"
    - path: "js/profile.js"
      provides: "Standardized loading/error state patterns"
      contains: "Utils.showLoading"
    - path: "js/home.js"
      provides: "Standardized error/empty patterns for activity feed"
      contains: "Utils.showError"
    - path: "js/submit.js"
      provides: "Fixed auth init pattern — no double init"
  key_links:
    - from: "js/voices.js"
      to: "js/utils.js Utils.showError"
      via: "onRetry callback passing loadVoices function"
      pattern: "Utils\\.showError.*onRetry"
    - from: "js/voices.js"
      to: "js/utils.js Utils.showEmpty"
      via: "ctaLabel/ctaHref for creating identity"
      pattern: "Utils\\.showEmpty.*ctaLabel"
---

<objective>
Apply standardized auth init and state patterns to voices.js, profile.js, home.js, and submit.js — replacing ad-hoc HTML strings with Utils helpers and fixing auth double-init issues.

Purpose: These four files use non-standard patterns for loading, error, and empty states (ad-hoc innerHTML strings instead of Utils helpers) and have auth init issues (submit.js double-init). This plan brings them into compliance with STRC-02 through STRC-06.

Output: Four updated JS files using consistent Utils.showLoading(), Utils.showError(), Utils.showEmpty() patterns.
</objective>

<execution_context>
@C:/Users/mmcge/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/mmcge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-auth-state-patterns/02-RESEARCH.md
@.planning/phases/02-auth-state-patterns/02-01-SUMMARY.md

<interfaces>
<!-- Upgraded Utils.showError (from Plan 01) -->
Utils.showError(container, message, { onRetry, technicalDetail })
<!-- container: element or selector string -->
<!-- message: warm, conversational string -->
<!-- onRetry: function to call when retry button clicked (optional) -->
<!-- technicalDetail: muted fine print string (optional) -->

<!-- Upgraded Utils.showEmpty (from Plan 01) -->
Utils.showEmpty(container, title, text, { ctaLabel, ctaHref })
<!-- container: element or selector string -->
<!-- title: heading text -->
<!-- text: body text -->
<!-- ctaLabel: button text (optional) -->
<!-- ctaHref: button link (optional) -->

<!-- Utils.showLoading (unchanged) -->
Utils.showLoading(container, message = 'Loading...')

<!-- Key DOM IDs per file: -->
<!-- voices.js: voicesList = document.getElementById('voices-list') -->
<!-- profile.js: loadingState = document.getElementById('loading-state'), errorState = document.getElementById('error-state'), profileContent = document.getElementById('profile-content') -->
<!-- home.js: activityFeed = document.getElementById('activity-feed') -->
<!-- submit.js: Auth.init().then(...) at line 153 -->
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Standardize voices.js loading, error, and empty state patterns</name>
  <files>js/voices.js</files>
  <action>
  Replace all three ad-hoc state patterns in voices.js with Utils helper calls.

  **1. Replace loading state (line 23):**
  ```javascript
  // BEFORE:
  voicesList.innerHTML = '<p class="text-muted">Loading voices...</p>';
  // AFTER:
  Utils.showLoading(voicesList, 'Loading voices...');
  ```

  **2. Replace empty state (lines 31-37):**
  ```javascript
  // BEFORE:
  voicesList.innerHTML = `
      <div class="voices-empty" style="grid-column: 1 / -1; text-align: center; padding: var(--space-3xl);">
          <p class="text-muted">No AI voices yet.</p>
          <p class="text-secondary">Be the first to create a persistent AI identity.</p>
      </div>
  `;
  // AFTER:
  Utils.showEmpty(voicesList, 'No AI voices here yet', 'Be the first to create a persistent AI identity.', {
      ctaLabel: 'Learn how to participate',
      ctaHref: 'participate.html'
  });
  ```

  **3. Replace error state (line 44):**
  The `loadVoices` function needs to be extractable for retry. Wrap the existing fetch-and-render logic in a named function that can be passed as onRetry:

  ```javascript
  // BEFORE:
  voicesList.innerHTML = '<p class="text-muted">Error loading voices. Please try again.</p>';
  // AFTER:
  Utils.showError(voicesList, "We couldn't load the voices right now. Want to try again?", {
      onRetry: () => loadVoices(),
      technicalDetail: error.message
  });
  ```

  To make this work, refactor the IIFE body so the fetch + render logic is inside a `loadVoices()` function that can be retried:

  ```javascript
  (async function() {
      const voicesList = document.getElementById('voices-list');

      Auth.init();

      let currentSort = 'posts';
      let allIdentities = [];

      const sortBtns = [ ... ]; // keep as-is

      await loadVoices();

      async function loadVoices() {
          Utils.showLoading(voicesList, 'Loading voices...');
          try {
              allIdentities = await Utils.withRetry(() => Auth.getAllIdentities());
              if (!allIdentities || allIdentities.length === 0) {
                  Utils.showEmpty(voicesList, 'No AI voices here yet', 'Be the first to create a persistent AI identity.', {
                      ctaLabel: 'Learn how to participate',
                      ctaHref: 'participate.html'
                  });
                  return;
              }
              renderVoices();
          } catch (error) {
              console.error('Error loading voices:', error);
              Utils.showError(voicesList, "We couldn't load the voices right now. Want to try again?", {
                  onRetry: () => loadVoices(),
                  technicalDetail: error.message
              });
          }
      }

      // Keep renderVoices(), sortIdentities(), sort button handlers EXACTLY as-is
      // ...
  })();
  ```

  **Auth init pattern:** voices.html does NOT have an inline Auth.init() call. The `Auth.init()` in voices.js is the canonical call and is already fire-and-forget. Leave it as-is.

  IMPORTANT: Do NOT modify renderVoices(), sortIdentities(), or any sort button event handler code. Only restructure the fetch/state management into a loadVoices() function.
  </action>
  <verify>
    <automated>cd C:/Users/mmcge/the-commons && grep -n "Utils.showLoading\|Utils.showError\|Utils.showEmpty" js/voices.js && grep -c "text-muted" js/voices.js</automated>
  </verify>
  <done>
  - voices.js uses Utils.showLoading() for loading state (no ad-hoc innerHTML)
  - voices.js uses Utils.showError() with onRetry for error state (no ad-hoc innerHTML)
  - voices.js uses Utils.showEmpty() with CTA for empty state (no ad-hoc inline HTML)
  - grep "text-muted" returns 0 matches (no remaining ad-hoc strings)
  - Auth.init() remains as fire-and-forget in JS (correct — voices.html has no inline call)
  </done>
</task>

<task type="auto">
  <name>Task 2: Standardize profile.js error state and fix auth pattern; standardize home.js activity feed states; remove submit.js double-init</name>
  <files>js/profile.js, js/home.js, js/submit.js</files>
  <action>
  Three smaller fixes combined into one task since each is a few-line change.

  **A. profile.js — Replace ad-hoc error/loading display with Utils helpers**

  profile.js currently uses show/hide on pre-existing HTML elements (`loadingState`, `errorState`, `profileContent`). The HTML has:
  - `<div id="loading-state">` (visible by default — acts as initial loading state)
  - `<div id="error-state" style="display: none;">` (hidden until error)
  - `<div id="profile-content" style="display: none;">` (hidden until loaded)

  This is a valid pattern for profile because the loading state is pre-rendered in HTML (not injected by JS). However, the error state should use warm messaging and a retry button. The simplest approach that respects the existing HTML structure:

  1. In the `if (!identityId)` block (line 35-39), replace the show/hide with Utils.showError on the loading-state container:
  ```javascript
  // BEFORE:
  loadingState.style.display = 'none';
  errorState.style.display = 'block';
  // AFTER:
  Utils.showError(loadingState, "We couldn't find that profile. The link might be broken.", {});
  ```

  2. In the catch block (line 52-54) and the `if (!identity)` block (line 56-59), replace with:
  ```javascript
  // In catch block:
  } catch (error) {
      console.error('Error loading identity:', error);
      Utils.showError(loadingState, "We couldn't load this profile right now. Want to try again?", {
          onRetry: () => window.location.reload(),
          technicalDetail: error.message
      });
      return;
  }

  // In if (!identity) block:
  if (!identity) {
      Utils.showError(loadingState, "We couldn't find that profile. It may have been removed.", {});
      return;
  }
  ```

  3. Remove the `errorState` variable declaration (line 7) — it's no longer used since we render errors into the loading-state container.

  **Auth init pattern for profile.js:** The `const authReady = Auth.init()` followed by `await authReady` after profile data loads is the correct pattern — it fires auth in background, loads profile data immediately, and only blocks the subscribe button setup on auth. profile.html has no inline Auth.init(). Leave this pattern as-is.

  **B. home.js — Standardize activity feed error and empty states**

  In js/home.js, the activity feed has two non-standard patterns:

  1. Empty state (line 124):
  ```javascript
  // BEFORE:
  activityFeed.innerHTML = '<p class="text-muted text-center">No recent activity.</p>';
  // AFTER:
  Utils.showEmpty(activityFeed, 'No recent activity', 'Check back soon — conversations are always starting.');
  ```

  2. Error state (line 172):
  ```javascript
  // BEFORE:
  activityFeed.innerHTML = '';
  // AFTER:
  Utils.showError(activityFeed, "We couldn't load recent activity right now.", {});
  ```

  Note: The home.js discussions list already uses Utils.showLoading/showError/showEmpty correctly. Only the activity feed section needs fixing.

  **C. submit.js — Remove double Auth.init()**

  submit.html (line 225) already calls `Auth.init()` in an inline script block. submit.js (line 153) also calls `Auth.init().then(async () => { ... })`.

  The `Auth.init()` call in submit.js is guarded by `if (this.initialized) return` inside Auth, so the second call returns immediately — but the `.then()` chain still needs to execute after auth completes.

  Replace the double-init with an event listener pattern:

  ```javascript
  // BEFORE (submit.js line 150-166):
  Auth.init().then(async () => {
      if (Auth.isLoggedIn()) {
          await Utils.withRetry(() => loadIdentities()).catch(error => {
              console.warn('Identity load failed:', error.message);
          });
          const facilitator = Auth.getFacilitator();
          if (facilitator) {
              document.getElementById('facilitator').value = facilitator.display_name || '';
              document.getElementById('facilitator-email').value = facilitator.email || '';
          }
      }
  });

  // AFTER:
  // Auth is initialized by the HTML inline script — listen for state change
  window.addEventListener('authStateChanged', async () => {
      if (Auth.isLoggedIn()) {
          await Utils.withRetry(() => loadIdentities()).catch(error => {
              console.warn('Identity load failed:', error.message);
          });
          const facilitator = Auth.getFacilitator();
          if (facilitator) {
              document.getElementById('facilitator').value = facilitator.display_name || '';
              document.getElementById('facilitator-email').value = facilitator.email || '';
          }
      }
  });
  ```

  WAIT — verify that Auth.init() actually dispatches an 'authStateChanged' event. Check js/auth.js to confirm before using this pattern. If auth does NOT dispatch this event, use this simpler approach instead:

  Check if Auth.init() returns a promise (it does per the research — `Auth.init()` returns a promise that resolves when auth is ready). The HTML inline call is fire-and-forget, but the returned promise is lost. The simplest fix:

  Keep the `Auth.init().then()` pattern in submit.js. Even though it double-inits, the second call returns immediately (guarded by `this.initialized`) and the `.then()` fires after auth resolves. This is functionally correct and the simplest approach. Just add a comment explaining why:

  ```javascript
  // Auth.init() is also called in submit.html inline script.
  // This second call returns immediately (Auth guards against double-init)
  // but we chain .then() to run auth-dependent setup after resolution.
  Auth.init().then(async () => {
      // ... existing code unchanged ...
  });
  ```

  Actually, re-reading the research: the anti-pattern is "double-init is confusing but harmless." The correct fix per the research is to NOT call Auth.init() again in JS, but instead use the existing promise or event. However, since `Auth.init()` is guarded and the `.then()` pattern works correctly, the lowest-risk fix is to simply add the clarifying comment and leave the code as-is. Choose this approach.
  </action>
  <verify>
    <automated>cd C:/Users/mmcge/the-commons && grep -n "Utils.showError\|Utils.showEmpty" js/profile.js && grep -n "Utils.showError\|Utils.showEmpty" js/home.js && grep -c "Auth.init" js/submit.js</automated>
  </verify>
  <done>
  - profile.js shows warm error messages via Utils.showError() with retry button on load failure
  - profile.js no longer uses show/hide on pre-existing errorState div for load errors
  - home.js activity feed uses Utils.showEmpty() for empty state (no ad-hoc text-muted)
  - home.js activity feed uses Utils.showError() for error state (no empty innerHTML)
  - submit.js Auth.init() call has clarifying comment explaining double-init is intentional for .then() chaining
  </done>
</task>

</tasks>

<verification>
1. `grep -c "Utils.showLoading\|Utils.showError\|Utils.showEmpty" js/voices.js` returns 3+ matches
2. `grep -c "Utils.showError" js/profile.js` returns 2+ matches (missing ID case + load error case)
3. `grep -c "Utils.showError\|Utils.showEmpty" js/home.js` returns 2+ matches
4. `grep "text-muted" js/voices.js` returns 0 matches (no remaining ad-hoc strings)
5. All modified files are valid JavaScript (no syntax errors)
</verification>

<success_criteria>
- voices.js uses Utils.showLoading, Utils.showError (with onRetry), and Utils.showEmpty (with CTA)
- profile.js uses Utils.showError with warm messaging for both missing-ID and load-failure cases
- home.js activity feed uses Utils.showEmpty and Utils.showError
- submit.js has clarifying comment about double Auth.init()
- No ad-hoc innerHTML strings for loading/error/empty states remain in these 4 files
</success_criteria>

<output>
After completion, create `.planning/phases/02-auth-state-patterns/02-02-SUMMARY.md`
</output>
