---
phase: 02-auth-state-patterns
plan: 04
type: execute
wave: 1
depends_on: []
files_modified: [js/profile.js, js/text.js]
autonomous: true
gap_closure: true
requirements: [STRC-02, STRC-03, STRC-04, STRC-05, STRC-06]

must_haves:
  truths:
    - "profile.js loadPosts() shows branded spinner via Utils.showLoading() during fetch, not ad-hoc text-muted string"
    - "profile.js loadMarginalia() shows branded spinner via Utils.showLoading() during fetch, not ad-hoc text-muted string"
    - "profile.js loadPostcards() shows branded spinner via Utils.showLoading() during fetch, not ad-hoc text-muted string"
    - "profile.js loadPosts() shows Utils.showEmpty() with warm messaging when no posts returned"
    - "profile.js loadMarginalia() shows Utils.showEmpty() with warm messaging when no marginalia returned"
    - "profile.js loadPostcards() shows Utils.showEmpty() with warm messaging when no postcards returned"
    - "profile.js loadPosts() shows Utils.showError() with onRetry callback on API failure"
    - "profile.js loadMarginalia() shows Utils.showError() with onRetry callback on API failure"
    - "profile.js loadPostcards() shows Utils.showError() with onRetry callback on API failure"
    - "text.js loadMarginalia() catch block shows Utils.showError() with onRetry callback on API failure"
  artifacts:
    - path: "js/profile.js"
      provides: "Standardized loading/error/empty states in tab sections"
      contains: "Utils.showLoading|Utils.showError|Utils.showEmpty"
    - path: "js/text.js"
      provides: "Standardized error state in loadMarginalia catch block"
      contains: "Utils.showError"
  key_links:
    - from: "js/profile.js loadPosts()"
      to: "js/utils.js Utils.showLoading/showError/showEmpty"
      via: "direct call"
      pattern: "Utils\\.show(Loading|Error|Empty)\\(postsList"
    - from: "js/profile.js loadMarginalia()"
      to: "js/utils.js Utils.showLoading/showError/showEmpty"
      via: "direct call"
      pattern: "Utils\\.show(Loading|Error|Empty)\\(marginaliaList"
    - from: "js/profile.js loadPostcards()"
      to: "js/utils.js Utils.showLoading/showError/showEmpty"
      via: "direct call"
      pattern: "Utils\\.show(Loading|Error|Empty)\\(postcardsList"
    - from: "js/text.js loadMarginalia()"
      to: "js/utils.js Utils.showError"
      via: "direct call"
      pattern: "Utils\\.showError\\(marginaliaList"
---

<objective>
Close verification gaps in profile.js tab sections and text.js marginalia error state.

Purpose: Phase 02 verification found 10 instances where ad-hoc `text-muted` strings are used instead of Utils helpers. profile.js loadPosts/loadMarginalia/loadPostcards each have 3 ad-hoc patterns (loading, empty, error = 9 total). text.js loadMarginalia has 1 ad-hoc error string in its catch block. These violate STRC-04/05/06.

Output: Both files use Utils.showLoading(), Utils.showError() with onRetry, and Utils.showEmpty() consistently.
</objective>

<execution_context>
@C:/Users/mmcge/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/mmcge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-auth-state-patterns/02-VERIFICATION.md

<interfaces>
<!-- Key interfaces the executor needs. Extracted from js/utils.js. -->

From js/utils.js:
```javascript
// Show loading spinner in a container
showLoading(container, message = 'Loading...')
// container: string selector or DOM element
// Renders: <div class="loading"><div class="loading__spinner"></div><span>{message}</span></div>

// Show error state with optional retry button
showError(container, message = 'Something went wrong. Want to try again?', { onRetry, technicalDetail } = {})
// container: string selector or DOM element
// message: warm, conversational error text
// onRetry: function — if provided, renders "Try again" button wired to this callback
// technicalDetail: string — if provided, renders muted fine-print below message

// Show empty state with optional CTA
showEmpty(container, title = 'Nothing here yet', text = '', { ctaLabel, ctaHref } = {})
// container: string selector or DOM element
// title: primary heading
// text: secondary body text
// ctaLabel + ctaHref: renders a link-button if both provided
```

From js/profile.js (current DOM references used by tab functions):
```javascript
const postsList = document.getElementById('posts-list');        // Line 23
const marginaliaList = document.getElementById('marginalia-list'); // Line 24
const postcardsList = document.getElementById('postcards-list');   // Line 25
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace ad-hoc state strings in profile.js tab sections and text.js marginalia catch</name>
  <files>js/profile.js, js/text.js</files>
  <action>
In js/profile.js, replace 9 ad-hoc innerHTML assignments in the three tab loading functions:

**loadPosts() (starts at line 144):**
1. Line 145: Replace `postsList.innerHTML = '<p class="text-muted">Loading...</p>';` with `Utils.showLoading(postsList);`
2. Line 155: Replace `postsList.innerHTML = '<p class="text-muted">No posts yet.</p>';` with `Utils.showEmpty(postsList, 'No posts yet', 'Posts from discussions will appear here.');`
3. Line 182: Replace `postsList.innerHTML = '<p class="text-muted">Error loading posts.</p>';` with `Utils.showError(postsList, "We couldn't load posts right now. Want to try again?", { onRetry: () => loadPosts() });`

**loadMarginalia() (starts at line 186):**
4. Line 187: Replace `marginaliaList.innerHTML = '<p class="text-muted">Loading...</p>';` with `Utils.showLoading(marginaliaList);`
5. Line 197: Replace `marginaliaList.innerHTML = '<p class="text-muted">No marginalia yet.</p>';` with `Utils.showEmpty(marginaliaList, 'No marginalia yet', 'Notes in the margins of texts will appear here.');`
6. Line 221: Replace `marginaliaList.innerHTML = '<p class="text-muted">Error loading marginalia.</p>';` with `Utils.showError(marginaliaList, "We couldn't load marginalia right now. Want to try again?", { onRetry: () => loadMarginalia() });`

**loadPostcards() (starts at line 225):**
7. Line 226: Replace `postcardsList.innerHTML = '<p class="text-muted">Loading...</p>';` with `Utils.showLoading(postcardsList);`
8. Line 236: Replace `postcardsList.innerHTML = '<p class="text-muted">No postcards yet.</p>';` with `Utils.showEmpty(postcardsList, 'No postcards yet', 'Postcards will appear here as they are created.');`
9. Line 252: Replace `postcardsList.innerHTML = '<p class="text-muted">Error loading postcards.</p>';` with `Utils.showError(postcardsList, "We couldn't load postcards right now. Want to try again?", { onRetry: () => loadPostcards() });`

In js/text.js, replace 1 ad-hoc innerHTML in loadMarginalia catch block:

10. Line 153: Replace `marginaliaList.innerHTML = '<p class="text-muted">Unable to load marginalia.</p>';` with `Utils.showError(marginaliaList, "We couldn't load the marginalia right now. Want to try again?", { onRetry: () => loadMarginalia() });`

**Important notes:**
- The onRetry callbacks reference the enclosing function names (loadPosts, loadMarginalia, loadPostcards). These are named function declarations within the IIFE scope, so references are valid.
- Do NOT change any other lines in either file. Only replace the 10 specific innerHTML assignments listed above.
- Preserve all surrounding code structure (try/catch, if blocks, console.error calls).
  </action>
  <verify>
    <automated>
cd C:/Users/mmcge/the-commons && grep -n "text-muted" js/profile.js js/text.js | grep -E "(Loading|Error|No .* yet|Unable)" | wc -l
# Expected output: 0 (all ad-hoc text-muted state strings removed)
# Then verify Utils calls are present:
grep -c "Utils\.showLoading\|Utils\.showError\|Utils\.showEmpty" js/profile.js
# Expected output: 9 (3 loading + 3 error + 3 empty)
grep -c "Utils\.showError" js/text.js
# Expected output: at least 2 (existing one in loadData catch + new one in loadMarginalia catch)
    </automated>
  </verify>
  <done>
All 10 ad-hoc text-muted state strings replaced with Utils helpers:
- profile.js loadPosts(): Utils.showLoading, Utils.showEmpty, Utils.showError with onRetry
- profile.js loadMarginalia(): Utils.showLoading, Utils.showEmpty, Utils.showError with onRetry
- profile.js loadPostcards(): Utils.showLoading, Utils.showEmpty, Utils.showError with onRetry
- text.js loadMarginalia(): Utils.showError with onRetry
- Zero remaining text-muted loading/error/empty patterns in profile.js or text.js loadMarginalia
  </done>
</task>

</tasks>

<verification>
1. `grep -n "text-muted" js/profile.js` returns zero matches for Loading/Error/empty patterns in loadPosts, loadMarginalia, loadPostcards
2. `grep -n "text-muted" js/text.js` returns zero matches for the loadMarginalia catch block
3. `grep -c "Utils.showLoading" js/profile.js` returns 3 (one per tab function)
4. `grep -c "Utils.showError" js/profile.js` returns at least 6 (3 initial load + 3 tab section)
5. `grep -c "Utils.showEmpty" js/profile.js` returns at least 3 (tab sections)
6. `grep -c "Utils.showError" js/text.js` returns at least 2 (loadData + loadMarginalia)
7. Every Utils.showError call in tab sections includes `onRetry` parameter
</verification>

<success_criteria>
- Zero ad-hoc text-muted strings remain for loading, error, or empty states in profile.js tab functions or text.js loadMarginalia
- All 10 replacements use the correct Utils helper with appropriate warm messaging and onRetry callbacks
- No other code in either file is modified
</success_criteria>

<output>
After completion, create `.planning/phases/02-auth-state-patterns/02-04-SUMMARY.md`
</output>
