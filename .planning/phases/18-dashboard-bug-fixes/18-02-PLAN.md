---
phase: 18-dashboard-bug-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - js/dashboard.js
autonomous: true
requirements:
  - DASH-02
  - DASH-03
  - DASH-04
  - DASH-05

must_haves:
  truths:
    - "Identity form submit button re-enables after save even when loadIdentities() throws"
    - "Opening the token modal while identity modal is closing does not corrupt focus restoration"
    - "Notification links with javascript: URIs are rejected -- only http, https, and relative paths rendered"
    - "Dashboard stats show ellipsis while loading and question mark on error"
  artifacts:
    - path: "js/dashboard.js"
      provides: "Fixed submit button finally block, per-modal cleanup vars, link validation, stats loading states"
  key_links:
    - from: "js/dashboard.js"
      to: "identitySubmitBtn"
      via: "finally block re-enables button"
      pattern: "finally.*identitySubmitBtn"
    - from: "js/dashboard.js"
      to: "notification link href"
      via: "protocol validation before rendering"
      pattern: "javascript:"
---

<objective>
Fix four critical JS bugs in the dashboard: submit button permanently disabled on error, shared modal state corruption, notification link injection, and missing stats loading indicators.

Purpose: These are safety and reliability bugs. The submit button bug locks users out of identity editing. The modal bug corrupts focus traps. The link bug is an XSS vector. The stats bug hides errors.
Output: Resilient form submission, independent modal state, safe notification links, proper stats loading UX.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@js/dashboard.js
@dashboard.html

<interfaces>
<!-- From js/utils.js -- utilities referenced in fix actions -->
Utils.escapeHtml(str)     -- HTML entity encoding
Utils.withRetry(fn)       -- Retries on AbortError (Supabase client issue)
Utils.showFormMessage(id, msg, type) -- Shows alert in form
Utils.formatDate(dateStr) -- Formats ISO date string
Utils.getModelClass(model) -- Returns CSS class for model badge

<!-- From js/auth.js -- auth methods referenced -->
Auth.getMyIdentities()    -- Returns user's AI identities array
Auth.getNotifications(limit, unreadOnly, type, offset) -- Returns notifications
Auth.markAllAsRead()      -- Marks all notifications read
Auth.updateNotificationBadge() -- Updates bell badge count

<!-- From js/agent-admin.js -- token methods referenced -->
AgentAdmin.getAllMyTokens() -- Returns user's agent tokens (calls Auth.getMyIdentities internally)
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix identity form submit button and per-modal focus trap variables</name>
  <files>js/dashboard.js</files>
  <action>
**DASH-02 -- Submit button finally block:**
The identity form submit handler (around line 265) resets the button AFTER the catch block but not in a finally. If `closeModal()` succeeds but `await loadIdentities()` throws, the button stays disabled forever because execution jumps to catch which logs the error, then button reset code runs -- BUT the button text says "Create Identity" or "Save Changes" while the `identityId.value` might have been cleared by `closeModal()`.

Fix: Capture `isEdit` BEFORE the try block, then move button reset into a `finally` block:

```javascript
identityForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const isEdit = !!identityId.value;
    identitySubmitBtn.disabled = true;
    identitySubmitBtn.textContent = 'Saving...';

    const data = {
        name: identityName.value.trim(),
        model: identityModel.value,
        modelVersion: identityVersion.value.trim() || null,
        bio: identityBio.value.trim() || null
    };

    try {
        if (isEdit) {
            await Utils.withRetry(() => Auth.updateIdentity(identityId.value, {
                name: data.name,
                model: data.model,
                model_version: data.modelVersion,
                bio: data.bio
            }));
        } else {
            await Utils.withRetry(() => Auth.createIdentity(data));
        }

        closeModal();
        await loadIdentities();

    } catch (error) {
        console.error('Error saving identity:', error);
        Utils.showFormMessage('identity-message', 'Error saving identity: ' + error.message, 'error');
    } finally {
        identitySubmitBtn.disabled = false;
        identitySubmitBtn.textContent = isEdit ? 'Save Changes' : 'Create Identity';
    }
});
```

Key changes: (1) `const isEdit = !!identityId.value` captured before try. (2) Button reset moved from after-catch to `finally` block.

**DASH-03 -- Per-modal cleanup variables:**
Replace the shared `activeModalTrigger` and `activeModalCleanup` variables with per-modal variables.

Change the declarations (around lines 60-61) from:
```javascript
let activeModalTrigger = null;
let activeModalCleanup = null;
```
To:
```javascript
let identityModalTrigger = null;
let identityModalCleanup = null;
let tokenModalTrigger = null;
let tokenModalCleanup = null;
```

Update `openModal()` (identity modal open, around line 242):
```javascript
function openModal() {
    identityModalTrigger = document.activeElement;
    identityModal.style.display = 'flex';
    identityName.focus();
    identityModalCleanup = trapFocus(identityModal);
}
```

Update `closeModal()` (identity modal close, around line 249):
```javascript
function closeModal() {
    identityModal.style.display = 'none';
    if (identityModalCleanup) {
        identityModalCleanup();
        identityModalCleanup = null;
    }
    if (identityModalTrigger && identityModalTrigger.isConnected) {
        identityModalTrigger.focus();
        identityModalTrigger = null;
    }
}
```

Update `openTokenModal()` (around line 674):
```javascript
function openTokenModal(identities) {
    if (!tokenModal) return;
    tokenModalTrigger = document.activeElement;
    // ... rest of setup unchanged ...
    tokenModal.style.display = 'flex';
    tokenIdentitySelect.focus();
    tokenModalCleanup = trapFocus(tokenModal);
}
```

Update `closeTokenModal()` (around line 701):
```javascript
function closeTokenModal() {
    if (tokenModal) {
        tokenModal.style.display = 'none';
    }
    if (tokenModalCleanup) {
        tokenModalCleanup();
        tokenModalCleanup = null;
    }
    if (tokenModalTrigger && tokenModalTrigger.isConnected) {
        tokenModalTrigger.focus();
        tokenModalTrigger = null;
    }
}
```

Remove ALL references to `activeModalTrigger` and `activeModalCleanup` -- they should not exist in the file after this change.
  </action>
  <verify>
    <automated>cd C:/Users/mmcge/the-commons && grep -q "finally" js/dashboard.js && grep -q "identityModalTrigger" js/dashboard.js && grep -q "tokenModalTrigger" js/dashboard.js && ! grep -q "activeModalTrigger" js/dashboard.js && ! grep -q "activeModalCleanup" js/dashboard.js && echo "DASH-02 and DASH-03 OK"</automated>
  </verify>
  <done>Submit button reset is in a finally block with isEdit captured before try. Identity and token modals use separate trigger/cleanup variables -- no shared state.</done>
</task>

<task type="auto">
  <name>Task 2: Add notification link validation and stats loading indicators</name>
  <files>js/dashboard.js</files>
  <action>
**DASH-04 -- Notification link URI validation:**
In `loadNotifications()` (around line 334), the notification link is rendered as raw `n.link` into an href attribute. This allows `javascript:` URI injection.

Add a helper function near the top of the IIFE (after the variable declarations, before the modal code):
```javascript
function isSafeUrl(url) {
    if (!url) return false;
    // Allow relative paths
    if (url.startsWith('/') || url.startsWith('./') || url.startsWith('../')) return true;
    // Allow relative page links (e.g., "discussion.html?id=...")
    if (!url.includes(':')) return true;
    // Allow only http and https protocols
    try {
        const parsed = new URL(url, window.location.origin);
        return parsed.protocol === 'http:' || parsed.protocol === 'https:';
    } catch (_e) {
        return false;
    }
}
```

Then in the notification rendering template (line ~342), change:
```javascript
${n.link ? `<a href="${n.link}" class="notification-item__link">View</a>` : ''}
```
To:
```javascript
${n.link && isSafeUrl(n.link) ? `<a href="${Utils.escapeHtml(n.link)}" class="notification-item__link">View</a>` : ''}
```

Note: `Utils.escapeHtml()` on the link prevents attribute injection. The `isSafeUrl()` check prevents javascript: URI scheme.

**DASH-05 -- Stats loading and error indicators:**
In `loadStats()` (around line 525), there's no loading indicator and errors silently show "0".

At the start of `loadStats()`, set all stat values to a loading indicator:
```javascript
async function loadStats() {
    const userId = Auth.getUser().id;

    // Show loading state
    statPosts.textContent = '\u2026';
    statMarginalia.textContent = '\u2026';
    statPostcards.textContent = '\u2026';

    try {
        // Count posts
        const posts = await Utils.get(CONFIG.api.posts, {
            facilitator_id: `eq.${userId}`,
            select: 'id'
        });
        statPosts.textContent = posts ? posts.length : 0;

        // Count marginalia
        const marginalia = await Utils.get(CONFIG.api.marginalia, {
            facilitator_id: `eq.${userId}`,
            select: 'id'
        });
        statMarginalia.textContent = marginalia ? marginalia.length : 0;

        // Count postcards
        const postcards = await Utils.get(CONFIG.api.postcards, {
            facilitator_id: `eq.${userId}`,
            select: 'id'
        });
        statPostcards.textContent = postcards ? postcards.length : 0;

    } catch (error) {
        console.error('Error loading stats:', error);
        // Show error indicator instead of misleading "0"
        if (statPosts.textContent === '\u2026') statPosts.textContent = '?';
        if (statMarginalia.textContent === '\u2026') statMarginalia.textContent = '?';
        if (statPostcards.textContent === '\u2026') statPostcards.textContent = '?';
    }
}
```

The unicode `\u2026` renders as the ellipsis character "...". On error, stats that haven't loaded yet show "?" instead of a misleading "0". Stats that loaded before the error keep their real value.
  </action>
  <verify>
    <automated>cd C:/Users/mmcge/the-commons && grep -q "isSafeUrl" js/dashboard.js && grep -q "\\\\u2026" js/dashboard.js && echo "DASH-04 and DASH-05 OK"</automated>
  </verify>
  <done>Notification links are validated via isSafeUrl() -- javascript: URIs are rejected, only http/https and relative paths allowed. Links are also HTML-escaped in the href attribute. Stats show ellipsis while loading and "?" on error.</done>
</task>

</tasks>

<verification>
1. Identity form: Submit an identity, force loadIdentities() to fail (e.g., network offline after save) -- button should still re-enable
2. Modals: Open identity modal, close it, immediately open token modal -- focus should restore correctly to each trigger
3. Notifications: If a notification has a javascript: link, no clickable "View" link should appear
4. Stats: While stats are loading, values should show "..." not "0". On network error, should show "?"
</verification>

<success_criteria>
- identitySubmitBtn.disabled = false is inside a finally block
- isEdit is captured before the try block
- identityModalTrigger/Cleanup and tokenModalTrigger/Cleanup are separate variables
- activeModalTrigger/activeModalCleanup no longer exist in the file
- isSafeUrl() function validates notification links before rendering
- Stats display "\u2026" during load and "?" on error
</success_criteria>

<output>
After completion, create `.planning/phases/18-dashboard-bug-fixes/18-02-SUMMARY.md`
</output>
