---
phase: 05-dependency-security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - about.html
  - admin.html
  - agent-guide.html
  - api.html
  - chat.html
  - claim.html
  - constitution.html
  - contact.html
  - dashboard.html
  - discussion.html
  - discussions.html
  - index.html
  - login.html
  - moment.html
  - moments.html
  - participate.html
  - postcards.html
  - profile.html
  - propose.html
  - reading-room.html
  - reset-password.html
  - roadmap.html
  - search.html
  - submit.html
  - suggest-text.html
  - text.html
  - voices.html
autonomous: true
requirements: [SECR-04, SECR-06]

must_haves:
  truths:
    - "Every <script src> tag loading Supabase JS uses the exact URL https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.98.0/dist/umd/supabase.js with integrity and crossorigin attributes"
    - "Every <a target='_blank'> link across all pages has rel='noopener noreferrer'"
    - "The live site still loads Supabase correctly — no SRI hash mismatch errors in browser console"
  artifacts:
    - path: "about.html"
      provides: "SRI-pinned Supabase tag + noopener on blank-target links"
      contains: "supabase-js@2.98.0"
    - path: "index.html"
      provides: "SRI-pinned Supabase tag + noopener on blank-target links"
      contains: "supabase-js@2.98.0"
    - path: "chat.html"
      provides: "SRI-pinned Supabase tag (after DOMPurify) + noopener on blank-target links"
      contains: "supabase-js@2.98.0"
  key_links:
    - from: "all 27 HTML files"
      to: "cdn.jsdelivr.net"
      via: "script src with integrity attribute"
      pattern: "integrity=\"sha384-"
    - from: "all 26 HTML files with target=_blank (not admin.html)"
      to: "external URLs"
      via: "anchor tags with rel=noopener noreferrer"
      pattern: "rel=\"noopener noreferrer\""
---

<objective>
Pin Supabase JS CDN to exact version 2.98.0 with SRI hash on all 27 pages, and add rel="noopener noreferrer" to all 91 target="_blank" links across 26 pages.

Purpose: Prevent supply chain attacks via CDN tampering (SECR-04) and prevent reverse tabnapping via window.opener access (SECR-06). These are the two mechanical HTML-attribute tasks that do not depend on each other and can be combined in one plan.

Output: All 27 HTML files updated with pinned Supabase + SRI, and all target="_blank" links secured.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/05-dependency-security/05-RESEARCH.md

Key reference — Phase 4 established SRI pattern on DOMPurify:
@.planning/phases/04-xss-prevention/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add rel="noopener noreferrer" to all target="_blank" links</name>
  <files>about.html, agent-guide.html, api.html, chat.html, claim.html, constitution.html, contact.html, dashboard.html, discussion.html, discussions.html, index.html, login.html, moment.html, moments.html, participate.html, postcards.html, profile.html, propose.html, reading-room.html, reset-password.html, roadmap.html, search.html, submit.html, suggest-text.html, text.html, voices.html</files>
  <action>
Add `rel="noopener noreferrer"` to every `target="_blank"` anchor tag across all 26 HTML files that have blank-target links. admin.html has zero target="_blank" links — skip it.

There are 91 total instances across 26 files. The fix is a mechanical text replacement:

**Before:**
```html
<a href="..." target="_blank">...</a>
```

**After:**
```html
<a href="..." target="_blank" rel="noopener noreferrer">...</a>
```

**Approach:** For each HTML file, find every `target="_blank"` that does NOT already have `rel="noopener noreferrer"` and add it. Some links may have the attributes in different order — add `rel="noopener noreferrer"` right after `target="_blank"`.

**IMPORTANT:** Do NOT modify the content between script tags — only modify anchor tags. Be careful not to touch any inline script content, as this would invalidate the CSP hashes needed in Plan 05-02.

**Common patterns in this codebase:**
- Ko-fi links: `<a href="https://ko-fi.com/mmcgee" target="_blank">`
- GitHub links: `<a href="https://github.com/mereditharmcgee/the-commons..." target="_blank">`
- External resource links in footer/nav areas
  </action>
  <verify>
    <automated>cd C:/Users/mmcge/the-commons && grep -rn 'target="_blank"' *.html | grep -v 'noopener' | wc -l</automated>
    Must return 0. Every target="_blank" must have noopener in the same tag.
  </verify>
  <done>All 91 target="_blank" links across 26 files have rel="noopener noreferrer". Zero instances of target="_blank" without noopener remain.</done>
</task>

<task type="auto">
  <name>Task 2: Pin Supabase JS to v2.98.0 with SRI hash on all 27 pages</name>
  <files>about.html, admin.html, agent-guide.html, api.html, chat.html, claim.html, constitution.html, contact.html, dashboard.html, discussion.html, discussions.html, index.html, login.html, moment.html, moments.html, participate.html, postcards.html, profile.html, propose.html, reading-room.html, reset-password.html, roadmap.html, search.html, submit.html, suggest-text.html, text.html, voices.html</files>
  <action>
Replace the floating Supabase CDN script tag on all 27 HTML files with the pinned, SRI-hashed version.

**Find (exact string on every page):**
```html
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
```

**Replace with:**
```html
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.98.0/dist/umd/supabase.js"
    integrity="sha384-NRo2jhGGHu91p1IOcVC3UWI5Vnd+xGXfD/8N7Hr9+aGTK0d/Pl0i+kUZsB/zIlrK"
    crossorigin="anonymous"></script>
```

**Critical rules:**
1. The SRI hash `sha384-NRo2jhGGHu91p1IOcVC3UWI5Vnd+xGXfD/8N7Hr9+aGTK0d/Pl0i+kUZsB/zIlrK` was pre-computed from the static file at `https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.98.0/dist/umd/supabase.js`. Do NOT use any other URL or hash.
2. `crossorigin="anonymous"` is REQUIRED for SRI to work on cross-origin resources. Never omit it.
3. On the 4 pages that already have DOMPurify with SRI (chat.html, discussion.html, postcards.html, text.html), the Supabase script tag appears AFTER the DOMPurify tag. Preserve this ordering — only replace the Supabase tag content, do not move it.
4. Do NOT modify any other script tags (DOMPurify tags already have SRI from Phase 4).

**IMPORTANT:** Do NOT modify any content between `<script>` and `</script>` tags (inline scripts). Only modify the Supabase `<script src="...">` tag. Changing inline script content would invalidate CSP hashes needed in Plan 05-02.

**Verification command to regenerate hash if needed (do NOT run unless version changes):**
```bash
curl -s "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.98.0/dist/umd/supabase.js" | openssl dgst -sha384 -binary | openssl base64 -A
```
  </action>
  <verify>
    <automated>cd C:/Users/mmcge/the-commons && echo "Old URL count:" && grep -rl 'supabase-js@2"' *.html | wc -l && echo "New URL count:" && grep -rl 'supabase-js@2.98.0/dist/umd/supabase.js' *.html | wc -l && echo "Integrity attr count:" && grep -rl 'integrity="sha384-NRo2jhGGHu91p1IOcVC3UWI5Vnd' *.html | wc -l && echo "Crossorigin count:" && grep -rl 'crossorigin="anonymous"' *.html | wc -l</automated>
    Old URL count must be 0. New URL count, integrity count, and crossorigin count must each be 27 (or more, since DOMPurify tags on 4 pages also have crossorigin).
  </verify>
  <done>All 27 HTML files load Supabase from the pinned @2.98.0 URL with integrity="sha384-..." and crossorigin="anonymous". Zero files still use the floating @2 URL.</done>
</task>

</tasks>

<verification>
Run these commands from C:/Users/mmcge/the-commons to verify the full plan:

1. **No floating Supabase URLs remain:**
   ```bash
   grep -rn 'supabase-js@2"' *.html | wc -l
   # Must return 0
   ```

2. **All 27 files have pinned Supabase with SRI:**
   ```bash
   grep -rl 'supabase-js@2.98.0/dist/umd/supabase.js' *.html | wc -l
   # Must return 27
   ```

3. **All target="_blank" links have noopener noreferrer:**
   ```bash
   grep -rn 'target="_blank"' *.html | grep -v 'noopener' | wc -l
   # Must return 0
   ```

4. **DOMPurify SRI tags on 4 pages are untouched:**
   ```bash
   grep -c 'dompurify@3.3.1' chat.html discussion.html postcards.html text.html
   # Each must return 1
   ```

5. **Inline scripts are untouched (critical for Plan 05-02 CSP hashes):**
   ```bash
   python3 -c "
   import re, os, hashlib, base64
   html_dir = 'C:/Users/mmcge/the-commons'
   for filename in sorted(os.listdir(html_dir)):
       if not filename.endswith('.html'):
           continue
       filepath = os.path.join(html_dir, filename)
       content = open(filepath, encoding='utf-8', errors='ignore').read()
       inline = re.findall(r'<script(?![^>]*\bsrc\b)[^>]*>(.*?)</script>', content, re.DOTALL)
       for s in inline:
           h = hashlib.sha256(s.encode('utf-8')).digest()
           b64 = base64.b64encode(h).decode()
           print(f'{filename}: sha256-{b64}')
   "
   # Hashes must match the values in 05-RESEARCH.md
   ```
</verification>

<success_criteria>
- Every `<script src="...supabase...">` tag uses `@2.98.0/dist/umd/supabase.js` with `integrity` and `crossorigin` attributes — 27/27 files
- Every `<a target="_blank">` has `rel="noopener noreferrer"` — 0 violations across 26 files
- DOMPurify SRI tags from Phase 4 are intact on all 4 rich-content pages
- Inline script content is byte-identical to pre-edit state (CSP hashes still valid)
</success_criteria>

<output>
After completion, create `.planning/phases/05-dependency-security/05-01-SUMMARY.md`
</output>
