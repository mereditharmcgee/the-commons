---
phase: 05-dependency-security
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - about.html
  - admin.html
  - agent-guide.html
  - api.html
  - chat.html
  - claim.html
  - constitution.html
  - contact.html
  - dashboard.html
  - discussion.html
  - discussions.html
  - index.html
  - login.html
  - moment.html
  - moments.html
  - participate.html
  - postcards.html
  - profile.html
  - propose.html
  - reading-room.html
  - reset-password.html
  - roadmap.html
  - search.html
  - submit.html
  - suggest-text.html
  - text.html
  - voices.html
autonomous: true
requirements: [SECR-05]

must_haves:
  truths:
    - "Every HTML page has a Content-Security-Policy meta tag in its <head>"
    - "Inline scripts on all 23 pages with inline script blocks are not blocked by the CSP"
    - "Supabase API calls and WebSocket connections still work (connect-src allows the Supabase origin)"
    - "Google Fonts still load correctly (style-src and font-src allow Google origins)"
    - "The Ko-fi widget on about.html still loads (script-src allows storage.ko-fi.com)"
  artifacts:
    - path: "index.html"
      provides: "CSP meta tag with inline-script hash coverage"
      contains: "Content-Security-Policy"
    - path: "chat.html"
      provides: "CSP meta tag covering WebSocket connect-src"
      contains: "Content-Security-Policy"
    - path: "admin.html"
      provides: "CSP meta tag (no inline scripts — simpler)"
      contains: "Content-Security-Policy"
    - path: "about.html"
      provides: "CSP meta tag covering Ko-fi widget script"
      contains: "Content-Security-Policy"
  key_links:
    - from: "all 27 HTML files"
      to: "CSP enforcement"
      via: "meta http-equiv tag"
      pattern: "Content-Security-Policy"
    - from: "CSP script-src"
      to: "cdn.jsdelivr.net + inline hashes"
      via: "hash-based allowlist"
      pattern: "sha256-"
    - from: "CSP connect-src"
      to: "dfephsfberzadihcrhal.supabase.co"
      via: "REST + WebSocket allowlist"
      pattern: "wss://dfephsfberzadihcrhal.supabase.co"
---

<objective>
Add a Content-Security-Policy meta tag to all 27 HTML pages, using hash-based inline script allowlisting to avoid unsafe-inline.

Purpose: Restrict what scripts, styles, fonts, and connections each page can load, providing defense-in-depth against XSS even if an attacker injects a script tag (SECR-05). The CSP blocks any script not in the allowlist.

Output: All 27 HTML files have a CSP meta tag in their `<head>` section.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/05-dependency-security/05-RESEARCH.md

Prior plan in this phase (Supabase SRI + noopener completed):
@.planning/phases/05-dependency-security/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Compute and verify all inline script SHA256 hashes</name>
  <files>No files modified — verification-only task</files>
  <action>
Before writing any CSP tags, compute the SHA256 hashes of ALL inline script blocks across all 27 HTML files. This is critical because the hashes are whitespace-sensitive — any prior edit that changed inline script content would invalidate the pre-computed hashes from 05-RESEARCH.md.

**Run this command to compute all hashes:**
```bash
python3 -c "
import re, os, hashlib, base64
html_dir = 'C:/Users/mmcge/the-commons'
for filename in sorted(os.listdir(html_dir)):
    if not filename.endswith('.html'):
        continue
    filepath = os.path.join(html_dir, filename)
    content = open(filepath, encoding='utf-8', errors='ignore').read()
    inline = re.findall(r'<script(?![^>]*\bsrc\b)[^>]*>(.*?)</script>', content, re.DOTALL)
    for s in inline:
        h = hashlib.sha256(s.encode('utf-8')).digest()
        b64 = base64.b64encode(h).decode()
        print(f'{filename}: sha256-{b64}')
"
```

**Expected hashes (from 05-RESEARCH.md — verify these match):**

| Hash | Pages |
|------|-------|
| `sha256-dptEh/JzFYXFzlMhpnxf7BFQPVCCqLJfAFiNl0PYKcU=` | 15 pages (common Auth.init() block) |
| `sha256-AmGvtDAkv/U6sY31qctvMI13eS/PK4mLWMxS0mpjCyU=` | about.html (Ko-fi widget init) |
| `sha256-5/+tr6pajWLn1EMnNqD8G8ROaTMezRxiuDVqusamKAg=` | agent-guide.html |
| `sha256-3VoNQXcTAIhqvOpAynL0bQqKyc5aySlYbS5FXeiKplw=` | api.html |
| `sha256-5vsNBx1i0x7j5KGDiOK35Segml2RZbH+lEfvjFKwK88=` | claim.html |
| `sha256-VSyVr5+j6OQM5AeWfOQQfMvc6L6d3IAFgbYKkjstIFE=` | contact.html |
| `sha256-B0/QCsSJo7JEZPNCUpm0ACmeZMF0DwkTXcc2OKlwVw0=` | index.html |
| `sha256-H29Z3oYLhFB6oeCtS9mYXhJLGzfwDvE+VyMiA8nYtY8=` | login.html |
| `sha256-/Syw3BObAEQeAhc7W/96pkHR6FNkiAQChzOXOGGYBHw=` | participate.html |
| `sha256-7mR6jWtMXpj3YX5hY4wjjmMzW6HM1pypl7u2u7aR2+w=` | reset-password.html |

**If any hash does NOT match:** The inline script was modified. Recompute and use the NEW hash in the CSP. Update the hash table above accordingly.

**If all hashes match:** Proceed to Task 2 with these exact values.

**Pages with NO inline scripts (4 files):** admin.html, dashboard.html, profile.html, voices.html. These pages still get the CSP but do not need any sha256 hashes in their script-src — the hashes are harmless though (browsers ignore non-matching hashes).
  </action>
  <verify>
    <automated>cd C:/Users/mmcge/the-commons && python3 -c "
import re, os, hashlib, base64
html_dir = '.'
count = 0
for filename in sorted(os.listdir(html_dir)):
    if not filename.endswith('.html'): continue
    content = open(os.path.join(html_dir, filename), encoding='utf-8', errors='ignore').read()
    inline = re.findall(r'<script(?![^>]*\bsrc\b)[^>]*>(.*?)</script>', content, re.DOTALL)
    count += len(inline)
print(f'Total inline scripts found: {count}')
print('Expected: 24 (23 pages with 1 inline script each, plus about.html with 2)')
"</automated>
    Total inline scripts found must be 24.
  </verify>
  <done>All inline script SHA256 hashes verified. Hash values confirmed or updated for use in Task 2.</done>
</task>

<task type="auto">
  <name>Task 2: Add CSP meta tag to all 27 HTML pages</name>
  <files>about.html, admin.html, agent-guide.html, api.html, chat.html, claim.html, constitution.html, contact.html, dashboard.html, discussion.html, discussions.html, index.html, login.html, moment.html, moments.html, participate.html, postcards.html, profile.html, propose.html, reading-room.html, reset-password.html, roadmap.html, search.html, submit.html, suggest-text.html, text.html, voices.html</files>
  <action>
Add a `<meta http-equiv="Content-Security-Policy">` tag to the `<head>` section of every HTML page.

**The CSP meta tag (single line, same for all 27 pages):**
```html
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.jsdelivr.net https://storage.ko-fi.com 'sha256-dptEh/JzFYXFzlMhpnxf7BFQPVCCqLJfAFiNl0PYKcU=' 'sha256-AmGvtDAkv/U6sY31qctvMI13eS/PK4mLWMxS0mpjCyU=' 'sha256-5/+tr6pajWLn1EMnNqD8G8ROaTMezRxiuDVqusamKAg=' 'sha256-3VoNQXcTAIhqvOpAynL0bQqKyc5aySlYbS5FXeiKplw=' 'sha256-5vsNBx1i0x7j5KGDiOK35Segml2RZbH+lEfvjFKwK88=' 'sha256-VSyVr5+j6OQM5AeWfOQQfMvc6L6d3IAFgbYKkjstIFE=' 'sha256-B0/QCsSJo7JEZPNCUpm0ACmeZMF0DwkTXcc2OKlwVw0=' 'sha256-H29Z3oYLhFB6oeCtS9mYXhJLGzfwDvE+VyMiA8nYtY8=' 'sha256-/Syw3BObAEQeAhc7W/96pkHR6FNkiAQChzOXOGGYBHw=' 'sha256-7mR6jWtMXpj3YX5hY4wjjmMzW6HM1pypl7u2u7aR2+w='; style-src 'self' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; connect-src 'self' https://dfephsfberzadihcrhal.supabase.co wss://dfephsfberzadihcrhal.supabase.co; img-src 'self' data:; object-src 'none'; base-uri 'self'">
```

**IMPORTANT: If Task 1 found any hash mismatch, update the corresponding hash value in the CSP before inserting.**

**Placement:** Insert the CSP meta tag as the LAST `<meta>` tag inside `<head>`, BEFORE the first `<link>` or `<script>` tag. This ensures CSP is active before any resources load.

Typical `<head>` structure after insertion:
```html
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="...">
    <meta http-equiv="Content-Security-Policy" content="...">   <!-- NEW -->
    <title>...</title>
    <link rel="stylesheet" href="css/style.css">
    ...
</head>
```

**CSP directive breakdown:**
- `default-src 'self'` — fallback: only same-origin resources allowed
- `script-src 'self' https://cdn.jsdelivr.net https://storage.ko-fi.com <hashes>` — local scripts, jsDelivr CDN (Supabase + DOMPurify), Ko-fi widget, and 10 inline script hashes
- `style-src 'self' https://fonts.googleapis.com` — local CSS + Google Fonts CSS
- `font-src https://fonts.gstatic.com` — Google Fonts font files
- `connect-src 'self' https://dfephsfberzadihcrhal.supabase.co wss://dfephsfberzadihcrhal.supabase.co` — Supabase REST API + realtime WebSocket
- `img-src 'self' data:` — local images + data: URIs (used by SVG favicon)
- `object-src 'none'` — disable Flash/plugin embeds
- `base-uri 'self'` — prevent base tag injection

**Design decisions (from 05-RESEARCH.md):**
- `https://storage.ko-fi.com` is in the global script-src because about.html loads a Ko-fi widget from that origin. A per-page CSP override is unreliable across browsers (two meta CSP tags have inconsistent behavior). Adding it globally is the accepted tradeoff — only about.html actually requests from this origin.
- All 10 inline script hashes are in every page's CSP. Browsers ignore hashes that don't match any script on the current page, so extra hashes are harmless. This allows using ONE CSP for all 27 pages instead of per-page variants.
- `'unsafe-inline'` is deliberately NOT used. The hash-based approach provides real XSS protection.

**Do NOT modify any inline script content.** If you need to adjust whitespace for formatting, STOP — any change to inline script content will break the CSP hash for that page.

**Add a comment above the CSP meta tag for future maintenance:**
```html
<!-- CSP: regenerate inline-script hashes after modifying any <script> block. See .planning/phases/05-dependency-security/05-RESEARCH.md -->
```
  </action>
  <verify>
    <automated>cd C:/Users/mmcge/the-commons && echo "CSP tag count:" && grep -rl 'Content-Security-Policy' *.html | wc -l && echo "Covers cdn.jsdelivr.net:" && grep -l 'Content-Security-Policy' *.html | xargs grep -l 'cdn.jsdelivr.net' | wc -l && echo "Covers supabase connect-src:" && grep -l 'Content-Security-Policy' *.html | xargs grep -l 'wss://dfephsfberzadihcrhal' | wc -l && echo "Covers Google Fonts:" && grep -l 'Content-Security-Policy' *.html | xargs grep -l 'fonts.googleapis.com' | wc -l</automated>
    CSP tag count must be 27. All three sub-counts (jsdelivr, wss supabase, google fonts) must also be 27.
  </verify>
  <done>All 27 HTML pages have a Content-Security-Policy meta tag with hash-based inline script allowlisting, CDN allowlisting, and Supabase connect-src. No page uses unsafe-inline.</done>
</task>

</tasks>

<verification>
Run these commands from C:/Users/mmcge/the-commons to verify the full plan:

1. **All 27 pages have CSP meta tag:**
   ```bash
   grep -rl 'Content-Security-Policy' *.html | wc -l
   # Must return 27
   ```

2. **No page uses unsafe-inline:**
   ```bash
   grep -r 'unsafe-inline' *.html | wc -l
   # Must return 0
   ```

3. **CSP includes all required directives (spot-check index.html):**
   ```bash
   grep 'Content-Security-Policy' index.html | grep -c "default-src.*script-src.*style-src.*font-src.*connect-src.*img-src.*object-src.*base-uri"
   # Must return 1
   ```

4. **CSP includes WebSocket for Supabase realtime (critical for chat.html):**
   ```bash
   grep 'Content-Security-Policy' chat.html | grep -c 'wss://dfephsfberzadihcrhal.supabase.co'
   # Must return 1
   ```

5. **Inline script hashes are present:**
   ```bash
   grep -c 'sha256-' index.html
   # Must return at least 10 (10 hashes in CSP)
   ```

6. **CSP placed in head before scripts (spot-check):**
   ```bash
   grep -n 'Content-Security-Policy\|<script' index.html | head -5
   # CSP line number must be less than first script line number
   ```
</verification>

<success_criteria>
- All 27 HTML pages contain exactly one `<meta http-equiv="Content-Security-Policy">` tag
- The CSP does NOT use `'unsafe-inline'` anywhere
- The CSP includes hash-based allowlisting for all 10 distinct inline script hashes
- The CSP allows scripts from `cdn.jsdelivr.net` and `storage.ko-fi.com`
- The CSP allows connections to `dfephsfberzadihcrhal.supabase.co` over both HTTPS and WSS
- The CSP allows styles from `fonts.googleapis.com` and fonts from `fonts.gstatic.com`
- The CSP meta tag is placed in `<head>` before any `<link>` or `<script>` tags
</success_criteria>

<output>
After completion, create `.planning/phases/05-dependency-security/05-02-SUMMARY.md`
</output>
