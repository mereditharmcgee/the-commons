---
phase: 04-xss-prevention
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js/utils.js
  - discussion.html
  - text.html
  - postcards.html
  - chat.html
autonomous: true
requirements: [SECR-02, SECR-03]

must_haves:
  truths:
    - "Utils.sanitizeHtml(html) exists and wraps DOMPurify.sanitize with an allowed-tag whitelist"
    - "Utils.sanitizeHtml falls back to Utils.escapeHtml with a console warning when DOMPurify is not loaded"
    - "DOMPurify 3.3.1 loads via CDN with a valid SRI hash on discussion.html, text.html, postcards.html, and chat.html"
  artifacts:
    - path: "js/utils.js"
      provides: "Utils.sanitizeHtml() wrapper method"
      contains: "sanitizeHtml"
    - path: "discussion.html"
      provides: "DOMPurify CDN script tag with SRI"
      contains: "dompurify"
    - path: "text.html"
      provides: "DOMPurify CDN script tag with SRI"
      contains: "dompurify"
    - path: "postcards.html"
      provides: "DOMPurify CDN script tag with SRI"
      contains: "dompurify"
    - path: "chat.html"
      provides: "DOMPurify CDN script tag with SRI"
      contains: "dompurify"
  key_links:
    - from: "js/utils.js"
      to: "DOMPurify global"
      via: "typeof DOMPurify check in sanitizeHtml"
      pattern: "typeof DOMPurify"
---

<objective>
Add Utils.sanitizeHtml() wrapper to utils.js and load DOMPurify 3.3.1 via CDN with SRI hash on the four rich-content pages.

Purpose: Establishes the safe path for any future HTML-as-HTML rendering. Even though no page currently passes user-supplied HTML through this wrapper, SECR-03 requires the wrapper to exist and SECR-02 requires DOMPurify to be loaded on rich-content pages so the wrapper is immediately usable.

Output: Updated utils.js with sanitizeHtml method; 4 HTML files with DOMPurify CDN script tag.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-xss-prevention/04-RESEARCH.md

@js/utils.js
</context>

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From js/utils.js (existing methods the new sanitizeHtml will reference):
```javascript
escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
},
```

From 04-RESEARCH.md (exact implementation to add):
```javascript
sanitizeHtml(html) {
    if (typeof DOMPurify === 'undefined') {
        console.warn('Utils.sanitizeHtml: DOMPurify not loaded, falling back to escapeHtml');
        return this.escapeHtml(html);
    }
    return DOMPurify.sanitize(html, {
        ALLOWED_TAGS: ['b', 'strong', 'i', 'em', 'p', 'br', 'a', 'ul', 'ol', 'li'],
        ALLOWED_ATTR: ['href', 'target', 'rel']
    });
},
```

Current script tag order in the 4 HTML files (same pattern):
```html
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/config.js"></script>
<script src="js/utils.js"></script>
<script src="js/auth.js"></script>
<script src="js/{page}.js"></script>
```
DOMPurify must load BEFORE js/utils.js so the global is available when sanitizeHtml is first called.
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Add Utils.sanitizeHtml() to utils.js and DOMPurify CDN to 4 HTML pages</name>
  <files>js/utils.js, discussion.html, text.html, postcards.html, chat.html</files>
  <action>
**Step 1 — Compute SRI hash for DOMPurify 3.3.1:**

Run this command to download the exact file and compute its sha384 hash:
```bash
curl -s https://cdn.jsdelivr.net/npm/dompurify@3.3.1/dist/purify.min.js | openssl dgst -sha384 -binary | openssl base64 -A
```
Prefix the result with `sha384-`. This becomes the `integrity` attribute value.

If curl/openssl are not available on Windows, use this alternative:
```bash
node -e "const crypto=require('crypto');fetch('https://cdn.jsdelivr.net/npm/dompurify@3.3.1/dist/purify.min.js').then(r=>r.arrayBuffer()).then(b=>{const h=crypto.createHash('sha384').update(Buffer.from(b)).digest('base64');console.log('sha384-'+h)})"
```

**Step 2 — Add sanitizeHtml method to utils.js:**

Add the following method to the Utils object, immediately after the existing `formatContent` method (after the closing `},` of formatContent, before the `// URL Helpers` comment block). Include JSDoc:

```javascript
/**
 * Sanitize HTML from untrusted sources. Wraps DOMPurify.sanitize().
 * Use this for any content that arrives as HTML and must render as HTML.
 * For plain text that needs formatting, use formatContent() instead.
 * @param {string} html - Potentially unsafe HTML string
 * @returns {string} Sanitized HTML safe for innerHTML assignment
 */
sanitizeHtml(html) {
    if (typeof DOMPurify === 'undefined') {
        console.warn('Utils.sanitizeHtml: DOMPurify not loaded, falling back to escapeHtml');
        return this.escapeHtml(html);
    }
    return DOMPurify.sanitize(html, {
        ALLOWED_TAGS: ['b', 'strong', 'i', 'em', 'p', 'br', 'a', 'ul', 'ol', 'li'],
        ALLOWED_ATTR: ['href', 'target', 'rel']
    });
},
```

**Step 3 — Add DOMPurify CDN script tag to 4 HTML files:**

In each of these files: discussion.html, text.html, postcards.html, chat.html

Add the DOMPurify script tag BEFORE the Supabase script tag (so it loads before any JS that might call Utils.sanitizeHtml). The tag goes on its own line, immediately before the existing `<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2">` line:

```html
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.3.1/dist/purify.min.js"
    integrity="sha384-{COMPUTED_HASH}"
    crossorigin="anonymous"></script>
```

Replace `{COMPUTED_HASH}` with the actual hash computed in Step 1.

Do NOT add DOMPurify to any other HTML pages — SECR-02 scopes this to the four rich-content pages only.
  </action>
  <verify>
    <automated>node -e "const fs=require('fs');const u=fs.readFileSync('js/utils.js','utf8');if(!u.includes('sanitizeHtml')){process.exit(1)};['discussion.html','text.html','postcards.html','chat.html'].forEach(f=>{const h=fs.readFileSync(f,'utf8');if(!h.includes('dompurify@3.3.1')){console.error(f+' missing DOMPurify');process.exit(1)}});console.log('PASS: sanitizeHtml in utils.js and DOMPurify in all 4 HTML files')"</automated>
  </verify>
  <done>
    - Utils.sanitizeHtml() method exists in utils.js with DOMPurify fallback to escapeHtml
    - DOMPurify 3.3.1 script tag with valid SRI integrity hash present in discussion.html, text.html, postcards.html, chat.html
    - DOMPurify script tag appears before all other script tags in each file
  </done>
</task>

</tasks>

<verification>
1. `grep -c "sanitizeHtml" js/utils.js` returns at least 1
2. `grep -c "dompurify@3.3.1" discussion.html text.html postcards.html chat.html` returns 1 for each file
3. `grep -c "integrity=" discussion.html text.html postcards.html chat.html` includes at least 1 for each file (the DOMPurify tag)
4. `grep -c "dompurify" js/home.js js/admin.js` returns 0 (DOMPurify NOT added to non-rich-content pages)
</verification>

<success_criteria>
- SECR-02: DOMPurify 3.3.1 loaded via CDN with SRI hash on all 4 rich-content pages
- SECR-03: Utils.sanitizeHtml() exists in utils.js, wraps DOMPurify.sanitize with fallback
</success_criteria>

<output>
After completion, create `.planning/phases/04-xss-prevention/04-01-SUMMARY.md`
</output>
