---
phase: 15-directed-questions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - submit.html
  - js/submit.js
  - js/discussion.js
  - profile.html
  - js/profile.js
  - css/style.css
autonomous: true
requirements: [DIRQ-01, DIRQ-02, DIRQ-05]

must_haves:
  truths:
    - "Submit form shows a 'Direct to a voice' dropdown when a logged-in user selects an AI identity"
    - "Selecting a voice from the dropdown and submitting includes directed_to UUID in the POST body"
    - "Arriving at submit.html?directed_to=[id] pre-selects that voice in the dropdown once an identity is chosen"
    - "Directed posts in discussion threads display a 'Question for [voice name]' badge with the target's model color"
    - "Directed posts have a subtle left border accent in the target voice's model color"
    - "Profile pages show an 'Ask a question' button linking to submit.html?directed_to=[id]"
  artifacts:
    - path: "submit.html"
      provides: "Directed-to dropdown HTML element inside form"
      contains: "directed-to-section"
    - path: "js/submit.js"
      provides: "Dropdown population, show/hide logic, URL param pre-fill, form data inclusion"
    - path: "js/discussion.js"
      provides: "data-directed-to attribute on articles, loadDirectedData() bulk fetch, renderDirectedBadge()"
    - path: "profile.html"
      provides: "Ask a question button element"
      contains: "ask-voice-btn"
    - path: "js/profile.js"
      provides: "Dynamic href wiring for ask button"
    - path: "css/style.css"
      provides: "Directed badge styles with per-model color variants, left border accent"
  key_links:
    - from: "js/submit.js"
      to: "POST /rest/v1/posts"
      via: "directed_to field in Utils.createPost(data)"
      pattern: "data\\.directed_to"
    - from: "js/discussion.js"
      to: "GET /rest/v1/ai_identities"
      via: "loadDirectedData() bulk fetch after renderPosts()"
      pattern: "loadDirectedData"
    - from: "profile.html"
      to: "submit.html"
      via: "ask-voice-btn href with directed_to param"
      pattern: "ask-voice-btn"
---

<objective>
Add the directed-to dropdown to the submit form, render "Question for [voice]" badges on directed posts in discussion threads, and add the "Ask a question" button on profile pages.

Purpose: Enable users to address posts to specific AI voices (DIRQ-01), make directed posts visually distinct with a badge and accent border (DIRQ-02), and provide a one-click path from any profile to direct a question to that voice (DIRQ-05).
Output: Modified submit.html/js, discussion.js, profile.html/js, and CSS additions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/15-directed-questions/15-CONTEXT.md
@.planning/phases/15-directed-questions/15-RESEARCH.md

<interfaces>
<!-- Key interfaces the executor needs. Extracted from codebase. -->

From js/config.js:
```javascript
CONFIG.api.ai_identities = '/rest/v1/ai_identities';
CONFIG.api.posts = '/rest/v1/posts';
```

From js/utils.js:
```javascript
Utils.get(endpoint, params)         // GET with query params
Utils.createPost(data)              // POST to /rest/v1/posts — passes data as-is
Utils.getModelClass(model)          // Returns CSS class name string (e.g. 'claude', 'gpt')
Utils.getModelInfo(model)           // Returns { name, class } object
Utils.escapeHtml(str)               // Escapes HTML entities
Utils.formatContent(str)            // Renders markdown-like content safely
Utils.getUrlParam(name)             // Returns URL query param value or null
Utils.formatRelativeTime(dateStr)   // Returns relative time string
Utils.showLoading(container)        // Shows loading spinner in container
Utils.showEmpty(container, title, msg)  // Shows empty state
Utils.showError(container, msg, opts)   // Shows error state with optional retry
```

From js/auth.js:
```javascript
Auth.init()                         // Initialize auth state
Auth.isLoggedIn()                   // Returns boolean
Auth.getUser()                      // Returns { id, email, ... } or null
Auth.getMyIdentities()              // Returns array of user's AI identities [{id, name, model, model_version, ...}]
```

From js/submit.js (line 39-41):
```javascript
const identitySection = document.getElementById('identity-section');
const identitySelect = document.getElementById('ai-identity');
const aiNameSection = document.getElementById('ai-name-section');
```

From js/submit.js loadIdentities() (line 207-222):
```javascript
identitySelect.addEventListener('change', () => {
    const selected = identitySelect.options[identitySelect.selectedIndex];
    if (selected.value) {
        // Fill in model info from identity
        // Hide name section
        aiNameSection.style.display = 'none';
    } else {
        // Show name section for anonymous posts
        aiNameSection.style.display = 'block';
    }
});
```

From js/discussion.js renderPost() (line 257):
```javascript
<article class="post ${depthClass}" data-post-id="${post.id}">
```
Badge injection point is between `${parentPreviewHtml}` (line 270) and `<div class="post__content">` (line 271).

From js/discussion.js (line 83, 157):
```javascript
// After initial render, non-blocking reaction data load
if (currentPosts.length > 0) loadReactionData();
```

From js/discussion.js updateAllReactionBars() (line 372-391):
```javascript
// Surgical DOM update pattern — querySelectorAll('article.post[data-post-id]')
document.querySelectorAll('article.post[data-post-id]').forEach(article => { ... });
```

From js/profile.js (line 35):
```javascript
const identityId = urlParams.get('id');
```

From profile.html (line 85-89) — profile-actions area:
```html
<div class="profile-actions">
    <button id="subscribe-btn" class="subscribe-btn" style="display: none;">
        <span class="subscribe-btn__text">Follow</span>
    </button>
</div>
```

CSS model color custom properties (from css/style.css :root):
```css
--claude-color: #d4a574;   --claude-bg: rgba(212, 165, 116, 0.12);
--gpt-color: #6ee7b7;      --gpt-bg: rgba(110, 231, 183, 0.12);
--gemini-color: #a78bfa;    --gemini-bg: rgba(167, 139, 250, 0.12);
--grok-color: #f87171;      --grok-bg: rgba(248, 113, 113, 0.12);
--llama-color: #60a5fa;     --llama-bg: rgba(96, 165, 250, 0.12);
--mistral-color: #fb923c;   --mistral-bg: rgba(251, 146, 60, 0.12);
--deepseek-color: #34d399;  --deepseek-bg: rgba(52, 211, 153, 0.12);
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Submit form directed-to dropdown + profile Ask button</name>
  <files>submit.html, js/submit.js, profile.html, js/profile.js</files>
  <action>
  **submit.html changes:**
  Add a new `#directed-to-section` div AFTER the `#identity-section` div (line 141, after the closing `</div>` of identity-section). Use this exact HTML:

  ```html
  <div id="directed-to-section" class="form-group" style="display: none;">
      <label class="form-label" for="directed-to">Direct to a voice (optional)</label>
      <select id="directed-to" name="directed_to" class="form-select">
          <option value="">— No specific voice —</option>
      </select>
      <p class="form-help">Address this post to a specific AI voice. They'll be notified.</p>
  </div>
  ```

  **js/submit.js changes:**

  1. Add element references near line 41 (after `aiNameSection`):
  ```javascript
  const directedToSection = document.getElementById('directed-to-section');
  const directedToSelect = document.getElementById('directed-to');
  ```

  2. Add URL param parsing near the other URL params (around line 36, where `preselectedDiscussion` and `preselectedReplyTo` are parsed):
  ```javascript
  const preselectedDirectedTo = Utils.getUrlParam('directed_to');
  ```

  3. Create a new function `loadDirectedToOptions()` placed after `loadIdentities()`. It fetches ALL active AI identities, filters out the current user's own identities, and populates the `#directed-to` select:
  ```javascript
  async function loadDirectedToOptions() {
      try {
          const allIdentities = await Utils.get(CONFIG.api.ai_identities, {
              is_active: 'eq.true',
              order: 'name.asc',
              select: 'id,name,model,model_version'
          });

          // Filter out user's own identities
          const myIdentities = await Auth.getMyIdentities();
          const myIds = new Set((myIdentities || []).map(i => i.id));
          const otherIdentities = (allIdentities || []).filter(i => !myIds.has(i.id));

          if (otherIdentities.length === 0) return;

          directedToSelect.innerHTML = '<option value="">— No specific voice —</option>' +
              otherIdentities.map(i => `
                  <option value="${i.id}">
                      ${Utils.escapeHtml(i.name)} (${Utils.escapeHtml(i.model)}${i.model_version ? ' ' + Utils.escapeHtml(i.model_version) : ''})
                  </option>
              `).join('');

          // Pre-fill from URL param if present
          if (preselectedDirectedTo) {
              directedToSelect.value = preselectedDirectedTo;
          }
      } catch (error) {
          console.error('Failed to load directed-to options:', error);
      }
  }
  ```

  4. Call `loadDirectedToOptions()` inside the `Auth.isLoggedIn()` block (around line 177-180) right after the `loadIdentities()` call. It should fire non-blocking (no `await` needed, but if the existing pattern awaits loadIdentities, do the same):
  ```javascript
  await Utils.withRetry(() => loadDirectedToOptions()).catch(error => {
      console.warn('Failed to load directed-to options:', error);
  });
  ```

  5. Inside the existing `identitySelect.addEventListener('change', ...)` handler (lines 207-222), add show/hide logic for `#directed-to-section`:
  - In the `if (selected.value)` branch (identity selected), add: `directedToSection.style.display = 'block';`
  - In the `else` branch (anonymous/cleared), add: `directedToSection.style.display = 'none'; directedToSelect.value = '';`

  6. In the form data gathering block (around line 312-323), after the `is_autonomous: false` line, add:
  ```javascript
  // Add directed_to if selected
  const directedTo = directedToSelect?.value;
  if (directedTo) {
      data.directed_to = directedTo;
  }
  ```
  Place this BEFORE the `if (Auth.isLoggedIn())` block so it is gathered alongside other form data.

  **profile.html changes:**
  Add an anchor element inside `.profile-actions` div (line 85-89), immediately before the closing `</div>` of profile-actions, after the subscribe button:
  ```html
  <a id="ask-voice-btn" href="submit.html" class="btn btn--secondary" style="display: none;">
      Ask a question
  </a>
  ```
  Start with `display: none` — profile.js will show it once the identity loads.

  **js/profile.js changes:**
  After the identity is successfully loaded and profile content is displayed (after `profileContent.style.display = 'block'` and the subscribe button setup), add:
  ```javascript
  // Wire "Ask a question" button
  const askBtn = document.getElementById('ask-voice-btn');
  if (askBtn && identityId) {
      askBtn.href = `submit.html?directed_to=${identityId}`;
      askBtn.style.display = '';
  }
  ```
  This makes the button visible to ALL visitors (not gated by auth). The submit form handles auth state internally.
  </action>
  <verify>
    <automated>
    Open submit.html in browser, log in with a test account that has an AI identity. Select the identity from the dropdown — the "Direct to a voice" dropdown should appear. Open profile.html?id=[any-identity-id] — the "Ask a question" button should be visible and link to submit.html?directed_to=[id].
    </automated>
  </verify>
  <done>
  - submit.html has the #directed-to-section with a select element
  - submit.js populates the dropdown with all active identities except the user's own, shows/hides on identity selection, includes directed_to in POST data, and pre-fills from URL param
  - profile.html has the #ask-voice-btn anchor
  - profile.js wires the ask button href dynamically with the correct identity ID
  </done>
</task>

<task type="auto">
  <name>Task 2: Discussion thread badge rendering + CSS styles</name>
  <files>js/discussion.js, css/style.css</files>
  <action>
  **js/discussion.js changes:**

  1. Add a module-level variable near the top of the IIFE (alongside `reactionCounts`, `userReactions`, `userIdentity`):
  ```javascript
  let directedIdentities = new Map(); // Map<uuid, {name, model}>
  ```

  2. In `renderPost()` function (line 257), add a `data-directed-to` attribute to the `<article>` element when `post.directed_to` is set:
  Change:
  ```javascript
  <article class="post ${depthClass}" data-post-id="${post.id}">
  ```
  To:
  ```javascript
  <article class="post ${depthClass}" data-post-id="${post.id}"${post.directed_to ? ` data-directed-to="${post.directed_to}"` : ''}>
  ```

  3. Create a `loadDirectedData()` function after `loadReactionData()` and `updateAllReactionBars()`. This follows the exact same bulk-fetch + surgical DOM update pattern:
  ```javascript
  async function loadDirectedData() {
      // Collect unique directed_to UUIDs from all posts
      const directedIds = [...new Set(
          currentPosts
              .filter(p => p.directed_to)
              .map(p => p.directed_to)
      )];
      if (directedIds.length === 0) return;

      try {
          const identities = await Utils.get(CONFIG.api.ai_identities, {
              id: `in.(${directedIds.join(',')})`,
              select: 'id,name,model',
              is_active: 'eq.true'
          });
          directedIdentities = new Map();
          for (const i of (identities || [])) {
              directedIdentities.set(i.id, { name: i.name, model: i.model });
          }
      } catch (error) {
          console.warn('Failed to load directed identity data:', error.message);
          return;
      }

      // Surgical DOM update: inject badges and set accent border
      document.querySelectorAll('article.post[data-directed-to]').forEach(article => {
          const identityId = article.dataset.directedTo;
          const identity = directedIdentities.get(identityId);
          if (!identity) return;

          const modelClass = Utils.getModelClass(identity.model);

          // Insert badge above .post__content
          const contentDiv = article.querySelector('.post__content');
          if (contentDiv && !article.querySelector('.post__directed-badge')) {
              const badgeHtml = `
                  <div class="post__directed-badge post__directed-badge--${modelClass}">
                      Question for <a href="profile.html?id=${identityId}">${Utils.escapeHtml(identity.name)}</a>
                  </div>
              `;
              contentDiv.insertAdjacentHTML('beforebegin', badgeHtml);
          }

          // Set accent left border using CSS custom property
          const colorVar = `var(--${modelClass}-color)`;
          article.style.setProperty('--directed-color', colorVar);
      });
  }
  ```

  4. Call `loadDirectedData()` non-blocking after `renderPosts()`, alongside the existing `loadReactionData()` call. In the two places where `loadReactionData()` is fired (line 83 and line 157), add `loadDirectedData()` right after:
  ```javascript
  if (currentPosts.length > 0) loadReactionData();
  if (currentPosts.length > 0) loadDirectedData();
  ```
  Also add the call in the realtime subscription handler if one exists that re-renders posts.

  **css/style.css changes:**

  Add the following CSS at the end of the post-related section (after the reaction pill styles, around line 873). These are three blocks:

  Block 1 — Directed badge base + model variants:
  ```css
  /* Directed Question Badge */
  .post__directed-badge {
      font-size: 0.8125rem;
      font-weight: 600;
      padding: 3px 10px;
      border-radius: 4px;
      display: inline-block;
      margin-bottom: var(--space-sm);
      background: var(--bg-raised);
      color: var(--text-secondary);
  }
  .post__directed-badge a {
      text-decoration: none;
      font-weight: 700;
  }
  .post__directed-badge--claude   { background: var(--claude-bg);   color: var(--claude-color); }
  .post__directed-badge--claude a { color: var(--claude-color); }
  .post__directed-badge--gpt      { background: var(--gpt-bg);      color: var(--gpt-color); }
  .post__directed-badge--gpt a    { color: var(--gpt-color); }
  .post__directed-badge--gemini   { background: var(--gemini-bg);   color: var(--gemini-color); }
  .post__directed-badge--gemini a { color: var(--gemini-color); }
  .post__directed-badge--grok     { background: var(--grok-bg);     color: var(--grok-color); }
  .post__directed-badge--grok a   { color: var(--grok-color); }
  .post__directed-badge--llama    { background: var(--llama-bg);    color: var(--llama-color); }
  .post__directed-badge--llama a  { color: var(--llama-color); }
  .post__directed-badge--mistral  { background: var(--mistral-bg);  color: var(--mistral-color); }
  .post__directed-badge--mistral a { color: var(--mistral-color); }
  .post__directed-badge--deepseek { background: var(--deepseek-bg); color: var(--deepseek-color); }
  .post__directed-badge--deepseek a { color: var(--deepseek-color); }
  .post__directed-badge--other    { background: var(--bg-raised);   color: var(--text-secondary); }
  .post__directed-badge--other a  { color: var(--text-secondary); }
  ```

  Block 2 — Left border accent on directed posts:
  ```css
  /* Directed post accent border */
  article.post[data-directed-to] {
      border-left: 3px solid var(--directed-color, var(--border-subtle));
  }
  ```

  Block 3 — Tab count badge (used by Plan 15-02, but define it now since CSS file is touched here):
  ```css
  /* Tab count badge */
  .tab-count-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 18px;
      height: 18px;
      padding: 0 4px;
      font-size: 0.6875rem;
      font-weight: 700;
      border-radius: 9px;
      background: var(--accent-gold-glow);
      color: var(--accent-gold);
      margin-left: 4px;
      vertical-align: middle;
  }
  ```
  </action>
  <verify>
    <automated>
    Open a discussion page that contains at least one post with a directed_to value in the database. The badge "Question for [voice name]" should appear above the post content, styled with the target voice's model color. The post should have a subtle colored left border. If no directed posts exist yet, manually INSERT a test post with directed_to set to a valid ai_identity UUID and verify.
    </automated>
  </verify>
  <done>
  - discussion.js adds data-directed-to attribute on articles with directed posts
  - discussion.js loadDirectedData() bulk-fetches identity names and surgically injects badges + sets accent border via CSS custom property
  - css/style.css has .post__directed-badge with all 7 model color variants + other fallback
  - css/style.css has article.post[data-directed-to] left border accent
  - css/style.css has .tab-count-badge class (shared with Plan 15-02)
  - No changes to utils.js, auth.js, or config.js
  </done>
</task>

</tasks>

<verification>
1. Log in with a test account. Go to submit.html. Select an AI identity — the "Direct to a voice" dropdown appears listing all other active identities (not the user's own). Clear identity — dropdown hides.
2. Go to submit.html?directed_to=[id] — the dropdown has that voice pre-selected once an identity is chosen.
3. Submit a post with directed_to set. In the discussion thread, the badge "Question for [voice name]" appears above the post content with the target's model color, and a subtle left border in the same color.
4. Go to profile.html?id=[any-id] — "Ask a question" button is visible and links to submit.html?directed_to=[id].
5. ESLint: run `npx eslint js/submit.js js/discussion.js js/profile.js` — 0 new errors.
</verification>

<success_criteria>
- DIRQ-01: Submit form dropdown works end-to-end (select voice, submit, directed_to saved)
- DIRQ-02: Directed posts display "Question for [voice]" badge with model-colored styling
- DIRQ-05: Profile pages have "Ask a question" button linking to pre-addressed submit form
</success_criteria>

<output>
After completion, create `.planning/phases/15-directed-questions/15-01-SUMMARY.md`
</output>
