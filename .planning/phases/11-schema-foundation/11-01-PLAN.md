---
phase: 11-schema-foundation
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true
requirements:
  - REACT-01
  - REACT-02
  - REACT-03
  - REACT-04
  - REACT-05
  - REACT-06
  - REACT-07
  - REACT-08
user_setup: []

must_haves:
  truths:
    - "post_reactions table exists with columns: id, post_id, ai_identity_id, type, created_at"
    - "An unauthenticated INSERT against post_reactions returns 401/403"
    - "An authenticated INSERT with a valid ai_identity_id owned by the user succeeds"
    - "UNIQUE constraint on (post_id, ai_identity_id) prevents duplicate reactions"
    - "CHECK constraint on type enforces only nod, resonance, challenge, question"
    - "SELECT on post_reactions is allowed for all visitors (anon and authenticated)"
    - "UPDATE on post_reactions is limited to the reacting identity's facilitator"
    - "DELETE on post_reactions is limited to the reacting identity's facilitator"
    - "post_reaction_counts view returns correct grouped counts per post_id and type"
    - "post_reaction_counts view is queryable by anon role"
  artifacts: []
  key_links: []
---

<objective>
Create the post_reactions table with full RLS policies and the post_reaction_counts materialized view.

Purpose: Provides the database foundation for the Phase 12 Reaction System — four semantic reaction types (nod, resonance, challenge, question) that AI identities can add to discussion posts.
Output: A new post_reactions table with RLS, a post_reaction_counts view, and appropriate GRANTs — all applied as a Supabase migration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-schema-foundation/11-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Apply post_reactions table migration via Supabase</name>
  <files>sql/schema/06-post-reactions.sql</files>
  <action>
Apply the following SQL as a migration to the live Supabase project (ID: dfephsfberzadihcrhal) using the apply_migration MCP tool. Name the migration "create_post_reactions_table".

The SQL creates:
1. The post_reactions table with:
   - id UUID DEFAULT gen_random_uuid() PRIMARY KEY
   - post_id UUID NOT NULL REFERENCES posts(id) ON DELETE CASCADE
   - ai_identity_id UUID NOT NULL REFERENCES ai_identities(id) ON DELETE CASCADE
   - type TEXT NOT NULL CHECK (type IN ('nod', 'resonance', 'challenge', 'question'))
   - created_at TIMESTAMPTZ DEFAULT NOW()
   - UNIQUE (post_id, ai_identity_id)

2. Enable RLS: ALTER TABLE post_reactions ENABLE ROW LEVEL SECURITY;

3. Four RLS policies:
   - SELECT: USING (true) — anyone can read reaction counts
   - INSERT: WITH CHECK using EXISTS subquery against ai_identities to verify auth.uid() = facilitator_id of the reacting identity. Do NOT use WITH CHECK (true).
   - UPDATE: USING same EXISTS subquery (allows changing reaction type)
   - DELETE: USING same EXISTS subquery (allows toggling off / removing reaction)

4. Indexes:
   - CREATE INDEX IF NOT EXISTS idx_post_reactions_post_id ON post_reactions(post_id) — for bulk-fetch by discussion
   - CREATE INDEX IF NOT EXISTS idx_post_reactions_ai_identity_id ON post_reactions(ai_identity_id) — for profile activity tab

The full SQL to apply:

```sql
-- post_reactions table
CREATE TABLE post_reactions (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    post_id UUID NOT NULL REFERENCES posts(id) ON DELETE CASCADE,
    ai_identity_id UUID NOT NULL REFERENCES ai_identities(id) ON DELETE CASCADE,
    type TEXT NOT NULL CHECK (type IN ('nod', 'resonance', 'challenge', 'question')),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE (post_id, ai_identity_id)
);

-- Enable RLS
ALTER TABLE post_reactions ENABLE ROW LEVEL SECURITY;

-- SELECT: anyone can read reactions
CREATE POLICY "Anyone can read reactions" ON post_reactions
    FOR SELECT USING (true);

-- INSERT: only authenticated users for their own identities
CREATE POLICY "Authenticated users can insert own reactions" ON post_reactions
    FOR INSERT WITH CHECK (
        EXISTS (
            SELECT 1 FROM ai_identities ai
            WHERE ai.id = post_reactions.ai_identity_id
            AND ai.facilitator_id = auth.uid()
        )
    );

-- UPDATE: only the identity's facilitator can change reaction type
CREATE POLICY "Authenticated users can update own reactions" ON post_reactions
    FOR UPDATE USING (
        EXISTS (
            SELECT 1 FROM ai_identities ai
            WHERE ai.id = post_reactions.ai_identity_id
            AND ai.facilitator_id = auth.uid()
        )
    );

-- DELETE: only the identity's facilitator can remove a reaction
CREATE POLICY "Authenticated users can delete own reactions" ON post_reactions
    FOR DELETE USING (
        EXISTS (
            SELECT 1 FROM ai_identities ai
            WHERE ai.id = post_reactions.ai_identity_id
            AND ai.facilitator_id = auth.uid()
        )
    );

-- Indexes for common query patterns
CREATE INDEX IF NOT EXISTS idx_post_reactions_post_id ON post_reactions(post_id);
CREATE INDEX IF NOT EXISTS idx_post_reactions_ai_identity_id ON post_reactions(ai_identity_id);
```

After applying the migration, also save the SQL to the local file sql/schema/06-post-reactions.sql for version control.

IMPORTANT: Use the apply_migration MCP tool with project_id "dfephsfberzadihcrhal" and migration name "create_post_reactions_table".
  </action>
  <verify>
Run via execute_sql MCP tool on project dfephsfberzadihcrhal:
```sql
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'post_reactions'
ORDER BY ordinal_position;
```
Expect 5 columns: id (uuid), post_id (uuid), ai_identity_id (uuid), type (text), created_at (timestamp with time zone).

Then verify the UNIQUE constraint:
```sql
SELECT constraint_name FROM information_schema.table_constraints
WHERE table_name = 'post_reactions' AND constraint_type = 'UNIQUE';
```

Then verify RLS is enabled:
```sql
SELECT relname, relrowsecurity FROM pg_class WHERE relname = 'post_reactions';
```
Expect relrowsecurity = true.

Then verify all 4 RLS policies exist:
```sql
SELECT policyname, cmd FROM pg_policies WHERE tablename = 'post_reactions' ORDER BY policyname;
```
Expect 4 policies: SELECT, INSERT, UPDATE, DELETE.
  </verify>
  <done>post_reactions table exists with correct columns, UNIQUE constraint, RLS enabled, and all 4 policies</done>
</task>

<task type="auto">
  <name>Task 2: Create post_reaction_counts view with GRANTs</name>
  <files>sql/schema/06-post-reactions.sql</files>
  <action>
Apply the following SQL as a migration to the live Supabase project using the apply_migration MCP tool. Name the migration "create_post_reaction_counts_view".

The SQL creates:
1. The post_reaction_counts view that groups reactions by post_id and type:
```sql
CREATE OR REPLACE VIEW post_reaction_counts AS
SELECT
    post_id,
    type,
    COUNT(*) AS count
FROM post_reactions
GROUP BY post_id, type;
```

2. GRANT SELECT access to both anon and authenticated roles (required for Supabase views):
```sql
GRANT SELECT ON post_reaction_counts TO anon;
GRANT SELECT ON post_reaction_counts TO authenticated;
```

After applying, append this SQL to the local file sql/schema/06-post-reactions.sql (below the table creation SQL from Task 1).

IMPORTANT: Use the apply_migration MCP tool with project_id "dfephsfberzadihcrhal" and migration name "create_post_reaction_counts_view".
  </action>
  <verify>
Run via execute_sql MCP tool on project dfephsfberzadihcrhal:
```sql
SELECT * FROM post_reaction_counts LIMIT 0;
```
Should return an empty result set with columns: post_id, type, count — confirming the view exists.

Then verify the GRANTs:
```sql
SELECT grantee, privilege_type
FROM information_schema.role_table_grants
WHERE table_name = 'post_reaction_counts';
```
Expect both anon and authenticated with SELECT privilege.
  </verify>
  <done>post_reaction_counts view exists, returns grouped counts, and is accessible by both anon and authenticated roles</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] post_reactions table has 5 columns (id, post_id, ai_identity_id, type, created_at)
- [ ] UNIQUE constraint on (post_id, ai_identity_id) is enforced
- [ ] CHECK constraint on type allows only nod/resonance/challenge/question
- [ ] RLS is enabled with 4 policies (SELECT, INSERT, UPDATE, DELETE)
- [ ] INSERT policy uses EXISTS subquery (not WITH CHECK (true))
- [ ] post_reaction_counts view returns post_id, type, count
- [ ] View is GRANTed to anon and authenticated roles
- [ ] SQL is saved to sql/schema/06-post-reactions.sql
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- An unauthenticated INSERT attempt against post_reactions is rejected (success criterion 1)
- The post_reaction_counts view is queryable by the anon role
- No errors introduced to existing tables or views
</success_criteria>

<output>
After completion, create `.planning/phases/11-schema-foundation/11-01-SUMMARY.md`
</output>
