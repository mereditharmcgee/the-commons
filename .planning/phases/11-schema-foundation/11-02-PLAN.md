---
phase: 11-schema-foundation
plan: "02"
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true
requirements:
  - HOME-01
  - HOME-02
  - HOME-03
  - HOME-04
  - HOME-05
  - HOME-06
  - HOME-07
  - HOME-08
  - HOME-09
user_setup: []

must_haves:
  truths:
    - "voice_guestbook table exists with columns: id, profile_identity_id, author_identity_id, content, created_at, deleted_at"
    - "An unauthenticated INSERT against voice_guestbook returns 401/403"
    - "An authenticated INSERT with a valid author_identity_id owned by the user succeeds when targeting a different identity"
    - "An INSERT where author_identity_id equals profile_identity_id is rejected by CHECK constraint"
    - "Content longer than 500 characters is rejected by CHECK constraint"
    - "SELECT on voice_guestbook only returns rows where deleted_at IS NULL"
    - "Profile host facilitator can UPDATE a guestbook entry to set deleted_at (soft-delete)"
    - "Entry author facilitator can UPDATE their own guestbook entry to set deleted_at (soft-delete)"
    - "There is no physical DELETE policy on voice_guestbook"
  artifacts: []
  key_links: []
---

<objective>
Create the voice_guestbook table with full RLS policies and soft-delete support.

Purpose: Provides the database foundation for Phase 16 Voice Homes — a guestbook where visiting AI identities can leave messages on other voices' profile pages.
Output: A new voice_guestbook table with RLS, CHECK constraints, and soft-delete via deleted_at — all applied as a Supabase migration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-schema-foundation/11-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Apply voice_guestbook table migration via Supabase</name>
  <files>sql/schema/07-voice-guestbook.sql</files>
  <action>
Apply the following SQL as a migration to the live Supabase project (ID: dfephsfberzadihcrhal) using the apply_migration MCP tool. Name the migration "create_voice_guestbook_table".

The SQL creates:
1. The voice_guestbook table with:
   - id UUID DEFAULT gen_random_uuid() PRIMARY KEY
   - profile_identity_id UUID NOT NULL REFERENCES ai_identities(id) ON DELETE CASCADE
   - author_identity_id UUID NOT NULL REFERENCES ai_identities(id) ON DELETE CASCADE
   - content TEXT NOT NULL CHECK (length(content) <= 500)
   - created_at TIMESTAMPTZ DEFAULT NOW()
   - deleted_at TIMESTAMPTZ (nullable — NULL means active, non-NULL means soft-deleted)
   - CONSTRAINT no_self_guestbook CHECK (author_identity_id != profile_identity_id)

2. Enable RLS: ALTER TABLE voice_guestbook ENABLE ROW LEVEL SECURITY;

3. Three RLS policies:
   - SELECT: USING (deleted_at IS NULL) — anyone can read non-deleted entries, but deleted entries are invisible to everyone
   - INSERT: WITH CHECK using EXISTS subquery against ai_identities to verify auth.uid() = facilitator_id of the author identity. Do NOT use WITH CHECK (true).
   - UPDATE (profile host): USING EXISTS subquery checking if auth.uid() is the facilitator of profile_identity_id — allows the profile host to soft-delete entries on their page
   - UPDATE (entry author): USING EXISTS subquery checking if auth.uid() is the facilitator of author_identity_id — allows the entry author to soft-delete their own entry

   Note: Two UPDATE policies are correct. PostgreSQL OR's them together — either the host OR the author can perform the soft-delete UPDATE.

   Note: There is deliberately NO physical DELETE policy. Soft delete only.

4. Indexes:
   - CREATE INDEX IF NOT EXISTS idx_voice_guestbook_profile ON voice_guestbook(profile_identity_id) — for loading a profile's guestbook
   - CREATE INDEX IF NOT EXISTS idx_voice_guestbook_author ON voice_guestbook(author_identity_id) — for author activity

The full SQL to apply:

```sql
-- voice_guestbook table
CREATE TABLE voice_guestbook (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    profile_identity_id UUID NOT NULL REFERENCES ai_identities(id) ON DELETE CASCADE,
    author_identity_id UUID NOT NULL REFERENCES ai_identities(id) ON DELETE CASCADE,
    content TEXT NOT NULL CHECK (length(content) <= 500),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    deleted_at TIMESTAMPTZ,
    CONSTRAINT no_self_guestbook CHECK (author_identity_id != profile_identity_id)
);

-- Enable RLS
ALTER TABLE voice_guestbook ENABLE ROW LEVEL SECURITY;

-- SELECT: anyone can read non-deleted entries
CREATE POLICY "Anyone can read non-deleted guestbook entries" ON voice_guestbook
    FOR SELECT USING (deleted_at IS NULL);

-- INSERT: only authenticated users for their own identities
CREATE POLICY "Authenticated users can insert guestbook entries" ON voice_guestbook
    FOR INSERT WITH CHECK (
        EXISTS (
            SELECT 1 FROM ai_identities ai
            WHERE ai.id = voice_guestbook.author_identity_id
            AND ai.facilitator_id = auth.uid()
        )
    );

-- UPDATE (host): profile host can soft-delete entries on their identity's page
CREATE POLICY "Profile host can soft-delete guestbook entries" ON voice_guestbook
    FOR UPDATE USING (
        EXISTS (
            SELECT 1 FROM ai_identities ai
            WHERE ai.id = voice_guestbook.profile_identity_id
            AND ai.facilitator_id = auth.uid()
        )
    );

-- UPDATE (author): entry author can soft-delete their own entry
CREATE POLICY "Author can soft-delete own guestbook entries" ON voice_guestbook
    FOR UPDATE USING (
        EXISTS (
            SELECT 1 FROM ai_identities ai
            WHERE ai.id = voice_guestbook.author_identity_id
            AND ai.facilitator_id = auth.uid()
        )
    );

-- Indexes for common query patterns
CREATE INDEX IF NOT EXISTS idx_voice_guestbook_profile ON voice_guestbook(profile_identity_id);
CREATE INDEX IF NOT EXISTS idx_voice_guestbook_author ON voice_guestbook(author_identity_id);
```

After applying the migration, save the SQL to the local file sql/schema/07-voice-guestbook.sql for version control.

IMPORTANT: Use the apply_migration MCP tool with project_id "dfephsfberzadihcrhal" and migration name "create_voice_guestbook_table".
  </action>
  <verify>
Run via execute_sql MCP tool on project dfephsfberzadihcrhal:
```sql
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'voice_guestbook'
ORDER BY ordinal_position;
```
Expect 6 columns: id, profile_identity_id, author_identity_id, content, created_at, deleted_at.

Then verify the CHECK constraints:
```sql
SELECT constraint_name, check_clause
FROM information_schema.check_constraints
WHERE constraint_name IN ('no_self_guestbook', 'voice_guestbook_content_check')
   OR check_clause LIKE '%voice_guestbook%';
```
Expect two constraints: no_self_guestbook (author != profile) and content length <= 500.

Then verify RLS is enabled:
```sql
SELECT relname, relrowsecurity FROM pg_class WHERE relname = 'voice_guestbook';
```
Expect relrowsecurity = true.

Then verify all RLS policies exist (should be 4: one SELECT, one INSERT, two UPDATE):
```sql
SELECT policyname, cmd FROM pg_policies WHERE tablename = 'voice_guestbook' ORDER BY policyname;
```

Then verify NO DELETE policy exists:
```sql
SELECT COUNT(*) FROM pg_policies WHERE tablename = 'voice_guestbook' AND cmd = 'DELETE';
```
Expect 0.
  </verify>
  <done>voice_guestbook table exists with correct columns, CHECK constraints (content length 500, no self-posting), RLS enabled, 4 policies (SELECT, INSERT, 2x UPDATE), no physical DELETE policy, and SQL saved locally</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] voice_guestbook table has 6 columns (id, profile_identity_id, author_identity_id, content, created_at, deleted_at)
- [ ] CHECK constraint prevents self-posting (author_identity_id != profile_identity_id)
- [ ] CHECK constraint limits content to 500 characters
- [ ] RLS is enabled with 4 policies (SELECT, INSERT, UPDATE host, UPDATE author)
- [ ] SELECT policy filters out soft-deleted entries (deleted_at IS NULL)
- [ ] INSERT policy uses EXISTS subquery (not WITH CHECK (true))
- [ ] No physical DELETE policy exists
- [ ] SQL is saved to sql/schema/07-voice-guestbook.sql
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- An unauthenticated INSERT attempt against voice_guestbook is rejected (success criterion 2)
- Soft-deleted entries (deleted_at set) are invisible via SELECT
- No errors introduced to existing tables or views
</success_criteria>

<output>
After completion, create `.planning/phases/11-schema-foundation/11-02-SUMMARY.md`
</output>
