---
phase: 14-agent-docs-form-ux
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - js/utils.js
  - js/auth.js
  - js/postcards.js
  - js/text.js
  - js/dashboard.js
  - js/discussion.js
  - js/home.js
  - js/news.js
autonomous: true
requirements:
  - AGNT-04
  - AGNT-05
  - AGNT-06
  - AGNT-07
  - AGNT-08

must_haves:
  truths:
    - "Every form submit button on the site re-enables after both success and error responses"
    - "Every form shows a visible inline success or error message after submission (no alert() calls)"
    - "ESLint reports 0 errors and 0 warnings when run against js/"
    - "All public methods in utils.js have JSDoc with @param and @returns tags"
    - "All public methods in auth.js have JSDoc with @param and @returns tags"
  artifacts:
    - path: "js/utils.js"
      provides: "Utils.showFormMessage() shared utility + JSDoc on all public methods"
      contains: "showFormMessage"
    - path: "js/auth.js"
      provides: "JSDoc annotations on all public methods"
      contains: "@param"
    - path: "js/postcards.js"
      provides: "Fixed form: Uses Utils.showFormMessage(), no alert()"
      contains: "Utils.showFormMessage"
    - path: "js/text.js"
      provides: "Fixed marginalia form: Uses Utils.showFormMessage(), no alert()"
      contains: "Utils.showFormMessage"
    - path: "js/dashboard.js"
      provides: "Fixed identity/token forms: Uses Utils.showFormMessage(), no alert()"
      contains: "Utils.showFormMessage"
    - path: "js/discussion.js"
      provides: "Fixed inline edit modal: Uses Utils.showFormMessage(), no alert()"
      contains: "Utils.showFormMessage"
  key_links:
    - from: "js/postcards.js"
      to: "js/utils.js"
      via: "Utils.showFormMessage() call"
      pattern: "Utils\\.showFormMessage"
    - from: "js/text.js"
      to: "js/utils.js"
      via: "Utils.showFormMessage() call"
      pattern: "Utils\\.showFormMessage"
    - from: "js/dashboard.js"
      to: "js/utils.js"
      via: "Utils.showFormMessage() call"
      pattern: "Utils\\.showFormMessage"
---

<objective>
Add Utils.showFormMessage() shared utility, fix all form submit handlers to use inline feedback instead of alert(), fix 3 ESLint warnings, and add JSDoc annotations to all public methods in utils.js and auth.js.

Purpose: Forms with stuck buttons and alert() dialogs break the user experience. Missing JSDoc makes the codebase harder for agents and contributors to understand. Zero ESLint warnings ensures code quality baseline.
Output: All forms use consistent inline feedback, ESLint clean, full JSDoc coverage on utils.js and auth.js
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-agent-docs-form-ux/14-CONTEXT.md
@.planning/phases/14-agent-docs-form-ux/14-RESEARCH.md
@js/utils.js
@js/auth.js
@js/postcards.js
@js/text.js
@js/dashboard.js
@js/discussion.js
@js/home.js
@js/news.js
@css/style.css
@eslint.config.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Utils.showFormMessage(), fix forms, fix ESLint warnings</name>
  <files>js/utils.js, js/postcards.js, js/text.js, js/dashboard.js, js/discussion.js, js/home.js, js/news.js</files>
  <action>
Read all files listed above fully before making changes.

**Step 1: Add Utils.showFormMessage() to js/utils.js**

Add the following method to the Utils object (near other DOM utility methods like show/hide/showError):

```javascript
/**
 * Show an inline form message (success or error) below a form.
 * Success messages auto-dismiss after a configurable delay.
 * Error messages persist until the next submission or explicit dismissal.
 * @param {HTMLElement|string} container - The message container element or its ID
 * @param {string} text - Message text
 * @param {'success'|'error'|'info'} type - Message type
 * @param {number} [autoDismissMs=4000] - Auto-dismiss delay for success messages (0 = no dismiss)
 */
showFormMessage(container, text, type, autoDismissMs = 4000) {
    if (typeof container === 'string') {
        container = document.getElementById(container);
    }
    if (!container) return;
    container.className = 'alert alert--' + type;
    container.textContent = text;
    container.classList.remove('hidden');
    container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

    if (type === 'success' && autoDismissMs > 0) {
        clearTimeout(container._dismissTimer);
        container._dismissTimer = setTimeout(function() {
            container.classList.add('hidden');
        }, autoDismissMs);
    }
}
```

Per user decision: inline messages (no overlays/toasts), success auto-dismiss 3-5s (using 4s), error stays until dismissed, uses existing `.alert`, `.alert--success`, `.alert--error` CSS classes.

**Step 2: Fix form files that use alert()**

For each file, the pattern is: (1) ensure a `<div id="form-message" class="alert hidden"></div>` element exists in the corresponding HTML (or use an existing one), (2) replace `alert()` calls with `Utils.showFormMessage()`, (3) ensure the submit button is re-enabled in both success and error paths.

**postcards.js** — Replace `alert()` calls in the submit handler:
- On error: replace `alert('Failed to submit...')` with `Utils.showFormMessage('form-message', 'Error: ' + error.message, 'error')`
- On success: replace `alert('Postcard submitted!')` with `Utils.showFormMessage('form-message', 'Postcard submitted!', 'success')`
- Ensure button re-enables in both paths (check current setTimeout pattern and keep it for success, add explicit re-enable in catch)
- Add `<div id="form-message" class="alert hidden"></div>` to postcards.html if no message container exists

**text.js** (marginalia form) — Replace alert() in the marginalia submit handler:
- On error: replace `alert()` with `Utils.showFormMessage()`
- On success: add success message via `Utils.showFormMessage()` (currently missing entirely)
- Ensure button re-enables in both paths
- Add message container div to text.html if needed

**dashboard.js** — Two forms to fix:
- Identity creation/edit form: replace `alert()` with `Utils.showFormMessage()` using a message container near the identity form
- Token generation form: replace `alert()` with `Utils.showFormMessage()` (success still shows the token, but errors use inline message instead of alert)
- Fix ESLint warning: `notLoggedIn` on line 7 — if the variable is truly unused, remove it; if it's used later, prefix with `_`
- Add message container divs to dashboard.html if needed

**discussion.js** (inline edit modal) — Replace alert() in the edit form handler:
- On error: replace `alert()` with `Utils.showFormMessage()` using a message container inside the edit modal
- On success: the modal closes (this is correct behavior — no inline message needed after modal closes)
- Add message container inside the edit modal markup if needed

**Step 3: Fix remaining ESLint warnings**

- **home.js line 325**: Rename `err` to `_err` in the catch block (unused variable)
- **news.js line 37**: Rename `err` to `_err` in the catch block (unused variable)

**Step 4: Verify**

Run `npx eslint js/` — must report 0 errors, 0 warnings.

Note: For each HTML file that needs a message container div added (postcards.html, text.html, dashboard.html, discussion.html), add a `<div id="[form]-message" class="alert hidden"></div>` element adjacent to the form. Use IDs that match what the JS references. The existing `.alert` and `.hidden` CSS classes handle all styling.

Post-submit behavior per user decision (Claude's discretion):
- postcards.js: clear form after success (user stays on page to create another)
- text.js marginalia: clear textarea after success (user stays on page)
- dashboard.js identity: close modal after success (existing behavior)
- dashboard.js token: keep token display on success (existing behavior), inline error for failures
- discussion.js edit: close modal after success (existing behavior)
  </action>
  <verify>
    <automated>cd "C:/Users/mmcge/the-commons" && npx eslint js/ 2>&1 && grep -c "showFormMessage" js/utils.js && grep -c "alert(" js/postcards.js js/text.js js/dashboard.js js/discussion.js 2>/dev/null</automated>
  </verify>
  <done>
- Utils.showFormMessage() exists in utils.js
- postcards.js, text.js, dashboard.js, discussion.js use Utils.showFormMessage() instead of alert()
- All form submit buttons re-enable on both success and error
- ESLint reports 0 errors, 0 warnings across all js/ files
- alert() count in fixed files is 0 (verify via grep)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add JSDoc annotations to utils.js and auth.js</name>
  <files>js/utils.js, js/auth.js</files>
  <action>
Read both files fully. Add JSDoc `@param` and `@returns` annotations to every public method that is missing them.

**js/utils.js — Methods needing JSDoc** (from RESEARCH.md audit):

```javascript
formatDate(dateString, short = false)
// @param {string} dateString - ISO date string to format
// @param {boolean} [short=false] - Use abbreviated format
// @returns {string} Formatted date string

formatRelativeTime(dateString)
// @param {string} dateString - ISO date string
// @returns {string} Relative time string (e.g. "3 hours ago")

getModelInfo(modelName)
// @param {string} modelName - Model name to look up
// @returns {Object} Model info object with color and label, or default

escapeHtml(text)
// @param {string} text - Raw text to escape
// @returns {string} HTML-escaped text

formatContent(text)
// @param {string} text - Raw content text
// @returns {string} Sanitized HTML with paragraph/link formatting

getUrlParam(name)
// @param {string} name - URL parameter name
// @returns {string|null} Parameter value or null

discussionUrl(id)
// @param {string} id - Discussion UUID
// @returns {string} URL path to discussion page

show(element)
// @param {HTMLElement} element - Element to show

hide(element)
// @param {HTMLElement} element - Element to hide

showLoading(container, message)
// @param {HTMLElement} container - Container to show loading state in
// @param {string} [message] - Optional loading message

generateContext(discussion, posts)
// @param {Object} discussion - Discussion object
// @param {Array} posts - Array of post objects
// @returns {string} Formatted context string for AI

generateTextContext(text, marginalia)
// @param {Object} text - Text object
// @param {Array} marginalia - Array of marginalia objects
// @returns {string} Formatted context string for AI

generateRecentPostsContext(posts, discussions, hours)
// @param {Array} posts - Recent post objects
// @param {Array} discussions - Discussion objects
// @param {number} hours - Hours of recency
// @returns {string} Formatted context string for AI

announce(message, priority)
// @param {string} message - Screen reader announcement text
// @param {string} [priority='polite'] - 'polite' or 'assertive'
```

Also add JSDoc to the new `showFormMessage` method (already included in Task 1 action).

**js/auth.js — Methods needing full JSDoc** (from RESEARCH.md audit):

Add `@param` and `@returns` to every method listed in the research. Use plain JSDoc types: `{string}`, `{number}`, `{boolean}`, `{Promise<Object>}`, `{Array}`, `{HTMLElement}`. No TypeScript syntax.

For methods that already have a description line but no @param/@returns, keep the description and add the missing tags below it.

Key methods and their signatures:

```
getClient()         → @returns {Object} Supabase client instance
signOut()           → @returns {Promise<void>}
isLoggedIn()        → @returns {boolean}
getUser()           → @returns {Object|null} Current Supabase user
getFacilitator()    → @returns {Object|null} Current facilitator record
createFacilitator() → @returns {Promise<Object>} New facilitator record
updateFacilitator(updates) → @param {Object} updates, @returns {Promise<Object>}
claimOldPosts(email) → @param {string} email, @returns {Promise<void>}
createIdentity({name,model,modelVersion,bio}) → @param {Object} data, @returns {Promise<Object>}
updateIdentity(identityId, updates) → @param {string} identityId, @param {Object} updates, @returns {Promise<Object>}
getIdentity(identityId) → @param {string} identityId, @returns {Promise<Object|null>}
getAllIdentities() → @returns {Promise<Array>}
updatePost(postId, updates) → @param {string} postId, @param {Object} updates, @returns {Promise<Object>}
deletePost(postId) → @param {string} postId, @returns {Promise<void>}
updateMarginalia(marginaliaId, ...) → @param {string} marginaliaId, ..., @returns {Promise<Object>}
deleteMarginalia(marginaliaId) → @param {string} marginaliaId, @returns {Promise<void>}
updatePostcard(postcardId, ...) → @param {string} postcardId, ..., @returns {Promise<Object>}
deletePostcard(postcardId) → @param {string} postcardId, @returns {Promise<void>}
subscribe(targetType, targetId) → @param {string} targetType, @param {string} targetId, @returns {Promise<Object>}
unsubscribe(targetType, targetId) → @param {string} targetType, @param {string} targetId, @returns {Promise<void>}
isSubscribed(targetType, targetId) → @param {string} targetType, @param {string} targetId, @returns {Promise<boolean>}
getMySubscriptions() → @returns {Promise<Array>}
getNotifications(limit, unreadOnly, type, offset) → @param {number} [limit], @param {boolean} [unreadOnly], @param {string} [type], @param {number} [offset], @returns {Promise<Array>}
getUnreadCount() → @returns {Promise<number>}
markAsRead(notificationId) → @param {string} notificationId, @returns {Promise<void>}
markAllAsRead() → @returns {Promise<void>}
addReaction(postId, aiIdentityId, type) → @param {string} postId, @param {string} aiIdentityId, @param {string} type, @returns {Promise<Object>}
removeReaction(postId, aiIdentityId) → @param {string} postId, @param {string} aiIdentityId, @returns {Promise<void>}
updateUI() → @returns {void} (synchronous DOM update)
updateNotificationBadge() → @returns {Promise<void>}
```

For `init()`, `loadFacilitator()`, `getMyIdentities()`, `sendMagicLink()`, `sendPasswordReset()`, `updatePassword()`, `signInWithPassword()`, `signUpWithPassword()` — they already have description-only docs, add the missing @param and @returns tags.

Use the existing JSDoc style in the project: brief one-sentence description, @param with type and description, @returns with type. No verbose multi-paragraph docs.
  </action>
  <verify>
    <automated>cd "C:/Users/mmcge/the-commons" && grep -c "@param\|@returns" js/utils.js && grep -c "@param\|@returns" js/auth.js</automated>
  </verify>
  <done>
- Every public method in utils.js has a JSDoc block with @param and @returns tags
- Every public method in auth.js has a JSDoc block with @param and @returns tags
- JSDoc uses plain types ({string}, {Object}, {Promise<Array>}) — no TypeScript syntax
- Existing method descriptions are preserved, not overwritten
  </done>
</task>

</tasks>

<verification>
1. `npx eslint js/` returns 0 errors, 0 warnings
2. `grep -r "alert(" js/postcards.js js/text.js js/dashboard.js js/discussion.js` returns 0 matches (no more alert() in fixed files)
3. `grep -c "showFormMessage" js/utils.js` returns at least 1 (the method definition)
4. `grep -c "@param" js/utils.js` returns 15+ (JSDoc coverage)
5. `grep -c "@param" js/auth.js` returns 30+ (JSDoc coverage)
6. Open postcards.html, text.html, dashboard.html in browser — submit forms show inline messages, buttons re-enable
</verification>

<success_criteria>
- All form submit buttons re-enable after success and error (AGNT-04)
- All forms show inline success/error feedback via Utils.showFormMessage() (AGNT-05)
- ESLint reports 0 errors, 0 warnings on `npx eslint js/` (AGNT-06)
- All utils.js public methods have complete JSDoc (AGNT-07)
- All auth.js public methods have complete JSDoc (AGNT-08)
</success_criteria>

<output>
After completion, create `.planning/phases/14-agent-docs-form-ux/14-02-SUMMARY.md`
</output>
