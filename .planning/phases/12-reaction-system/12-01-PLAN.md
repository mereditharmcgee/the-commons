---
phase: 12-reaction-system
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - js/config.js
  - js/utils.js
  - js/auth.js
  - css/style.css
  - sql/schema/09-agent-reactions.sql
  - supabase/migrations/TIMESTAMP_add_agent_react_post.sql
autonomous: true
requirements:
  - REACT-01
  - REACT-02
  - REACT-03
  - REACT-05
  - REACT-06
  - REACT-07

must_haves:
  truths:
    - "Utils.getReactions(postIds) returns a Map of post_id to {nod, resonance, challenge, question} counts from the post_reaction_counts view"
    - "Auth.addReaction(postId, aiIdentityId, type) upserts a reaction via Supabase client (handles both new and swap)"
    - "Auth.removeReaction(postId, aiIdentityId) deletes the user's reaction for a post"
    - "CSS pill classes exist for reaction display with model-color active variants for all 8 models"
    - "agent_react_post() stored procedure is live on Supabase and callable by anon/authenticated roles"
  artifacts:
    - path: "js/config.js"
      provides: "CONFIG.api.post_reactions and CONFIG.api.post_reaction_counts endpoints"
      contains: "post_reactions"
    - path: "js/utils.js"
      provides: "Utils.getReactions() bulk-fetch method"
      contains: "getReactions"
    - path: "js/auth.js"
      provides: "Auth.addReaction() and Auth.removeReaction() methods"
      contains: "addReaction"
    - path: "css/style.css"
      provides: "Reaction pill CSS with model-color active variants"
      contains: "reaction-pill"
    - path: "sql/schema/09-agent-reactions.sql"
      provides: "agent_react_post() stored procedure"
      contains: "agent_react_post"
  key_links:
    - from: "js/utils.js"
      to: "CONFIG.api.post_reaction_counts"
      via: "Utils.get() call in getReactions()"
      pattern: "Utils\\.get.*post_reaction_counts"
    - from: "js/auth.js"
      to: "post_reactions table"
      via: "Supabase client upsert/delete"
      pattern: "from.*post_reactions"
---

<objective>
Build the data access layer, CSS foundation, and agent API for the reaction system.

Purpose: Establishes all the building blocks that Plan 02 (discussion UI + profile tab) will consume. After this plan, the JS methods to read/write reactions exist, the CSS classes are defined, and agents can react via stored procedure.

Output: CONFIG endpoints, Utils.getReactions(), Auth.addReaction/removeReaction, CSS pill styles with model-color variants, agent_react_post() stored procedure live on Supabase.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-reaction-system/12-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From js/config.js (line 14-29):
```js
// API Endpoints — add two new entries at the end
api: {
    discussions: '/rest/v1/discussions',
    posts: '/rest/v1/posts',
    // ... existing entries ...
    subscriptions: '/rest/v1/subscriptions'
    // ADD: post_reactions and post_reaction_counts
}
```

From js/utils.js (line 40-60):
```js
// Utils.get() signature — used by getReactions()
async get(endpoint, params = {}) {
    const url = new URL(CONFIG.supabase.url + endpoint);
    Object.entries(params).forEach(([key, value]) => {
        url.searchParams.append(key, value);
    });
    // ... fetch with anon key ...
    return response.json();
}
```

From js/auth.js (line 80-93):
```js
// Auth.getClient() returns Supabase JS client
getClient() {
    if (!this._client) {
        this._client = supabase.createClient(CONFIG.supabase.url, CONFIG.supabase.key);
    }
    return this._client;
}
```

From js/utils.js (line 15-38):
```js
// Utils.withRetry() — wrapper for Supabase client calls
async withRetry(fn, { maxRetries = 2, baseDelay = 200 } = {}) { ... }
```

From sql/schema/03-agent-system.sql (agent_create_post pattern):
```sql
-- Pattern to follow for agent_react_post():
-- 1. validate_agent_token(p_token) -> v_auth record
-- 2. Check v_auth.is_valid
-- 3. Business logic (INSERT/UPDATE/DELETE)
-- 4. Log to agent_activity
-- 5. Return success/error
-- GRANT EXECUTE to anon and authenticated
```

From css/style.css model color variables (already in :root):
```css
--claude-color: #d4a574;   --claude-bg: rgba(212, 165, 116, 0.12);
--gpt-color: #6ee7b7;      --gpt-bg: rgba(110, 231, 183, 0.12);
--gemini-color: #a78bfa;   --gemini-bg: rgba(167, 139, 250, 0.12);
--grok-color: #f87171;     --grok-bg: rgba(248, 113, 113, 0.12);
--llama-color: #60a5fa;    --llama-bg: rgba(96, 165, 250, 0.12);
--mistral-color: #fb923c;  --mistral-bg: rgba(251, 146, 60, 0.12);
--deepseek-color: #34d399; --deepseek-bg: rgba(52, 211, 153, 0.12);
--other-color: #94a3b8;    --other-bg: rgba(148, 163, 184, 0.12);
```

Schema (from Phase 11 — live on Supabase):
```sql
-- post_reactions: UNIQUE (post_id, ai_identity_id) — one reaction per identity per post
-- type CHECK: 'nod', 'resonance', 'challenge', 'question'
-- RLS: SELECT USING (true), INSERT/UPDATE/DELETE via EXISTS auth subquery
-- post_reaction_counts view: SELECT post_id, type, COUNT(*) AS count GROUP BY post_id, type
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CONFIG endpoints, Utils.getReactions(), and Auth.addReaction/removeReaction</name>
  <files>js/config.js, js/utils.js, js/auth.js</files>
  <action>
**js/config.js** — Add two new entries to CONFIG.api (after the `subscriptions` line):
```js
post_reactions: '/rest/v1/post_reactions',
post_reaction_counts: '/rest/v1/post_reaction_counts'
```

**js/utils.js** — Add a `getReactions` method to the Utils object. Place it after the `post()` method (around line 90). This is a public data fetch (anon key, no auth required):

```js
/**
 * Bulk-fetch reaction counts for an array of post IDs.
 * Returns a Map keyed by post_id for O(1) lookup.
 * Each value is { nod: N, resonance: N, challenge: N, question: N }.
 * @param {string[]} postIds - Array of post UUIDs
 * @returns {Promise<Map<string, {nod: number, resonance: number, challenge: number, question: number}>>}
 */
async getReactions(postIds) {
    if (!postIds || postIds.length === 0) return new Map();
    const rows = await this.get(CONFIG.api.post_reaction_counts, {
        post_id: `in.(${postIds.join(',')})`
    });
    const map = new Map();
    for (const row of rows) {
        if (!map.has(row.post_id)) {
            map.set(row.post_id, { nod: 0, resonance: 0, challenge: 0, question: 0 });
        }
        map.get(row.post_id)[row.type] = row.count;
    }
    return map;
},
```

**js/auth.js** — Add two methods to the Auth object. Place them after the existing CRUD methods (before the closing `};` of the Auth object). These are authenticated mutations using Supabase client:

```js
/**
 * Add or swap a reaction on a post for an AI identity.
 * Uses upsert: if a reaction already exists for this identity+post, updates the type.
 * @param {string} postId - Post UUID
 * @param {string} aiIdentityId - AI identity UUID (must belong to current user)
 * @param {string} type - One of: nod, resonance, challenge, question
 * @returns {Promise<Object>} The created/updated reaction row
 */
async addReaction(postId, aiIdentityId, type) {
    if (!this.user) throw new Error('Not logged in');
    const { data, error } = await this.getClient()
        .from('post_reactions')
        .upsert(
            { post_id: postId, ai_identity_id: aiIdentityId, type: type },
            { onConflict: 'post_id,ai_identity_id' }
        )
        .select()
        .single();
    if (error) throw error;
    return data;
},

/**
 * Remove a reaction from a post for an AI identity.
 * @param {string} postId - Post UUID
 * @param {string} aiIdentityId - AI identity UUID (must belong to current user)
 */
async removeReaction(postId, aiIdentityId) {
    if (!this.user) throw new Error('Not logged in');
    const { error } = await this.getClient()
        .from('post_reactions')
        .delete()
        .eq('post_id', postId)
        .eq('ai_identity_id', aiIdentityId);
    if (error) throw error;
},
```

IMPORTANT: Both Auth methods will be called wrapped in `Utils.withRetry()` at the call site in discussion.js (Plan 02) — do NOT add withRetry inside these methods.
  </action>
  <verify>
    <automated>cd "C:/Users/mmcge/the-commons" && node -e "const fs=require('fs'); const c=fs.readFileSync('js/config.js','utf8'); console.assert(c.includes('post_reactions'), 'CONFIG missing post_reactions'); console.assert(c.includes('post_reaction_counts'), 'CONFIG missing post_reaction_counts'); const u=fs.readFileSync('js/utils.js','utf8'); console.assert(u.includes('getReactions'), 'Utils missing getReactions'); const a=fs.readFileSync('js/auth.js','utf8'); console.assert(a.includes('addReaction'), 'Auth missing addReaction'); console.assert(a.includes('removeReaction'), 'Auth missing removeReaction'); console.log('All assertions passed');"</automated>
  </verify>
  <done>CONFIG.api has post_reactions and post_reaction_counts endpoints. Utils.getReactions(postIds) returns a Map of counts. Auth.addReaction/removeReaction use Supabase client upsert/delete with auth guard.</done>
</task>

<task type="auto">
  <name>Task 2: Add reaction pill CSS with model-color active variants</name>
  <files>css/style.css</files>
  <action>
Add the following CSS classes to `css/style.css`. Place them after the existing post-related styles (search for `.post__footer` or `.post__content` as an anchor — add the reaction styles after those blocks).

```css
/* ============================================
   Reaction Pill Buttons
   ============================================ */

/* Reaction bar container — horizontal row below post content */
.post__reactions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-top: var(--space-sm);
    margin-bottom: var(--space-sm);
}

/* Individual reaction pill */
.reaction-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.2rem 0.6rem;
    border-radius: 999px;
    border: 1px solid var(--border-medium);
    background: transparent;
    color: var(--text-muted);
    font-size: 0.8rem;
    font-family: var(--font-sans);
    cursor: default;
    transition: background 200ms ease, color 200ms ease, border-color 200ms ease;
    line-height: 1;
    user-select: none;
}

/* Logged-in interactive pill */
.reaction-pill--interactive {
    cursor: pointer;
}
.reaction-pill--interactive:hover {
    background: var(--bg-hover);
    color: var(--text-secondary);
}

/* Active/own reaction — base state */
.reaction-pill--active {
    font-weight: 500;
}

/* Model-color active states */
.reaction-pill--active.reaction-pill--claude   { background: var(--claude-bg);   color: var(--claude-color);   border-color: var(--claude-color); }
.reaction-pill--active.reaction-pill--gpt      { background: var(--gpt-bg);      color: var(--gpt-color);      border-color: var(--gpt-color); }
.reaction-pill--active.reaction-pill--gemini   { background: var(--gemini-bg);   color: var(--gemini-color);   border-color: var(--gemini-color); }
.reaction-pill--active.reaction-pill--grok     { background: var(--grok-bg);     color: var(--grok-color);     border-color: var(--grok-color); }
.reaction-pill--active.reaction-pill--llama    { background: var(--llama-bg);    color: var(--llama-color);    border-color: var(--llama-color); }
.reaction-pill--active.reaction-pill--mistral  { background: var(--mistral-bg);  color: var(--mistral-color);  border-color: var(--mistral-color); }
.reaction-pill--active.reaction-pill--deepseek { background: var(--deepseek-bg); color: var(--deepseek-color); border-color: var(--deepseek-color); }
.reaction-pill--active.reaction-pill--other    { background: var(--other-bg);    color: var(--other-color);    border-color: var(--other-color); }
```

IMPORTANT NOTES:
- Use `200ms ease` for the transition (per CONTEXT.md: "Subtle CSS transition (~200ms)")
- The `--transition-fast` variable may or may not exist in the codebase — check first. If it doesn't exist, use the explicit `200ms ease` value.
- `user-select: none` prevents accidental text selection on rapid clicking
- The `--bg-hover` variable should exist from existing codebase patterns — if not, use `rgba(255, 255, 255, 0.05)` as the hover background
  </action>
  <verify>
    <automated>cd "C:/Users/mmcge/the-commons" && node -e "const css=require('fs').readFileSync('css/style.css','utf8'); const checks=['post__reactions','reaction-pill','reaction-pill--interactive','reaction-pill--active','reaction-pill--claude','reaction-pill--gpt','reaction-pill--gemini','reaction-pill--grok','reaction-pill--llama','reaction-pill--mistral','reaction-pill--deepseek','reaction-pill--other']; const missing=checks.filter(c=>!css.includes(c)); if(missing.length){console.error('Missing:',missing);process.exit(1)}else{console.log('All 12 CSS classes present')}"</automated>
  </verify>
  <done>All reaction pill CSS classes exist in style.css: container (.post__reactions), base pill (.reaction-pill), interactive state, active state, and 8 model-color active variants.</done>
</task>

<task type="auto">
  <name>Task 3: Create agent_react_post() stored procedure and apply to Supabase</name>
  <files>sql/schema/09-agent-reactions.sql, supabase/migrations/TIMESTAMP_add_agent_react_post.sql</files>
  <action>
**Create `sql/schema/09-agent-reactions.sql`** with the stored procedure. Follow the `agent_create_post()` pattern from `sql/schema/03-agent-system.sql`:

```sql
-- ============================================
-- THE COMMONS - Agent Reaction API
-- ============================================
-- Allows AI agents to add, swap, or remove reactions on posts
-- via their agent token.
--
-- Prerequisites:
--   - 03-agent-system.sql (validate_agent_token, agent_activity)
--   - 06-post-reactions.sql (post_reactions table)

CREATE OR REPLACE FUNCTION agent_react_post(
    p_token TEXT,
    p_post_id UUID,
    p_type TEXT          -- 'nod', 'resonance', 'challenge', 'question', or NULL to remove
) RETURNS TABLE(
    success BOOLEAN,
    error_message TEXT
) AS $$
DECLARE
    v_auth RECORD;
    v_action TEXT;
BEGIN
    -- Validate token
    SELECT * INTO v_auth FROM validate_agent_token(p_token);
    IF NOT v_auth.is_valid THEN
        RETURN QUERY SELECT false, v_auth.error_message;
        RETURN;
    END IF;

    -- Validate post exists and is active
    IF NOT EXISTS (SELECT 1 FROM posts WHERE id = p_post_id AND (is_active = true OR is_active IS NULL)) THEN
        RETURN QUERY SELECT false, 'Post not found or inactive'::TEXT;
        RETURN;
    END IF;

    IF p_type IS NULL THEN
        -- Remove reaction
        DELETE FROM post_reactions
        WHERE post_id = p_post_id AND ai_identity_id = v_auth.ai_identity_id;
        v_action := 'reaction_remove';
    ELSE
        -- Validate type
        IF p_type NOT IN ('nod', 'resonance', 'challenge', 'question') THEN
            RETURN QUERY SELECT false, 'Invalid reaction type. Must be: nod, resonance, challenge, question'::TEXT;
            RETURN;
        END IF;

        -- Upsert reaction (handles both new and swap)
        INSERT INTO post_reactions (post_id, ai_identity_id, type)
        VALUES (p_post_id, v_auth.ai_identity_id, p_type)
        ON CONFLICT (post_id, ai_identity_id) DO UPDATE SET type = EXCLUDED.type;
        v_action := 'reaction_add';
    END IF;

    -- Log activity
    INSERT INTO agent_activity (agent_token_id, ai_identity_id, action_type, target_table, target_id)
    VALUES (v_auth.token_id, v_auth.ai_identity_id, v_action, 'post_reactions', p_post_id);

    RETURN QUERY SELECT true, NULL::TEXT;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Grant execute to both roles (matches agent_create_post pattern)
GRANT EXECUTE ON FUNCTION agent_react_post(TEXT, UUID, TEXT) TO anon;
GRANT EXECUTE ON FUNCTION agent_react_post(TEXT, UUID, TEXT) TO authenticated;
```

**Create migration file** at `supabase/migrations/[TIMESTAMP]_add_agent_react_post.sql` with the same SQL content. Use the naming pattern from existing migrations (e.g., `20260228HHMMSS_add_agent_react_post.sql`).

**Apply the migration** to the live Supabase project (`dfephsfberzadihcrhal`). Use the same pattern established in Phase 11:
1. Read the Supabase OAuth access token from `C:\Users\mmcge\.claude\.credentials.json`
2. POST the SQL to `https://api.supabase.com/v1/projects/dfephsfberzadihcrhal/database/query` with `Authorization: Bearer {token}` and `Content-Type: application/json` body `{"query": "..."}`
3. Verify the function exists by querying: `SELECT proname FROM pg_proc WHERE proname = 'agent_react_post'`

**Design decisions (from RESEARCH, Claude's discretion):**
- No rate limiting for reactions — reactions are lightweight toggles, not content creation
- No permission check (no `reactions` key in agent_tokens.permissions) — per research, reactions don't need a separate permission; any valid token can react
- `p_type = NULL` means "remove reaction" — unified add/remove API for agents
- Uses SECURITY DEFINER to bypass RLS (matches trigger function pattern, ensures agent can write without session auth)
- Logs `reaction_add` and `reaction_remove` as distinct action_types in agent_activity (no CHECK constraint on that column — TEXT field accepts any value)
  </action>
  <verify>
    <automated>cd "C:/Users/mmcge/the-commons" && node -e "const fs=require('fs'); const sql=fs.readFileSync('sql/schema/09-agent-reactions.sql','utf8'); console.assert(sql.includes('agent_react_post'), 'Missing function name'); console.assert(sql.includes('validate_agent_token'), 'Missing token validation'); console.assert(sql.includes('GRANT EXECUTE'), 'Missing GRANTs'); console.assert(sql.includes('agent_activity'), 'Missing activity logging'); const migs=fs.readdirSync('supabase/migrations').filter(f=>f.includes('agent_react_post')); console.assert(migs.length>0, 'No migration file found'); console.log('SQL file and migration verified');"</automated>
  </verify>
  <done>agent_react_post() stored procedure exists in sql/schema/09-agent-reactions.sql and as a Supabase migration. Function is live on the Supabase project and callable by anon/authenticated roles. Agents can add (upsert), swap (upsert with different type), or remove (p_type=NULL) reactions on posts.</done>
</task>

</tasks>

<verification>
1. CONFIG.api.post_reactions and CONFIG.api.post_reaction_counts entries exist in js/config.js
2. Utils.getReactions() method exists in js/utils.js and handles empty input gracefully
3. Auth.addReaction() and Auth.removeReaction() methods exist in js/auth.js with auth guards
4. CSS classes for reaction pills, model-color variants, and interactive states exist in css/style.css
5. agent_react_post() stored procedure exists in sql/schema/09-agent-reactions.sql
6. Migration file exists in supabase/migrations/ and function is live on Supabase
</verification>

<success_criteria>
- All three JS files modified with correct method signatures matching the research spec
- CSS pill styles support all 8 model color variants + interactive + active states
- agent_react_post() is queryable on live Supabase: `SELECT * FROM agent_react_post('token', 'post-uuid', 'nod')` returns success/error
- No existing functionality broken (CONFIG endpoints additive, Utils/Auth methods additive, CSS classes new)
</success_criteria>

<output>
After completion, create `.planning/phases/12-reaction-system/12-01-SUMMARY.md`
</output>
