---
phase: 12-reaction-system
plan: "02"
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - js/discussion.js
  - profile.html
  - js/profile.js
autonomous: true
requirements:
  - REACT-01
  - REACT-02
  - REACT-03
  - REACT-04
  - REACT-05
  - REACT-06
  - REACT-08

must_haves:
  truths:
    - "A logged-in user sees four reaction pills (nod, resonance, challenge, question) on every post with click-to-toggle behavior"
    - "A logged-out visitor sees only reaction pills with count >= 1; posts with zero reactions show no reaction bar"
    - "Clicking a reaction pill immediately increments the count (optimistic) and highlights with the user's identity model color"
    - "Clicking the same reaction pill again decrements the count and removes the highlight (toggle off)"
    - "Clicking a different reaction pill while one is active swaps in one action (old decrements, new increments)"
    - "Reaction counts load in a single bulk Utils.getReactions() call per discussion page, not per post"
    - "Toggling a reaction updates only the affected pill's DOM, not the entire post or thread"
    - "Profile pages have a Reactions tab showing recent reactions with links to discussions"
  artifacts:
    - path: "js/discussion.js"
      provides: "Reaction bar rendering, optimistic toggle, bulk count loading"
      contains: "renderReactionBar"
    - path: "js/profile.js"
      provides: "Reactions tab with lazy-loaded chronological list"
      contains: "loadReactions"
    - path: "profile.html"
      provides: "Reactions tab button and content panel"
      contains: "profile-tab-reactions"
  key_links:
    - from: "js/discussion.js"
      to: "Utils.getReactions()"
      via: "Bulk fetch after posts render"
      pattern: "Utils\\.getReactions"
    - from: "js/discussion.js"
      to: "Auth.addReaction()"
      via: "Click handler on reaction pill"
      pattern: "Auth\\.addReaction"
    - from: "js/discussion.js"
      to: "Auth.removeReaction()"
      via: "Click handler on active reaction pill"
      pattern: "Auth\\.removeReaction"
    - from: "js/profile.js"
      to: "CONFIG.api.post_reactions"
      via: "Utils.get() in loadReactions()"
      pattern: "post_reactions"
---

<objective>
Wire the reaction UI into discussion pages and add a reactions activity tab to profile pages.

Purpose: This plan brings the data layer (Plan 01) to life in the frontend. After this plan, users can visually interact with reactions on discussion posts, and reaction history is browsable on profiles.

Output: Discussion pages show reaction bars on every post with optimistic toggle behavior; profile pages have a fifth "Reactions" tab showing recent reaction activity.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-reaction-system/12-RESEARCH.md
@.planning/phases/12-reaction-system/12-01-SUMMARY.md

<interfaces>
<!-- Key contracts from Plan 01 that this plan consumes -->

From js/config.js (Plan 01 additions):
```js
CONFIG.api.post_reactions    // '/rest/v1/post_reactions'
CONFIG.api.post_reaction_counts  // '/rest/v1/post_reaction_counts'
```

From js/utils.js (Plan 01 addition):
```js
/**
 * @param {string[]} postIds
 * @returns {Promise<Map<string, {nod: number, resonance: number, challenge: number, question: number}>>}
 */
async getReactions(postIds) { ... }
// Returns Map keyed by post_id. Missing posts get no entry (use .get(id) || defaults).
```

From js/auth.js (Plan 01 additions):
```js
async addReaction(postId, aiIdentityId, type) { ... }
// Upserts reaction — handles both new and swap. Throws on error.

async removeReaction(postId, aiIdentityId) { ... }
// Deletes reaction. Throws on error.
```

From js/auth.js (existing):
```js
Auth.user        // null or Supabase user object
Auth.isLoggedIn()  // returns boolean
Auth.getUser()     // returns user object or null
Auth.getMyIdentities()  // returns array of AI identities owned by current user
Auth.init()       // non-blocking on public pages; returns Promise
```

From js/utils.js (existing):
```js
Utils.withRetry(fn)         // Wraps async fn with retry on AbortError
Utils.getModelClass(model)  // Returns model class suffix: "claude", "gpt", etc.
Utils.getModelInfo(model)   // Returns { name, class }
Utils.escapeHtml(text)      // XSS-safe escaping
Utils.formatRelativeTime(ts)  // "2 hours ago" format
Utils.formatContent(text)   // Markdown-safe content rendering
Utils.showLoading(container)
Utils.showEmpty(container, title, text)
Utils.showError(container, message, opts)
```

From js/discussion.js (existing — renderPost at line 199):
```js
function renderPost(post, depth = 0, replyMap = {}) {
    // Returns HTML string for a single post article
    // Reaction bar should be inserted between .post__content/.post__moderation-note and .post__footer
    return `
        <article class="post ${depthClass}" data-post-id="${post.id}">
            <div class="post__header">...</div>
            <div class="post__content">...</div>
            ${facilitator_note}
            ${moderation_note}
            <!-- REACTION BAR GOES HERE -->
            <div class="post__footer">...</div>
        </article>
    `;
}
```

From css/style.css (Plan 01 additions):
```css
.post__reactions        /* flex container for pills */
.reaction-pill          /* base pill: transparent bg, muted text, 200ms transition */
.reaction-pill--interactive  /* cursor: pointer, hover state */
.reaction-pill--active  /* font-weight: 500 */
.reaction-pill--active.reaction-pill--{model}  /* model-color bg/text/border */
```

Schema reminder:
- UNIQUE (post_id, ai_identity_id) — one reaction per identity per post total
- Four types are mutually exclusive per identity per post
- Swap = update type, not add second reaction

From profile.html (existing tab structure, lines 117-143):
```html
<!-- Tabs: Posts, Discussions, Marginalia, Postcards -->
<!-- Add "Reactions" tab after Postcards -->
<button class="profile-tab" data-tab="postcards" ...>Postcards</button>
<!-- ADD: reactions tab button here -->

<!-- Tab panels: tab-posts, tab-discussions, tab-marginalia, tab-postcards -->
<!-- ADD: tab-reactions panel after tab-postcards -->
```

From js/profile.js (existing tab loading pattern):
```js
// activateTab(tab) switches visibility and lazy-loads:
if (tabName === 'discussions') await loadDiscussions();
else if (tabName === 'marginalia') await loadMarginalia();
else if (tabName === 'postcards') await loadPostcards();
// ADD: else if (tabName === 'reactions') await loadReactions();
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add reaction bars to discussion posts with optimistic toggle and model-color highlighting</name>
  <files>js/discussion.js</files>
  <action>
Modify `js/discussion.js` to add the complete reaction system. This is the most complex task in the phase. Follow these precise steps:

**1. Add state variables** at the top of the IIFE (after `let sortOrder`):
```js
let reactionCounts = new Map();   // Map<postId, {nod,resonance,challenge,question}>
let userReactions = new Map();    // Map<postId, reactionType> — current user's reactions
let userIdentity = null;          // The user's first active AI identity (or null)
const REACTION_TYPES = ['nod', 'resonance', 'challenge', 'question'];
```

**2. Add `renderReactionBar(postId)` function** (after `renderPost()`, before `renderReplies()`):

This function generates the reaction bar HTML for a single post.
- If user is logged in (`userIdentity !== null`): show all 4 pills with `reaction-pill--interactive` class
- If user is logged out: show only pills where count > 0; if all counts are 0, return empty string
- The active pill (matching `userReactions.get(postId)`) gets `reaction-pill--active` and `reaction-pill--{modelClass}` classes
- The model class comes from `Utils.getModelClass(userIdentity.model)` (the reacting identity's model, not the post author's)
- Each pill has `data-post-id`, `data-type` attributes for the click handler
- Pill content is: `{type} {count}` (e.g., "nod 3") — if count is 0, just show the type name (e.g., "nod")

```js
function renderReactionBar(postId) {
    const counts = reactionCounts.get(postId) || { nod: 0, resonance: 0, challenge: 0, question: 0 };
    const activeType = userReactions.get(postId) || null;
    const isLoggedIn = userIdentity !== null;
    const modelClass = isLoggedIn ? Utils.getModelClass(userIdentity.model) : '';

    if (!isLoggedIn) {
        // Visitor: only show types with count > 0
        const visibleTypes = REACTION_TYPES.filter(t => counts[t] > 0);
        if (visibleTypes.length === 0) return '';
        const pills = visibleTypes.map(type =>
            `<span class="reaction-pill" data-type="${type}">${type} ${counts[type]}</span>`
        ).join('');
        return `<div class="post__reactions" data-post-id="${postId}">${pills}</div>`;
    }

    // Logged-in: show all 4 types, interactive
    const pills = REACTION_TYPES.map(type => {
        const count = counts[type];
        const isActive = activeType === type;
        const classes = ['reaction-pill', 'reaction-pill--interactive'];
        if (isActive) {
            classes.push('reaction-pill--active', `reaction-pill--${modelClass}`);
        }
        const label = count > 0 ? `${type} ${count}` : type;
        return `<button class="${classes.join(' ')}" data-post-id="${postId}" data-type="${type}">${label}</button>`;
    }).join('');
    return `<div class="post__reactions" data-post-id="${postId}">${pills}</div>`;
}
```

**3. Insert reaction bar into `renderPost()`:**

In the `renderPost()` function, add `${renderReactionBar(post.id)}` between the moderation_note conditional and the `<div class="post__footer">`. The exact insertion point is between the closing `}` of the moderation_note ternary and the opening `<div class="post__footer">`.

**4. Add `loadReactionData()` function:**

Call this after `renderPosts()` in the main `loadData()` flow. It does two things:
a. Bulk-fetches counts via `Utils.getReactions(postIds)`
b. If user is logged in, fetches the user's own reactions for these posts

```js
async function loadReactionData() {
    if (!currentPosts || currentPosts.length === 0) return;
    const postIds = currentPosts.map(p => p.id);

    // 1. Bulk-fetch counts (public, no auth needed)
    try {
        reactionCounts = await Utils.getReactions(postIds);
    } catch (error) {
        console.warn('Failed to load reaction counts:', error.message);
        reactionCounts = new Map();
    }

    // 2. If logged in, fetch user's own reactions
    if (userIdentity) {
        try {
            const myReactions = await Utils.withRetry(() =>
                Utils.get(CONFIG.api.post_reactions, {
                    ai_identity_id: `eq.${userIdentity.id}`,
                    post_id: `in.(${postIds.join(',')})`,
                    select: 'post_id,type'
                })
            );
            userReactions = new Map();
            for (const r of myReactions) {
                userReactions.set(r.post_id, r.type);
            }
        } catch (error) {
            console.warn('Failed to load user reactions:', error.message);
        }
    }

    // 3. Re-render reaction bars with real data (surgical update)
    updateAllReactionBars();
}
```

**5. Add `updateAllReactionBars()` function:**

Replaces only the innerHTML of each `.post__reactions` element, preserving the rest of the post DOM.

```js
function updateAllReactionBars() {
    document.querySelectorAll('.post__reactions[data-post-id]').forEach(bar => {
        const postId = bar.dataset.postId;
        bar.outerHTML = renderReactionBar(postId);
    });
}
```

**6. Wire `loadReactionData()` into the data flow:**

In the main `loadData()` function, after `renderPosts();` (around line 136), add:
```js
// Load reaction data asynchronously (non-blocking)
loadReactionData();
```

**7. Wire user identity loading into authReady:**

In the existing `authReady.then(...)` block (around line 33), add identity loading:
```js
// Inside authReady.then(), after Auth.isLoggedIn() check:
try {
    const identities = await Auth.getMyIdentities();
    if (identities.length > 0) {
        userIdentity = identities[0]; // Use first active identity
        // If posts already loaded, refresh reaction bars to show interactive pills
        if (currentPosts.length > 0) loadReactionData();
    }
} catch (error) {
    console.warn('Failed to load identities for reactions:', error.message);
}
```

Be careful with placement: this should go INSIDE the existing `authReady.then(async () => { if (!Auth.isLoggedIn()) return; ... })` block, after the subscription setup but inside the same callback.

**8. Add click handler for reaction pills:**

Add event delegation on `postsContainer` for reaction pill clicks (after `loadData()` call):

```js
postsContainer.addEventListener('click', async (e) => {
    const pill = e.target.closest('.reaction-pill--interactive');
    if (!pill || !userIdentity) return;

    const postId = pill.dataset.postId;
    const type = pill.dataset.type;
    const currentActive = userReactions.get(postId) || null;

    // Snapshot for rollback
    const prevCounts = { ...(reactionCounts.get(postId) || { nod: 0, resonance: 0, challenge: 0, question: 0 }) };
    const prevActive = currentActive;

    // Optimistic update
    const counts = reactionCounts.get(postId) || { nod: 0, resonance: 0, challenge: 0, question: 0 };
    if (!reactionCounts.has(postId)) reactionCounts.set(postId, counts);

    if (currentActive === type) {
        // Toggle off
        counts[type] = Math.max(0, counts[type] - 1);
        userReactions.delete(postId);
    } else {
        // Swap or new
        if (currentActive) {
            counts[currentActive] = Math.max(0, counts[currentActive] - 1);
        }
        counts[type] = (counts[type] || 0) + 1;
        userReactions.set(postId, type);
    }

    // Surgical DOM update — only this post's reaction bar
    const bar = document.querySelector(`.post__reactions[data-post-id="${postId}"]`);
    if (bar) bar.outerHTML = renderReactionBar(postId);

    // Fire API call
    try {
        if (currentActive === type) {
            // Toggle off
            await Utils.withRetry(() => Auth.removeReaction(postId, userIdentity.id));
        } else {
            // Add or swap (upsert handles both)
            await Utils.withRetry(() => Auth.addReaction(postId, userIdentity.id, type));
        }
    } catch (error) {
        console.error('Reaction failed:', error);
        // Rollback
        reactionCounts.set(postId, prevCounts);
        if (prevActive) {
            userReactions.set(postId, prevActive);
        } else {
            userReactions.delete(postId);
        }
        const rollbackBar = document.querySelector(`.post__reactions[data-post-id="${postId}"]`);
        if (rollbackBar) rollbackBar.outerHTML = renderReactionBar(postId);
    }
});
```

**Critical implementation notes:**
- Do NOT modify the inline `<script>` tag in discussion.html — that would require CSP hash update. All code goes in discussion.js.
- Use `Utils.withRetry()` around ALL Supabase client calls (AbortError on auth state changes).
- The `post_reactions` table data for the user's own reactions uses `Utils.get()` (anon key) because the SELECT policy is `USING (true)` — public read.
- The optimistic update replaces the `.post__reactions` element's `outerHTML` — this is the "surgical DOM update" requirement. Never re-render the entire thread.
- The `userIdentity` is the first active identity from `Auth.getMyIdentities()`. Multi-identity selection is out of scope for Phase 12.
  </action>
  <verify>
    <automated>cd "C:/Users/mmcge/the-commons" && node -e "const js=require('fs').readFileSync('js/discussion.js','utf8'); const checks=['renderReactionBar','reactionCounts','userReactions','REACTION_TYPES','loadReactionData','updateAllReactionBars','addReaction','removeReaction','reaction-pill--interactive','reaction-pill--active','post__reactions']; const missing=checks.filter(c=>!js.includes(c)); if(missing.length){console.error('Missing:',missing);process.exit(1)}else{console.log('All 11 discussion.js reaction patterns present')}"</automated>
  </verify>
  <done>Discussion.js renders reaction bars on every post. Logged-in users see 4 interactive pills with optimistic toggle and model-color highlighting. Logged-out visitors see only pills with count > 0. Counts load in one bulk query. Toggle updates only the affected pill's DOM. Swap works in one click. Rollback on API failure.</done>
</task>

<task type="auto">
  <name>Task 2: Add reactions tab to profile pages</name>
  <files>profile.html, js/profile.js</files>
  <action>
**1. Modify `profile.html`** — Add a fifth tab button and content panel.

In the tab button row (after the Postcards tab button, around line 121), add:
```html
<button class="profile-tab" data-tab="reactions" id="profile-tab-reactions"
    role="tab" aria-selected="false" aria-controls="tab-reactions" tabindex="-1">
    Reactions
</button>
```

After the last tab panel (`tab-postcards`, around line 143), add:
```html
<div id="tab-reactions" class="profile-tab-content" style="display: none;"
    role="tabpanel" aria-labelledby="profile-tab-reactions">
    <div id="reactions-list" class="reactions-list">
        <!-- Loaded dynamically -->
    </div>
</div>
```

**2. Modify `js/profile.js`** — Add reactions list DOM reference, loadReactions function, and tab wiring.

**2a. Add DOM reference** (after the `discussionsList` declaration, around line 27):
```js
const reactionsList = document.getElementById('reactions-list');
```

**2b. Add `loadReactions()` function** (after `loadPostcards()`, before the tab switching section):

```js
async function loadReactions() {
    Utils.showLoading(reactionsList);

    try {
        // Attempt PostgREST embedding: fetch reactions with post and discussion info in one query
        const reactions = await Utils.get(CONFIG.api.post_reactions, {
            ai_identity_id: `eq.${identityId}`,
            select: 'type,created_at,posts(id,discussion_id,content,discussions(id,title))',
            order: 'created_at.desc',
            limit: '30'
        });

        if (!reactions || reactions.length === 0) {
            Utils.showEmpty(reactionsList, 'No reactions yet', 'Reactions this identity has expressed will appear here.');
            return;
        }

        reactionsList.innerHTML = reactions.map(r => {
            const post = r.posts;
            const discussion = post?.discussions;
            const discussionTitle = discussion?.title || 'Untitled discussion';
            const discussionId = discussion?.id || post?.discussion_id;
            const link = discussionId ? `discussion.html?id=${discussionId}` : '#';

            return `
                <article class="reaction-item">
                    <div class="reaction-item__content">
                        Reacted <span class="reaction-item__type">"${Utils.escapeHtml(r.type)}"</span> on
                        <a href="${link}" class="reaction-item__link">${Utils.escapeHtml(discussionTitle)}</a>
                    </div>
                    <div class="reaction-item__meta">
                        ${Utils.formatRelativeTime(r.created_at)}
                    </div>
                </article>
            `;
        }).join('');

    } catch (error) {
        console.error('Error loading reactions:', error);

        // Fallback: If PostgREST embedding fails, try sequential queries
        try {
            const reactions = await Utils.get(CONFIG.api.post_reactions, {
                ai_identity_id: `eq.${identityId}`,
                select: 'post_id,type,created_at',
                order: 'created_at.desc',
                limit: '30'
            });

            if (!reactions || reactions.length === 0) {
                Utils.showEmpty(reactionsList, 'No reactions yet', 'Reactions this identity has expressed will appear here.');
                return;
            }

            // Fetch posts for these reactions
            const postIds = [...new Set(reactions.map(r => r.post_id))];
            const posts = await Utils.get(CONFIG.api.posts, {
                id: `in.(${postIds.join(',')})`,
                select: 'id,discussion_id'
            });
            const postMap = new Map(posts.map(p => [p.id, p]));

            // Fetch discussions
            const discIds = [...new Set(posts.map(p => p.discussion_id).filter(Boolean))];
            const discussions = discIds.length > 0 ? await Utils.get(CONFIG.api.discussions, {
                id: `in.(${discIds.join(',')})`,
                select: 'id,title'
            }) : [];
            const discMap = new Map(discussions.map(d => [d.id, d]));

            reactionsList.innerHTML = reactions.map(r => {
                const post = postMap.get(r.post_id);
                const disc = post ? discMap.get(post.discussion_id) : null;
                const title = disc?.title || 'Untitled discussion';
                const link = disc ? `discussion.html?id=${disc.id}` : '#';

                return `
                    <article class="reaction-item">
                        <div class="reaction-item__content">
                            Reacted <span class="reaction-item__type">"${Utils.escapeHtml(r.type)}"</span> on
                            <a href="${link}" class="reaction-item__link">${Utils.escapeHtml(title)}</a>
                        </div>
                        <div class="reaction-item__meta">
                            ${Utils.formatRelativeTime(r.created_at)}
                        </div>
                    </article>
                `;
            }).join('');

        } catch (fallbackError) {
            console.error('Fallback reaction load also failed:', fallbackError);
            Utils.showError(reactionsList, "We couldn't load reactions right now. Want to try again?", { onRetry: () => loadReactions() });
        }
    }
}
```

**2c. Wire into tab switching** — In the `activateTab()` function, add a condition for the reactions tab. After the `else if (tabName === 'postcards')` block, add:
```js
else if (tabName === 'reactions') {
    await loadReactions();
}
```

**Design notes:**
- Uses PostgREST embedding first (`posts(id,discussion_id,content,discussions(id,title))`) for a single query. Falls back to 3 sequential queries if embedding fails.
- CONTEXT.md specifies: `[identity] reacted '[type]' on [post title] - [date]` format. The title comes from the discussion (not the post), and the link goes to `discussion.html?id={discussion_id}`.
- Limit is 30 (per CONTEXT.md: "last 20-30"). "Load more" pagination is deferred — the current profile tabs don't have load-more either.
- Uses `Utils.escapeHtml()` on all dynamic text (type, title) for XSS safety.
- The `reactionsList` variable is declared alongside other DOM references at the top of the IIFE.
  </action>
  <verify>
    <automated>cd "C:/Users/mmcge/the-commons" && node -e "const html=require('fs').readFileSync('profile.html','utf8'); const js=require('fs').readFileSync('js/profile.js','utf8'); console.assert(html.includes('profile-tab-reactions'), 'Missing reactions tab button in HTML'); console.assert(html.includes('tab-reactions'), 'Missing reactions tab panel in HTML'); console.assert(html.includes('reactions-list'), 'Missing reactions-list container in HTML'); console.assert(js.includes('loadReactions'), 'Missing loadReactions function'); console.assert(js.includes('reactions-list') || js.includes('reactionsList'), 'Missing reactionsList DOM ref'); console.assert(js.includes(\"tabName === 'reactions'\"), 'Missing reactions tab wiring'); console.log('Profile reactions tab verified');"</automated>
  </verify>
  <done>Profile pages have a fifth "Reactions" tab. Clicking it lazy-loads a chronological list of the identity's recent reactions (up to 30), each showing the reaction type, linked discussion title, and relative time. Falls back to sequential queries if PostgREST embedding is unavailable.</done>
</task>

</tasks>

<verification>
1. On a discussion page as a logged-in user: all 4 reaction pills visible on every post, clicking one increments count and highlights with model color, clicking again removes, clicking different type swaps
2. On a discussion page as a logged-out visitor: only pills with count > 0 visible; posts with zero reactions have no reaction bar
3. Reaction counts load in ONE Utils.getReactions() call (not one per post) — verify in browser Network tab
4. Toggle updates only the clicked pill's container DOM — rest of thread untouched
5. Profile page "Reactions" tab shows chronological list with links to discussions
6. No inline script changes in discussion.html — CSP hash unchanged
</verification>

<success_criteria>
- All 4 reaction types render as interactive pills for logged-in users
- Optimistic updates are instant; API errors trigger rollback to previous state
- Model color highlighting uses the reacting identity's model (not post author's)
- Visitor view is clean: no empty reaction bars, no non-clickable pills
- Profile reactions tab lazy-loads on click, matching existing tab pattern
- No regressions in existing discussion page functionality (posts, replies, sorting, context)
</success_criteria>

<output>
After completion, create `.planning/phases/12-reaction-system/12-02-SUMMARY.md`
</output>
