---
phase: 17-css-foundation-auth-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - css/style.css
  - voices.html
  - profile.html
autonomous: true
requirements:
  - CSS-01
  - CSS-02
  - CSS-03
  - CSS-04
  - CSS-05
  - CSS-06
  - AUTH-01
  - AUTH-02

must_haves:
  truths:
    - "Text cards, marginalia items, news cards, and directed question badges display with visible non-transparent backgrounds"
    - "News cards render in Crimson Pro / Source Sans 3 fonts"
    - "The .form-error CSS rule appears exactly once in style.css"
    - "On voices.html the nav bar reflects logged-in vs logged-out state on page load"
    - "On profile.html the nav bar reflects logged-in vs logged-out state on page load"
  artifacts:
    - path: "css/style.css"
      provides: "Complete CSS custom property definitions in :root and single .form-error rule"
      contains: "--bg-card|--bg-raised|--transition-normal|--space-xxl|--text-link|--border-light|--font-body|--font-heading"
    - path: "voices.html"
      provides: "Auth.init() inline script for nav state"
      contains: "Auth.init()"
    - path: "profile.html"
      provides: "Auth.init() inline script for nav state"
      contains: "Auth.init()"
  key_links:
    - from: "css/style.css :root"
      to: "css/style.css usage sites"
      via: "CSS custom property references"
      pattern: "var\\(--bg-card\\)|var\\(--bg-raised\\)|var\\(--font-body\\)|var\\(--font-heading\\)"
    - from: "voices.html inline script"
      to: "js/auth.js Auth.init()"
      via: "DOMContentLoaded listener"
      pattern: "Auth\\.init\\(\\)"
    - from: "profile.html inline script"
      to: "js/auth.js Auth.init()"
      via: "DOMContentLoaded listener"
      pattern: "Auth\\.init\\(\\)"
---

<objective>
Fix all missing CSS custom properties and add Auth.init() to two pages missing it.

Purpose: The site uses CSS variables that were never defined in :root, causing transparent backgrounds, missing borders, fallback fonts, and broken transitions on multiple components. Two public pages (voices.html, profile.html) do not have the inline Auth.init() script block, so their nav bar does not reflect login state.

Output: css/style.css with 8 new :root variables and consolidated .form-error; voices.html and profile.html with Auth.init() inline scripts and updated CSP hashes.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@css/style.css
@voices.html
@profile.html
@index.html (reference for Auth.init() inline script pattern)

<interfaces>
<!-- Existing :root variables in css/style.css (lines 14-78) -->
<!-- The following variables ARE defined: -->
--bg-deep: #0f1114
--bg-primary: #161a1f
--bg-elevated: #1c2127
--bg-hover: #242a32
--text-primary: #e8e4dc
--text-secondary: #9ca3af
--text-muted: #6b7280
--accent-gold: #d4a574
--accent-gold-dim: #a67c52
--accent-gold-glow: rgba(212, 165, 116, 0.15)
--border-subtle: rgba(255, 255, 255, 0.06)
--border-medium: rgba(255, 255, 255, 0.1)
--font-serif: 'Crimson Pro', Georgia, serif
--font-sans: 'Source Sans 3', -apple-system, BlinkMacSystemFont, sans-serif
--font-mono: 'JetBrains Mono', monospace
--space-xs through --space-3xl (0.25rem to 4rem)
--transition-fast: 150ms ease
--transition-medium: 250ms ease
--transition-slow: 400ms ease

<!-- The following variables are MISSING and must be added: -->
--bg-card: #1c2127           (alias for --bg-elevated)
--bg-raised: #1c2127         (alias for --bg-elevated)
--transition-normal: 250ms ease  (alias for --transition-medium)
--space-xxl: 4rem            (alias for --space-3xl)
--text-link: #d4a574         (alias for --accent-gold)
--border-light: rgba(255, 255, 255, 0.06)  (alias for --border-subtle)
--font-body: 'Source Sans 3', -apple-system, BlinkMacSystemFont, sans-serif  (alias for --font-sans)
--font-heading: 'Crimson Pro', Georgia, serif  (alias for --font-serif)

<!-- Duplicate .form-error at lines 1082 and 1530 in style.css -->
<!-- Line 1082: font-size, color, margin-top -->
<!-- Line 1530: display:block, color, font-size, margin-top -->
<!-- Line 1537: .form-error:empty { display: none } -->

<!-- Auth.init() pattern from index.html (lines 256-261): -->
<script>
    // Initialize auth on page load
    document.addEventListener('DOMContentLoaded', () => {
        Auth.init();
    });
</script>

<!-- CSP: both voices.html and profile.html have Content-Security-Policy meta tags -->
<!-- with script-src containing SHA-256 hashes for inline scripts. -->
<!-- Adding a new inline script requires computing its SHA-256 hash and adding it. -->
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add missing CSS custom properties to :root and consolidate .form-error</name>
  <files>css/style.css</files>
  <action>
1. In the :root block (line 14-78), add 8 missing custom property definitions as aliases. Insert them as a new comment group after the existing Shadows section (after line 77, before the closing brace on line 78):

    /* Aliases â€” referenced throughout but not previously defined */
    --bg-card: #1c2127;
    --bg-raised: #1c2127;
    --transition-normal: 250ms ease;
    --space-xxl: 4rem;
    --text-link: #d4a574;
    --border-light: rgba(255, 255, 255, 0.06);
    --font-body: 'Source Sans 3', -apple-system, BlinkMacSystemFont, sans-serif;
    --font-heading: 'Crimson Pro', Georgia, serif;

These values are intentional aliases: --bg-card and --bg-raised map to the same value as --bg-elevated; --transition-normal maps to --transition-medium; --space-xxl maps to --space-3xl; --text-link maps to --accent-gold; --border-light maps to --border-subtle; --font-body maps to --font-sans; --font-heading maps to --font-serif. Use literal values (not var() references) so each property is self-contained and does not break if the "primary" name is ever removed.

2. Consolidate the duplicate .form-error definitions. The first definition is at line 1082 and the second at line 1530. Merge them into a single definition at line 1082 that includes ALL properties from both definitions plus the :empty rule from line 1537. The consolidated rule should be:

.form-error {
    display: block;
    font-size: 0.8125rem;
    color: #f87171;
    margin-top: var(--space-xs);
}

.form-error:empty {
    display: none;
}

Then DELETE the second .form-error block (lines 1529-1539, the "Inline form field errors" comment, the .form-error rule, and the .form-error:empty rule). Leave no orphan comment.
  </action>
  <verify>
    <automated>grep -c "\.form-error {" css/style.css | grep -q "^1$" && grep -c "\-\-bg-card" css/style.css | grep -q "^1$" && grep -c "\-\-font-heading" css/style.css | grep -q "^1$" && grep -c "\-\-bg-raised" css/style.css | grep -q "^1$" && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>
  - All 8 missing CSS variables (--bg-card, --bg-raised, --transition-normal, --space-xxl, --text-link, --border-light, --font-body, --font-heading) are defined in :root with correct values
  - .form-error appears exactly once in style.css (consolidated with display:block and :empty rule)
  - No duplicate .form-error definition remains
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Auth.init() inline script to voices.html and profile.html with CSP hash</name>
  <files>voices.html, profile.html</files>
  <action>
For BOTH voices.html and profile.html, add an inline script block after the last script src tag and before the closing body tag. Follow the exact pattern used in index.html (lines 256-261):

Between the line `<script src="js/voices.js"></script>` (or `js/profile.js`) and `</body>`, add:

    <script>
        // Initialize auth on page load
        document.addEventListener('DOMContentLoaded', () => {
            Auth.init();
        });
    </script>

IMPORTANT: After adding the inline script, compute its SHA-256 hash for the CSP meta tag. The hash must be computed from the EXACT content between the opening and closing script tags (including whitespace and newlines). Use Node.js crypto:

    node -e "const crypto = require('crypto'); const fs = require('fs'); const html = fs.readFileSync('voices.html', 'utf8'); const match = html.match(/<script>\s*\/\/ Initialize auth[^<]*<\/script>/); if (match) { const inner = match[0].replace(/<\/?script>/g, ''); const hash = crypto.createHash('sha256').update(inner).digest('base64'); console.log('sha256-' + hash); }"

Add the computed hash to the Content-Security-Policy meta tag's script-src directive in BOTH files. Insert it after the last existing sha256 hash in the script-src list.

Note: The CSP meta tags for voices.html and profile.html are on line 22 of each file. The hash goes inside the script-src section, formatted as 'sha256-XXXXX'.

CRITICAL: The whitespace in the inline script must match exactly what is hashed. Use the same indentation pattern as index.html. Test with the browser console -- if CSP blocks the script, the hash is wrong.
  </action>
  <verify>
    <automated>grep -c "Auth.init()" voices.html | grep -q "[1-9]" && grep -c "Auth.init()" profile.html | grep -q "[1-9]" && grep "script-src" voices.html | grep -qc "sha256-" && grep "script-src" profile.html | grep -qc "sha256-" && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>
  - voices.html has an inline script block calling Auth.init() on DOMContentLoaded
  - profile.html has an inline script block calling Auth.init() on DOMContentLoaded
  - Both pages' CSP meta tags include the SHA-256 hash for the new inline script
  - The nav bar will update login/logout state on both pages when loaded in a browser
  </done>
</task>

</tasks>

<verification>
1. Run: `grep -c "\.form-error {" css/style.css` -- must return exactly 1
2. Run: `grep "bg-card\|bg-raised\|transition-normal\|space-xxl\|text-link\|border-light\|font-body\|font-heading" css/style.css | head -8` -- all 8 variables present in :root
3. Run: `grep "Auth.init" voices.html` -- returns match
4. Run: `grep "Auth.init" profile.html` -- returns match
5. Open voices.html and profile.html in a browser -- no CSP errors in console, nav bar updates for logged-in users
</verification>

<success_criteria>
- All 8 CSS custom properties defined in :root with correct values
- Components using --bg-card, --bg-raised, --font-body, --font-heading, etc. render with visible backgrounds, correct fonts, and smooth transitions
- .form-error rule exists exactly once in style.css
- voices.html and profile.html call Auth.init() on DOMContentLoaded
- No CSP violations on either page
</success_criteria>

<output>
After completion, create `.planning/phases/17-css-foundation-auth-fixes/17-01-SUMMARY.md`
</output>
