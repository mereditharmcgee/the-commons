---
phase: 19-admin-bug-fixes
plan: 03
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - js/admin.js
autonomous: true
requirements:
  - ADM-04
  - ADM-08
  - ADM-09

must_haves:
  truths:
    - "deleteFacilitator is called via event delegation on a parent container, not via inline onclick string interpolation"
    - "editModerationNote is called via event delegation on a parent container, not via inline onclick backtick template injection"
    - "editModerationNote handler looks up the existing note from the cached posts array, not from a data attribute"
    - "window.deleteFacilitator and window.editModerationNote are removed -- they are internal functions called only via the delegation handler"
    - "No --transition-normal references remain in js/admin.js (ADM-04 spillover from Plan 02)"
  artifacts:
    - path: "js/admin.js"
      provides: "Event delegation for deleteFacilitator and editModerationNote, removed window exposure, fixed --transition-normal reference"
      contains: "data-action"
  key_links:
    - from: "js/admin.js"
      to: "renderUsers template"
      via: "data-action=delete-facilitator attribute replaces onclick"
      pattern: "data-action=\"delete-facilitator\""
    - from: "js/admin.js"
      to: "renderPosts template"
      via: "data-action=edit-moderation-note attribute replaces onclick"
      pattern: "data-action=\"edit-moderation-note\""
---

<objective>
Replace inline onclick handlers for deleteFacilitator and editModerationNote with event delegation using data attributes.

Purpose: The current inline onclick handlers use string interpolation with user data (email, moderation notes) which risks injection issues. Backtick template literals in onclick attributes are particularly fragile with special characters. Event delegation eliminates this entire class of bugs.
Output: Clean data-attribute-driven event delegation for the two specified functions, with no window-exposed functions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-admin-bug-fixes/19-01-SUMMARY.md
@js/admin.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert deleteFacilitator to event delegation</name>
  <files>js/admin.js</files>
  <action>
**ADM-08 -- deleteFacilitator uses data attributes instead of inline onclick string interpolation:**

Current inline onclick in `renderUsers` (around line 744):
```javascript
<button class="admin-item__btn admin-item__btn--danger" onclick="deleteFacilitator('${facilitator.id}', '${Utils.escapeHtml(facilitator.email)}')">Delete Account</button>
```

This string-interpolates the facilitator email into an onclick attribute. If the email contains a single quote or other special characters, the onclick breaks.

Step 1 - Change the button in `renderUsers` template to use data attributes instead:
```javascript
<button class="admin-item__btn admin-item__btn--danger" data-action="delete-facilitator" data-id="${facilitator.id}" data-email="${Utils.escapeHtml(facilitator.email)}">Delete Account</button>
```

Step 2 - Convert `window.deleteFacilitator` to an internal function (remove `window.` prefix):
```javascript
async function deleteFacilitator(id, email) {
    // ... same implementation, just not on window ...
}
```

Step 3 - Add event delegation on the users list container. In the DOMContentLoaded handler (around line 1310), after the user search filter listener, add:
```javascript
// Event delegation for users panel
const usersPanel = document.getElementById('panel-users');
if (usersPanel) {
    usersPanel.addEventListener('click', function(e) {
        const btn = e.target.closest('[data-action]');
        if (!btn) return;

        const action = btn.dataset.action;
        if (action === 'delete-facilitator') {
            deleteFacilitator(btn.dataset.id, btn.dataset.email);
        }
    });
}
```

Step 4 - Remove the `window.deleteFacilitator` assignment. The function is now internal and only called via delegation.

Do NOT change other inline onclick handlers (like toggleUserCard, or the moments buttons) -- per CONTEXT.md, only fix the 2 required functions.
  </action>
  <verify>
    <automated>cd C:/Users/mmcge/the-commons && grep -q 'data-action="delete-facilitator"' js/admin.js && ! grep -q "window.deleteFacilitator" js/admin.js && echo "ADM-08 OK"</automated>
  </verify>
  <done>deleteFacilitator button uses data-action attribute. Event delegation on users panel handles the click. No window.deleteFacilitator exposed.</done>
</task>

<task type="auto">
  <name>Task 2: Convert editModerationNote to event delegation and fix --transition-normal</name>
  <files>js/admin.js</files>
  <action>
**ADM-09 -- editModerationNote uses data attributes instead of inline onclick backtick templates:**

Current inline onclick in `renderPosts` (around line 426):
```javascript
<button class="admin-item__btn" onclick="editModerationNote('${post.id}', ${post.moderation_note ? `\`${Utils.escapeHtml(post.moderation_note).replace(/`/g, '\\`')}\`` : 'null'})">
    ${post.moderation_note ? 'Edit Note' : 'Add Note'}
</button>
```

This uses backtick template injection with escaped backticks inside an onclick attribute -- extremely fragile. Special characters in moderation notes can break the template.

Per CONTEXT.md decision: the handler should look up the existing note from the cached data array in memory, not store it in a data attribute. This avoids HTML escaping issues entirely.

Step 1 - Change the button in `renderPosts` template to use data attributes:
```javascript
<button class="admin-item__btn" data-action="edit-moderation-note" data-id="${post.id}">
    ${post.moderation_note ? 'Edit Note' : 'Add Note'}
</button>
```

No data-note attribute needed -- the handler will look up the note from the `posts` array.

Do NOT change `editMarginaliaModerationNote` or its inline onclick in `renderMarginalia`. Per CONTEXT.md locked decision: "Fix only the 2 required functions: deleteFacilitator and editModerationNote. Do NOT migrate other inline onclick handlers."

Step 2 - Convert `window.editModerationNote` to an internal function. Change the implementation to look up the note from the cached `posts` array:
```javascript
async function editModerationNote(id) {
    const post = posts.find(p => String(p.id) === String(id));
    const existingNote = post ? post.moderation_note : null;

    const note = prompt(
        'Moderation note (visible to all readers):\n\n' +
        'This note will appear on the public post.\n' +
        'Leave empty and click OK to remove an existing note.',
        existingNote || ''
    );

    if (note === null) return;

    try {
        await updateRecord('posts', id, { moderation_note: note.trim() || null });
        await loadPosts();
    } catch (error) {
        alert('Failed to update moderation note: ' + error.message);
    }
}
```

Step 3 - Add event delegation on the posts panel. In the DOMContentLoaded handler, add:
```javascript
// Event delegation for posts panel
const postsPanel = document.getElementById('panel-posts');
if (postsPanel) {
    postsPanel.addEventListener('click', function(e) {
        const btn = e.target.closest('[data-action]');
        if (!btn) return;

        if (btn.dataset.action === 'edit-moderation-note') {
            editModerationNote(btn.dataset.id);
        }
    });
}
```

Step 4 - Remove window exposure for editModerationNote only:
- Remove `window.editModerationNote = ...` -- now internal, called only via delegation handler
- Remove `window.deleteFacilitator = ...` -- already handled in Task 1
- Do NOT remove `window.editMarginaliaModerationNote` -- it is out of scope and still uses inline onclick

**ADM-04 (spillover from Plan 02) -- Fix --transition-normal reference in js/admin.js:**

Plan 02 fixed admin.html's CSS block but deferred the js/admin.js reference to this plan (Wave 2). Fix the inline style on line 810 in the model distribution bar HTML template:
```javascript
// In updateModelDistribution, change:
return `<div style="width: ${pct}%; background: ${m.color}; transition: width var(--transition-normal);" ...`;
// To:
return `<div style="width: ${pct}%; background: ${m.color}; transition: width var(--transition-medium);" ...`;
```
  </action>
  <verify>
    <automated>cd C:/Users/mmcge/the-commons && grep -q 'data-action="edit-moderation-note"' js/admin.js && ! grep -q "window.editModerationNote" js/admin.js && ! grep -q "transition-normal" js/admin.js && echo "ADM-04 and ADM-09 OK"</automated>
  </verify>
  <done>editModerationNote uses data-action attribute and looks up note from cached posts array. Event delegation handles clicks on posts panel. No window.editModerationNote exposed. --transition-normal reference in admin.js replaced with --transition-medium. editMarginaliaModerationNote left unchanged per locked scope.</done>
</task>

</tasks>

<verification>
- Open admin.html in browser while logged in as admin
- Posts tab: Click "Add Note" or "Edit Note" on a post -- should open prompt dialog with existing note text pre-filled
- Posts tab: Add a note with special characters (quotes, backticks, angle brackets) -- should work without breaking
- Users tab: Click "Delete Account" -- should show confirmation dialog with email address
- Marginalia tab: "Add Note" / "Edit Note" buttons should still work via existing inline onclick (unchanged)
- View source: no onclick attributes containing editModerationNote or deleteFacilitator in posts/users panels
- Console: no errors when interacting with these buttons
</verification>

<success_criteria>
- deleteFacilitator button uses data-action="delete-facilitator" data attribute
- editModerationNote button uses data-action="edit-moderation-note" data attribute
- deleteFacilitator and editModerationNote are internal (not on window)
- editMarginaliaModerationNote is NOT changed (left on window, inline onclick intact -- out of scope per CONTEXT.md)
- editModerationNote looks up note from cached posts array, not from a data attribute
- Event delegation listeners registered on users and posts panel containers
- No --transition-normal references remain in js/admin.js
</success_criteria>

<output>
After completion, create `.planning/phases/19-admin-bug-fixes/19-03-SUMMARY.md`
</output>
