---
plan: 08-01
title: "Character counters and voices last-active sort"
wave: 1
depends_on: []
files_modified:
  - js/submit.js
  - submit.html
  - js/voices.js
  - voices.html
  - css/style.css
requirements:
  - PROF-05
  - PROF-06
  - PROF-08
autonomous: true
estimated_minutes: 8
---

# Plan 08-01: Character Counters and Voices Last-Active Sort

## Objective

Add a live character counter to the submit form content textarea (PROF-05), verify the existing bio character counter in the dashboard (PROF-06), and add a "Last active" sort option with last-active labels to voice cards on the voices page (PROF-08).

## Context

- **PROF-05**: The submit form's content textarea has no character counter. The database enforces a 50,000-character limit in the `agent_create_post` stored procedure. Users need live feedback as they type.
- **PROF-06**: The dashboard bio character counter is already implemented in `dashboard.js` (lines 102-107) with a gold color indicator at 500 characters. The HTML element `bio-char-count` exists. This requirement is already satisfied -- verification only.
- **PROF-08**: The voices page has three sort modes (posts, followers, newest). The `ai_identity_stats` view now includes `last_active` (added in Phase 7). Voice cards do not show any last-active label.

## Tasks

<task id="1">
<title>Add character counter to submit form content textarea</title>
<description>
**In submit.html:**
1. Locate the content form-group (the div containing `textarea#content`)
2. Replace the existing `<p class="form-help">Submit the AI's words as they gave them...` line with a flex row that includes both the help text and the character counter:

```html
<div class="form-help" style="display: flex; justify-content: space-between; align-items: baseline;">
    <span>Submit the AI's words as they gave themâ€”don't edit for style or content.</span>
    <span id="content-char-count" style="font-variant-numeric: tabular-nums;" aria-live="polite">0 / 50,000</span>
</div>
```

This replaces the `<p class="form-help">` on line 158 of submit.html. Keep it between `<span id="content-error">` and the next form-group.

**In js/submit.js:**
3. Add the character counter logic near the top of the IIFE, after the existing element declarations (after line 14, the `draftStatus` declaration). Add:

```javascript
// Character counter for content textarea (PROF-05)
const contentTextarea = document.getElementById('content');
const contentCharCount = document.getElementById('content-char-count');
const CONTENT_MAX = 50000;

function updateContentCharCount() {
    if (!contentTextarea || !contentCharCount) return;
    const count = contentTextarea.value.length;
    contentCharCount.textContent = count.toLocaleString() + ' / ' + CONTENT_MAX.toLocaleString();
    if (count > CONTENT_MAX) {
        contentCharCount.style.color = '#f87171';
    } else if (count > CONTENT_MAX * 0.9) {
        contentCharCount.style.color = 'var(--accent-gold)';
    } else {
        contentCharCount.style.color = '';
    }
}

if (contentTextarea) {
    contentTextarea.addEventListener('input', updateContentCharCount);
}
```

This attaches a second `input` listener alongside the existing `scheduleSave` listener -- both fire independently.

**Important:** Do NOT modify the inline `<script>` block in submit.html. All JS goes into submit.js (external file) so no CSP hash regeneration is needed.
</description>
</task>

<task id="2">
<title>Verify bio character counter in dashboard (PROF-06)</title>
<description>
PROF-06 requires: "Bio fields in the dashboard identity editor show a live character count as the user types."

**Verify these exist and are correct (no code changes expected):**

1. In `js/dashboard.js`, confirm the input event listener on `identityBio` updates `bioCharCount.textContent` with the current character count and sets gold color above 500 characters (lines 102-107).
2. In `dashboard.html`, confirm the `<span id="bio-char-count">0</span> / 500 characters recommended` element exists.
3. Confirm the counter updates on each keystroke and the color changes to `var(--accent-gold)` when count exceeds 500.

**If all three checks pass:** PROF-06 is satisfied with no code changes. The existing implementation matches the requirement.

**If any check fails:** Fix the specific issue found. The expected pattern is:
```javascript
identityBio.addEventListener('input', () => {
    const count = identityBio.value.length;
    bioCharCount.textContent = count;
    bioCharCount.style.color = count > 500 ? 'var(--accent-gold)' : '';
});
```
</description>
</task>

<task id="3">
<title>Add "Last active" sort button to voices page</title>
<description>
**In voices.html:**
1. Locate the sort button group (the `<div class="voices-sort" role="tablist">` around line 72-77).
2. Add a 4th button after the "Newest" button and before the closing `</div>`:

```html
<button class="voices-sort__btn" id="sort-last-active" role="tab" aria-selected="false" tabindex="-1">Last active</button>
```

**In js/voices.js:**
3. Update the `sortBtns` array (around line 16-20) to include the new button:

```javascript
const sortBtns = [
    document.getElementById('sort-posts'),
    document.getElementById('sort-followers'),
    document.getElementById('sort-newest'),
    document.getElementById('sort-last-active')
];
```

4. Add the `last-active` case to the `sortIdentities()` function (around line 82-92). Add an `else if` branch before the default return:

```javascript
} else if (sortBy === 'last-active') {
    if (!a.last_active && !b.last_active) return 0;
    if (!a.last_active) return 1;
    if (!b.last_active) return -1;
    return new Date(b.last_active) - new Date(a.last_active);
}
```

The null handling ensures identities with no activity sort to the bottom (not the top).
</description>
</task>

<task id="4">
<title>Add last-active label to voice cards</title>
<description>
**In js/voices.js**, inside the `renderVoices()` function:

1. Locate the voice card stats div (the `<div class="voice-card__stats">` section inside the template literal).
2. After the closing `</div>` of `voice-card__stats`, add a last-active label that renders only when `identity.last_active` is truthy:

```javascript
${identity.last_active
    ? `<div class="voice-card__last-active">Active ${Utils.formatRelativeTime(identity.last_active)}</div>`
    : ''
}
```

Place this inside `voice-card__content`, after the `voice-card__stats` div.

**In css/style.css**, add a style rule for the new element (add near the existing `.voice-card__stats` rules):

```css
.voice-card__last-active {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: var(--space-xs);
}
```

**Note:** The label is omitted entirely for identities with null `last_active` (no activity). This avoids displaying "56 years ago" from `new Date(null)` and reduces visual noise for inactive identities. `Utils.formatRelativeTime()` returns computed strings like "3d ago" -- no user data, so escapeHtml is not required but harmless.
</description>
</task>

## Verification

After all tasks are complete, verify:

1. **PROF-05**: Open submit.html. Type into the content textarea. Confirm:
   - Character count updates on each keystroke, showing "N / 50,000" format
   - Count text is default muted color below 45,000 characters
   - Count text turns gold (`--accent-gold`) between 45,000 and 50,000 characters
   - Count text turns red (`#f87171`) above 50,000 characters
   - The existing draft autosave still works (both input listeners fire)

2. **PROF-06**: Open dashboard.html identity editor. Confirm:
   - Bio textarea shows character count updating on each keystroke
   - Count turns gold above 500 characters
   - No code changes were needed (or if changes were made, specify what was fixed)

3. **PROF-08**: Open voices.html. Confirm:
   - Four sort buttons visible: "Most active", "Most followed", "Newest", "Last active"
   - Clicking "Last active" sorts identities by most recently active first
   - Identities with null last_active appear at the bottom of the sort
   - Arrow key navigation works across all 4 buttons (including wrapping)
   - Voice cards with activity show "Active N ago" label below stats
   - Voice cards without activity show no last-active label (no empty space)

4. **No CSP violations**: Confirm no inline script blocks were modified. All JS changes are in external .js files.

## must_haves

- [ ] Content textarea in submit.html has a visible character counter that updates on input
- [ ] Character counter shows warning color at 90% of 50,000-char limit and error color above limit
- [ ] Dashboard bio counter confirmed working (PROF-06 verification)
- [ ] Voices page has 4 sort buttons including "Last active"
- [ ] "Last active" sort handles null values by pushing them to the bottom
- [ ] Voice cards display "Active N ago" label when last_active is non-null
- [ ] Arrow key navigation works across all 4 sort buttons
- [ ] No inline scripts modified (no CSP hash regeneration needed)
