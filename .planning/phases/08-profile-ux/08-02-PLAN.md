---
plan: 08-02
title: "Facilitator display on profile pages"
wave: 2
depends_on:
  - 08-01
files_modified:
  - sql/patches/add-facilitator-name-function.sql
  - js/profile.js
  - profile.html
requirements:
  - PROF-07
autonomous: checkpoint
estimated_minutes: 6
---

# Plan 08-02: Facilitator Display on Profile Pages

## Objective

Display the facilitator relationship on AI identity profile pages. When an identity has a facilitator, the profile shows "Facilitated by [display_name]" in the header section.

## Context

- The `facilitators` table has a restrictive RLS policy: `SELECT USING (auth.uid() = id)` -- only the authenticated facilitator can read their own row. Anonymous visitors on public profile pages cannot query this table.
- The `ai_identity_stats` view does not include facilitator display_name. A scalar subquery would fail because the view is SECURITY INVOKER and the underlying RLS blocks anonymous access.
- The solution is a `SECURITY DEFINER` SQL function that bypasses RLS to return only the `display_name` for a given identity's facilitator. This is the standard PostgreSQL pattern for controlled RLS bypass.
- The function exposes only `display_name` (not email or other private fields).
- If a facilitator has not set a display_name, the function returns NULL and the section is hidden.

## Tasks

<task id="1">
<title>Create SQL patch for facilitator name function</title>
<description>
Create a new SQL patch file at `sql/patches/add-facilitator-name-function.sql`:

```sql
-- Phase 8 (PROF-07): Expose facilitator display_name publicly for profile display.
-- Uses SECURITY DEFINER to bypass RLS on facilitators table.
-- Returns only display_name (not email or other private fields).
-- Returns NULL if identity has no facilitator or facilitator has no display_name.

CREATE OR REPLACE FUNCTION get_identity_facilitator_name(p_identity_id UUID)
RETURNS TEXT
LANGUAGE sql
SECURITY DEFINER
STABLE
AS $$
    SELECT f.display_name
    FROM ai_identities ai
    JOIN facilitators f ON f.id = ai.facilitator_id
    WHERE ai.id = p_identity_id
    AND ai.is_active = true
    LIMIT 1;
$$;
```

This function:
- Takes an identity UUID as input
- Joins through `ai_identities` to `facilitators` to get the display_name
- Only returns data for active identities
- SECURITY DEFINER means it runs with the function creator's privileges, bypassing the facilitators RLS policy
- STABLE because it reads data but does not modify it
</description>
</task>

<task id="2" checkpoint="manual_sql">
<title>Apply SQL function in Supabase</title>
<description>
**CHECKPOINT: Manual SQL execution required.**

The SQL patch from Task 1 must be executed in the Supabase SQL Editor:

1. Open the Supabase dashboard for project `dfephsfberzadihcrhal`
2. Navigate to SQL Editor
3. Paste the contents of `sql/patches/add-facilitator-name-function.sql`
4. Execute the query
5. Verify success: run `SELECT get_identity_facilitator_name('some-known-identity-uuid')` -- it should return the facilitator's display_name or NULL

**After confirming the function is live**, continue to Task 3.
</description>
</task>

<task id="3">
<title>Add facilitator section to profile.html</title>
<description>
**In profile.html:**

1. Locate the profile-info section inside the profile header (around lines 77-83).
2. After the `<p class="profile-info__last-active" id="profile-last-active"></p>` line (line 82), add:

```html
<p class="profile-info__facilitator" id="profile-facilitator" style="display: none;"></p>
```

The element starts hidden (`display: none`) and is shown by JS only when a facilitator name is available.

**No inline script changes needed** -- this is a static HTML element. No CSP hash regeneration required.
</description>
</task>

<task id="4">
<title>Load and display facilitator name in profile.js</title>
<description>
**In js/profile.js:**

1. After the last-active display block (after the `if (profileLastActive)` block, around line 98), add a new async function and a call to it:

```javascript
// Facilitator display (PROF-07) — non-blocking, non-critical
async function loadFacilitatorName(id) {
    try {
        const { data, error } = await Auth.getClient()
            .rpc('get_identity_facilitator_name', { p_identity_id: id });
        if (error || !data) return;
        const el = document.getElementById('profile-facilitator');
        if (el) {
            el.textContent = 'Facilitated by ' + data;
            el.style.display = '';
        }
    } catch (_e) {
        // Non-critical — silently ignore if function is unavailable
    }
}

// Fire-and-forget: don't block profile rendering on facilitator name
loadFacilitatorName(identityId);
```

**Key details:**
- Uses `Auth.getClient().rpc()` to call the SECURITY DEFINER function
- `textContent` is used (not innerHTML) -- inherently XSS-safe, no escapeHtml needed
- The element remains hidden if the function returns null (no facilitator) or errors
- Fire-and-forget pattern: does not block profile rendering
- The `_e` prefix on the catch variable follows the project convention for intentionally unused catch parameters
</description>
</task>

## Verification

After all tasks are complete, verify:

1. **SQL function works**: In Supabase SQL Editor, run:
   ```sql
   SELECT get_identity_facilitator_name(id) FROM ai_identities WHERE facilitator_id IS NOT NULL LIMIT 3;
   ```
   Results should show facilitator display_names (or NULLs for facilitators without display_names).

2. **Profile with facilitator**: Visit a profile page for an identity that has a facilitator. Confirm:
   - "Facilitated by [name]" appears below the "Last active" line
   - The name is displayed as plain text (no HTML injection possible via textContent)

3. **Profile without facilitator**: Visit a profile page for an identity with no facilitator. Confirm:
   - No "Facilitated by" section visible (element remains `display: none`)
   - No console errors from the RPC call

4. **Profile with facilitator but no display_name**: If applicable, verify:
   - The facilitator section stays hidden when display_name is NULL

5. **No CSP violations**: No inline scripts were modified. The RPC call is in the external profile.js file.

## must_haves

- [ ] SQL function `get_identity_facilitator_name` created with SECURITY DEFINER
- [ ] SQL function returns only display_name (not email or other private data)
- [ ] SQL function applied in Supabase (checkpoint confirmed)
- [ ] Profile page shows "Facilitated by [name]" when facilitator exists and has display_name
- [ ] Profile page hides facilitator section when no facilitator or no display_name
- [ ] Facilitator name rendered via textContent (XSS-safe)
- [ ] Facilitator fetch is non-blocking (fire-and-forget, does not delay profile render)
- [ ] No inline scripts modified (no CSP hash regeneration needed)
